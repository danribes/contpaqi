# T007.4 Field Extraction - Test Log

## Test Execution Summary
**Date**: 2025-12-07
**Tests**: 34 | **Passed**: 34 | **Failed**: 0

## Test File
`tests/test_task007_4_layoutlm_field_extraction.py`

## Test Classes

| Class | Tests | Description |
|-------|-------|-------------|
| TestExtractFieldsMethodExists | 3 | Method signature validation |
| TestExtractFieldsReturnsDict | 3 | Return type and empty cases |
| TestBIOTagGrouping | 6 | BIO state machine logic |
| TestMergeTokensMethod | 6 | Token merging functionality |
| TestExtractedFieldValues | 3 | Value extraction accuracy |
| TestFieldBoundingBoxes | 3 | Bounding box calculations |
| TestAllFieldTypes | 8 | All field type extraction |
| TestLastFieldHandling | 2 | Edge case: last field |

## Key Test Patterns

### Testing BIO Tag Transitions
```python
def test_b_followed_by_i_merges(self):
    """Test that B- followed by I- with same type merges."""
    predictions = [
        {'word': '$1,000', 'label': 'B-TOTAL', 'confidence': 0.90, 'bbox': (100, 50, 150, 70)},
        {'word': '.00', 'label': 'I-TOTAL', 'confidence': 0.88, 'bbox': (155, 50, 200, 70)},
    ]
    result = model.extract_fields(predictions)
    assert 'TOTAL' in result
    assert result['TOTAL'].value == '$1,000 .00'

def test_b_followed_by_different_i_ends_field(self):
    """Test that B- followed by I- with different type ends first field."""
    predictions = [
        {'word': 'ABC123', 'label': 'B-RFC_EMISOR', 'confidence': 0.90, 'bbox': (100, 50, 200, 70)},
        {'word': '456', 'label': 'I-RFC_RECEPTOR', 'confidence': 0.85, 'bbox': (210, 50, 260, 70)},
    ]
    result = model.extract_fields(predictions)
    assert 'RFC_EMISOR' in result
    assert result['RFC_EMISOR'].value == 'ABC123'
    assert 'RFC_RECEPTOR' not in result  # Orphan I- ignored
```

### Testing Token Merging
```python
def test_merge_tokens_creates_union_bbox(self):
    """Test that bounding box is union of all tokens."""
    tokens = [
        {'word': 'First', 'confidence': 0.90, 'bbox': (10, 20, 50, 40)},
        {'word': 'Second', 'confidence': 0.85, 'bbox': (55, 15, 120, 45)},
    ]
    result = model._merge_tokens(tokens, 'TEST')
    # Union: min(10,55), min(20,15), max(50,120), max(40,45)
    assert result.bbox == (10, 15, 120, 45)
```

### Testing Multiple Field Extraction
```python
def test_multiple_fields_extracted(self):
    """Test multiple fields are extracted correctly."""
    predictions = [
        {'word': 'ABC123456789', 'label': 'B-RFC_EMISOR', ...},
        {'word': 'FACTURA', 'label': 'O', ...},
        {'word': '01/01/2024', 'label': 'B-DATE', ...},
        {'word': 'TOTAL:', 'label': 'O', ...},
        {'word': '$1,160.00', 'label': 'B-TOTAL', ...},
    ]
    result = model.extract_fields(predictions)
    assert len(result) == 3
    assert 'RFC_EMISOR' in result
    assert 'DATE' in result
    assert 'TOTAL' in result
```

## Floating Point Precision Fix
One test required `pytest.approx()` for floating point comparison:
```python
# Before (failed due to 0.8500000000000001 != 0.85)
assert result.confidence == 0.85

# After (passes)
assert result.confidence == pytest.approx(0.85, rel=0.01)
```

## Execution Output
```
tests/test_task007_4_layoutlm_field_extraction.py ................................ [100%]
============================== 34 passed in 0.13s ==============================
```

## Combined Task 7 Tests
```
tests/test_task007_*.py - 118 passed (43 + 23 + 18 + 34)
```
