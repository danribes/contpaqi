# T003.2 - TATR Data Preparation - Test Log

**Subtask**: 3.2 - Implement TATR data preparation (COCO format, normalized boxes)
**Date**: 2025-12-04
**Test Framework**: pytest 9.0.1
**Status**: All Tests Passing (37/37)

---

## Test Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Module Functions Exist | 4 | 4 | 0 |
| Normalize BBox | 4 | 4 | 0 |
| Create COCO Dataset | 7 | 7 | 0 |
| Add Image to COCO | 3 | 3 | 0 |
| Add Annotation to COCO | 4 | 4 | 0 |
| Extract Table BBox | 3 | 3 | 0 |
| Extract Row BBoxes | 3 | 3 | 0 |
| PDF to Image | 2 | 2 | 0 |
| Integration Tests | 7 | 7 | 0 |
| **Total** | **37** | **37** | **0** |

---

## Test File

**Location**: `tests/test_task003_2_tatr_format.py`

---

## Test Classes

### TestCocoFormatModule (4 tests)
```
test_has_create_coco_dataset_function     PASSED
test_has_normalize_bbox_function          PASSED
test_has_pdf_to_image_function            PASSED
test_has_extract_table_bbox_function      PASSED
```

### TestNormalizeBbox (4 tests)
```
test_normalizes_to_1000_scale   PASSED
test_handles_full_page_bbox     PASSED
test_returns_integers           PASSED
test_handles_zero_values        PASSED
```

### TestCreateCocoDataset (7 tests)
```
test_returns_dict                       PASSED
test_has_images_key                     PASSED
test_has_annotations_key                PASSED
test_has_categories_key                 PASSED
test_categories_include_table           PASSED
test_categories_include_table_row       PASSED
test_categories_have_required_fields    PASSED
```

### TestAddImageToCocoDataset (3 tests)
```
test_has_add_image_function    PASSED
test_adds_image_entry          PASSED
test_image_has_dimensions      PASSED
```

### TestAddAnnotationToCocoDataset (4 tests)
```
test_has_add_annotation_function    PASSED
test_adds_annotation_entry          PASSED
test_annotation_has_bbox            PASSED
test_annotation_has_area            PASSED
```

### TestExtractTableBbox (3 tests)
```
test_extracts_from_line_items       PASSED
test_returns_none_for_no_line_items PASSED
test_handles_missing_bboxes         PASSED
```

### TestExtractRowBboxes (3 tests)
```
test_has_extract_row_bboxes_function    PASSED
test_returns_list_of_bboxes             PASSED
test_each_row_bbox_has_four_values      PASSED
```

### TestPdfToImage (2 tests)
```
test_returns_pil_image    PASSED
test_returns_rgb_image    PASSED
```

### TestFormatTatrIntegration (7 tests)
```
test_creates_output_directory       PASSED
test_returns_statistics             PASSED
test_processes_pdf_and_json_pairs   PASSED
test_creates_annotations_json       PASSED
test_annotations_json_is_valid      PASSED
test_creates_images_directory       PASSED
test_saves_png_images               PASSED
```

---

## Test Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/user/contpaqi
plugins: Faker-38.2.0
collected 37 items

tests/test_task003_2_tatr_format.py ................................. [100%]

============================= 37 passed in 10.30s ==============================
```

---

## Key Test Validations

### Normalize BBox
```python
def test_normalizes_to_1000_scale(self):
    bbox = [100, 200, 50, 30]  # x, y, width, height
    result = normalize_bbox(bbox, 1000, 800)
    assert result[0] == 100
    assert result[1] == 250
    assert result[2] == 50
```

### COCO Categories
```python
def test_categories_include_table(self):
    result = create_coco_dataset()
    category_names = [c['name'] for c in result['categories']]
    assert 'table' in category_names

def test_categories_include_table_row(self):
    result = create_coco_dataset()
    category_names = [c['name'] for c in result['categories']]
    assert 'table_row' in category_names
```

### Extract Table BBox
```python
def test_extracts_from_line_items(self):
    ground_truth = {
        'line_items': [
            {'bbox': {'x': 50, 'y': 100, 'width': 400, 'height': 20}},
            {'bbox': {'x': 50, 'y': 130, 'width': 400, 'height': 20}},
        ]
    }
    result = extract_table_bbox(ground_truth)
    assert result is not None
    assert len(result) == 4
```

### Integration Tests
```python
def test_annotations_json_is_valid(self):
    format_tatr(input_dir, output_dir)
    with open(annotations_path, 'r') as f:
        data = json.load(f)
    assert 'images' in data
    assert 'annotations' in data
    assert 'categories' in data
```

---

## Full Test Suite Summary

**Total Tests for Project**: 600 tests

| Task | Tests |
|------|-------|
| Task 1 (Project Setup) | 27 |
| Task 2 (Invoice Generator) | 505 |
| Task 3.1 (Prepare Datasets) | 31 |
| Task 3.2 (TATR Format) | 37 |
| **Total** | **600** |
