# T003.1 - Prepare Datasets Script - Test Log

**Subtask**: 3.1 - Create prepare_datasets.py script
**Date**: 2025-12-04
**Test Framework**: pytest 9.0.1
**Status**: All Tests Passing (31/31)

---

## Test Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Module Exists | 5 | 5 | 0 |
| Argument Parser | 11 | 11 | 0 |
| Format Validation | 1 | 1 | 0 |
| Directory Handling | 2 | 2 | 0 |
| Format Functions | 2 | 2 | 0 |
| Main Function | 4 | 4 | 0 |
| Input Validation | 4 | 4 | 0 |
| Seed Option | 2 | 2 | 0 |
| **Total** | **31** | **31** | **0** |

---

## Test File

**Location**: `tests/test_task003_1_prepare_datasets.py`

---

## Test Classes

### TestPrepareDataetsModuleExists (5 tests)
```
test_can_import_module                         PASSED
test_has_main_function                         PASSED
test_has_create_argument_parser_function       PASSED
test_has_format_tatr_function                  PASSED
test_has_format_layoutlm_function              PASSED
```

### TestArgumentParser (11 tests)
```
test_parser_returns_argparse_namespace    PASSED
test_has_input_dir_argument               PASSED
test_has_output_dir_argument              PASSED
test_has_format_argument                  PASSED
test_format_accepts_tatr                  PASSED
test_format_accepts_layoutlm              PASSED
test_format_accepts_both                  PASSED
test_format_default_is_both               PASSED
test_input_dir_has_default                PASSED
test_output_dir_has_default               PASSED
test_short_options_work                   PASSED
```

### TestFormatValidation (1 test)
```
test_invalid_format_raises_error          PASSED
```

### TestDirectoryHandling (2 tests)
```
test_creates_output_directory             PASSED
test_handles_existing_output_directory    PASSED
```

### TestFormatFunctions (2 tests)
```
test_format_tatr_returns_dict             PASSED
test_format_layoutlm_returns_dict         PASSED
```

### TestMainFunction (4 tests)
```
test_main_returns_exit_code                  PASSED
test_main_calls_tatr_for_tatr_format         PASSED
test_main_calls_layoutlm_for_layoutlm_format PASSED
test_main_calls_both_for_both_format         PASSED
```

### TestInputValidation (4 tests)
```
test_validates_input_directory_exists      PASSED
test_returns_false_for_missing_input_dir   PASSED
test_checks_for_pdfs_subdirectory          PASSED
test_checks_for_labels_subdirectory        PASSED
```

### TestSeedOption (2 tests)
```
test_has_seed_argument     PASSED
test_seed_default_is_42    PASSED
```

---

## Test Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/user/contpaqi
plugins: Faker-38.2.0
collected 31 items

tests/test_task003_1_prepare_datasets.py ................................. [100%]

============================== 31 passed in 0.37s ==============================
```

---

## Key Test Validations

### Argument Parser Tests
```python
def test_format_accepts_both(self):
    parser = create_argument_parser()
    args = parser.parse_args(['--format', 'both'])
    assert args.format == 'both'

def test_short_options_work(self):
    parser = create_argument_parser()
    args = parser.parse_args(['-i', '/in', '-o', '/out', '-f', 'tatr'])
    assert args.input_dir == '/in'
    assert args.output_dir == '/out'
    assert args.format == 'tatr'
```

### Format Validation Tests
```python
def test_invalid_format_raises_error(self):
    parser = create_argument_parser()
    with pytest.raises(SystemExit):
        parser.parse_args(['--format', 'invalid_format'])
```

### Main Function Tests (with mocking)
```python
def test_main_calls_both_for_both_format(self):
    with patch('sys.argv', ['prepare_datasets.py', '-f', 'both']):
        with patch('prepare_datasets.format_tatr') as mock_tatr:
            with patch('prepare_datasets.format_layoutlm') as mock_layoutlm:
                mock_tatr.return_value = {'status': 'ok', ...}
                mock_layoutlm.return_value = {'status': 'ok', ...}
                main()
                mock_tatr.assert_called_once()
                mock_layoutlm.assert_called_once()
```

### Directory Handling Tests
```python
def test_creates_output_directory(self):
    with tempfile.TemporaryDirectory() as tmpdir:
        output_dir = os.path.join(tmpdir, 'new_output', 'nested')
        prepare_output_dir(output_dir)
        assert os.path.isdir(output_dir)
```

---

## Coverage Summary

- [x] Module imports correctly
- [x] All required functions exist
- [x] Parser accepts all expected arguments
- [x] Format choices are validated
- [x] Invalid formats raise errors
- [x] Output directories are created
- [x] Format functions return statistics dicts
- [x] Main function routes to correct formatters
- [x] Input directory validation works
- [x] Seed option is configurable
- [x] Short option flags work (-i, -o, -f, -s)

---

## Full Test Suite Summary

**Total Tests for Project**: 563 tests

| Task | Tests |
|------|-------|
| Task 1 (Project Setup) | 27 |
| Task 2 (Invoice Generator) | 505 |
| Task 3.1 (Prepare Datasets) | 31 |
| **Total** | **563** |
