# T003.4 - Dataset Splits - Test Log

**Subtask**: 3.4 - Create train/validation/test splits (80/10/10)
**Date**: 2025-12-04
**Test Framework**: pytest 9.0.1
**Status**: All Tests Passing (23/23)

---

## Test Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Module Functions Exist | 3 | 3 | 0 |
| create_splits() | 9 | 9 | 0 |
| split_dataset() | 2 | 2 | 0 |
| TATR Splitting | 2 | 2 | 0 |
| LayoutLM Splitting | 2 | 2 | 0 |
| copy_split_files() | 2 | 2 | 0 |
| CLI Integration | 3 | 3 | 0 |
| **Total** | **23** | **23** | **0** |

---

## Test File

**Location**: `tests/test_task003_4_dataset_splits.py`

---

## Test Classes

### TestSplitModuleExists (3 tests)
```
test_has_create_splits_function        PASSED
test_has_split_dataset_function        PASSED
test_has_copy_split_files_function     PASSED
```

### TestCreateSplits (9 tests)
```
test_returns_dict_with_train_val_test            PASSED
test_default_ratio_is_80_10_10                   PASSED
test_custom_ratio                                PASSED
test_splits_are_disjoint                         PASSED
test_splits_cover_all_indices                    PASSED
test_reproducible_with_seed                      PASSED
test_different_seeds_produce_different_splits    PASSED
test_handles_small_dataset                       PASSED
test_handles_empty_dataset                       PASSED
```

### TestSplitDataset (2 tests)
```
test_creates_split_directories    PASSED
test_returns_statistics           PASSED
```

### TestSplitDatasetTATR (2 tests)
```
test_splits_coco_annotations    PASSED
test_copies_images_to_splits    PASSED
```

### TestSplitDatasetLayoutLM (2 tests)
```
test_splits_samples_json          PASSED
test_copies_labels_to_all_splits  PASSED
```

### TestCopyFilesFunction (2 tests)
```
test_copies_files_by_index              PASSED
test_handles_missing_files_gracefully   PASSED
```

### TestIntegrationWithMainCLI (3 tests)
```
test_main_cli_has_split_option          PASSED
test_main_cli_split_default_false       PASSED
test_main_cli_accepts_split_ratios      PASSED
```

---

## Test Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/user/contpaqi
plugins: Faker-38.2.0
collected 23 items

tests/test_task003_4_dataset_splits.py ....................... [100%]

============================== 23 passed in 0.48s ==============================
```

---

## Key Test Validations

### Disjoint Splits
```python
def test_splits_are_disjoint(self):
    from prepare_datasets import create_splits

    indices = list(range(100))
    splits = create_splits(indices)

    train_set = set(splits['train'])
    val_set = set(splits['val'])
    test_set = set(splits['test'])

    assert len(train_set & val_set) == 0
    assert len(train_set & test_set) == 0
    assert len(val_set & test_set) == 0
```

### Reproducibility
```python
def test_reproducible_with_seed(self):
    from prepare_datasets import create_splits

    indices = list(range(100))
    splits1 = create_splits(indices, seed=42)
    splits2 = create_splits(indices, seed=42)

    assert splits1['train'] == splits2['train']
    assert splits1['val'] == splits2['val']
    assert splits1['test'] == splits2['test']
```

### COCO Annotation Splitting
```python
def test_splits_coco_annotations(self):
    from prepare_datasets import split_dataset

    # Create TATR input with 20 images
    coco_data = {
        'images': [{'id': i, 'file_name': f'img_{i:05d}.png', ...} for i in range(20)],
        'annotations': [{'id': i, 'image_id': i, ...} for i in range(20)],
        'categories': [{'id': 1, 'name': 'table'}]
    }

    split_dataset(input_dir, output_dir, 'tatr', seed=42)

    with open(train_ann_path, 'r') as f:
        train_data = json.load(f)

    assert len(train_data['images']) == 16  # 80% of 20
```

### LayoutLM Splitting
```python
def test_splits_samples_json(self):
    from prepare_datasets import split_dataset

    samples = [{'tokens': ['test'], ...} for i in range(20)]

    split_dataset(input_dir, output_dir, 'layoutlm', seed=42)

    with open(train_samples_path, 'r') as f:
        train_samples = json.load(f)

    assert len(train_samples) == 16  # 80% of 20
```

---

## Full Test Suite Summary

**Total Tests for Project**: 661 tests

| Task | Tests |
|------|-------|
| Task 1 (Project Setup) | 27 |
| Task 2 (Invoice Generator) | 505 |
| Task 3.1 (Prepare Datasets) | 31 |
| Task 3.2 (TATR Format) | 37 |
| Task 3.3 (LayoutLM Format) | 38 |
| Task 3.4 (Dataset Splits) | 23 |
| **Total** | **661** |
