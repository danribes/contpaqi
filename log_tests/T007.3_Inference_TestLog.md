# T007.3 Token Classification Inference - Test Log

## Test Execution Summary
**Date**: 2025-12-07
**Tests**: 18 | **Passed**: 18 | **Failed**: 0

## Test File
`tests/test_task007_3_layoutlm_inference.py`

## Test Classes

| Class | Tests | Description |
|-------|-------|-------------|
| TestPredictMethodBasic | 2 | Returns list, handles missing deps |
| TestPredictMethodSignature | 3 | Method signature validation |
| TestBoxNormalization | 1 | Box scaling to 0-1000 |
| TestPredictWithMocks | 2 | Processor and torch.no_grad |
| TestPredictResultStructure | 4 | Result dict structure |
| TestWordIdMapping | 2 | Subword tokenization handling |
| TestProcessorParameters | 1 | Processor call arguments |
| TestConfidenceScores | 1 | Softmax confidence |
| TestLabelMapping | 1 | id2label conversion |
| TestEmptyInputHandling | 1 | Edge case: empty words |

## Key Test Patterns

### Mock Encoding with word_ids()
```python
def create_mock_encoding(word_ids_list):
    """Helper to create a mock encoding with word_ids method."""
    mock_encoding = MagicMock()
    mock_encoding.word_ids.return_value = word_ids_list
    mock_encoding.items.return_value = [
        ('input_ids', Mock(to=Mock(return_value=Mock()))),
        ('attention_mask', Mock(to=Mock(return_value=Mock()))),
        ('bbox', Mock(to=Mock(return_value=Mock()))),
    ]
    return mock_encoding
```

### Mock Model Output
```python
mock_outputs = Mock()
mock_outputs.logits = torch.tensor([[[0.1] * 21] * 512])
```

### Testing Box Normalization
```python
def test_boxes_normalized_to_1000_scale(self):
    model = LayoutLMModel(load_model=False)
    mock_image = Mock()
    mock_image.size = (800, 600)  # width, height

    words = ["Test"]
    boxes = [(400, 300, 500, 400)]  # Middle of image

    # Expected: (500, 500, 625, 666) after normalization
    # 400 * 1000 / 800 = 500
    # 300 * 1000 / 600 = 500
```

### Testing Word ID Handling
```python
def test_predict_handles_word_ids_none(self):
    # word_ids with None (special tokens)
    word_ids = [None, 0, 1, None]  # CLS, word0, word1, SEP

def test_predict_handles_duplicate_word_ids(self):
    # word_ids with duplicates (subword tokens)
    word_ids = [None, 0, 0, 1, 2, 2, 2, None]  # word0 split, word2 split to 3
```

## Execution Output
```
tests/test_task007_3_layoutlm_inference.py .................. [100%]
============================== 18 passed in 0.17s ==============================
```

## Bug Fixed During Development
The predict() method initially called `encoding.word_ids()` after converting encoding to dict:
```python
# Bug: encoding is now a dict, no word_ids() method
encoding = {k: v.to(self.device) for k, v in encoding.items()}
word_ids = encoding.word_ids()  # AttributeError!
```

Fixed by getting word_ids before conversion:
```python
word_ids = encoding.word_ids()  # Get before conversion
encoding = {k: v.to(self.device) for k, v in encoding.items()}
```
