# T003.3 - LayoutLMv3 Data Preparation - Test Log

**Subtask**: 3.3 - Implement LayoutLMv3 data preparation (BIO tags, tokens)
**Date**: 2025-12-04
**Test Framework**: pytest 9.0.1
**Status**: All Tests Passing (38/38)

---

## Test Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Module Functions Exist | 4 | 4 | 0 |
| Label List | 8 | 8 | 0 |
| Match Token To Field | 4 | 4 | 0 |
| Create BIO Tags | 3 | 3 | 0 |
| Get OCR Tokens | 4 | 4 | 0 |
| Create LayoutLM Sample | 6 | 6 | 0 |
| Integration Tests | 6 | 6 | 0 |
| Normalize BBox | 3 | 3 | 0 |
| **Total** | **38** | **38** | **0** |

---

## Test File

**Location**: `tests/test_task003_3_layoutlm_format.py`

---

## Test Classes

### TestLayoutLMModuleExists (4 tests)
```
test_has_get_ocr_tokens_function           PASSED
test_has_match_token_to_field_function     PASSED
test_has_create_bio_tags_function          PASSED
test_has_get_label_list_function           PASSED
```

### TestLabelList (8 tests)
```
test_returns_list                PASSED
test_includes_outside_label      PASSED
test_includes_rfc_emisor_labels  PASSED
test_includes_rfc_receptor_labels PASSED
test_includes_total_labels       PASSED
test_includes_date_labels        PASSED
test_includes_subtotal_labels    PASSED
test_includes_iva_labels         PASSED
```

### TestMatchTokenToField (4 tests)
```
test_matches_exact_text          PASSED
test_matches_numeric_value       PASSED
test_returns_none_for_no_match   PASSED
test_matches_date_field          PASSED
```

### TestCreateBioTags (3 tests)
```
test_returns_list_of_tags             PASSED
test_tags_outside_tokens_as_O         PASSED
test_tags_matching_token_with_b_prefix PASSED
```

### TestGetOcrTokens (4 tests)
```
test_returns_list               PASSED
test_token_has_text_field       PASSED
test_token_has_bbox_field       PASSED
test_bbox_format_is_x1_y1_x2_y2 PASSED
```

### TestCreateLayoutLMSample (6 tests)
```
test_has_create_layoutlm_sample_function PASSED
test_sample_has_tokens_key               PASSED
test_sample_has_bboxes_key               PASSED
test_sample_has_ner_tags_key             PASSED
test_sample_has_image_path_key           PASSED
test_ner_tags_are_integers               PASSED
```

### TestFormatLayoutLMIntegration (6 tests)
```
test_creates_output_directory    PASSED
test_returns_statistics          PASSED
test_creates_samples_json        PASSED
test_samples_json_is_valid       PASSED
test_creates_labels_json         PASSED
test_creates_images_directory    PASSED
```

### TestNormalizeBboxForLayoutLM (3 tests)
```
test_has_normalize_bbox_layoutlm_function PASSED
test_normalizes_to_1000_scale             PASSED
test_handles_different_image_sizes        PASSED
```

---

## Test Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/user/contpaqi
plugins: Faker-38.2.0
collected 38 items

tests/test_task003_3_layoutlm_format.py ..................................... [100%]

============================= 38 passed in 19.46s ==============================
```

---

## Key Test Validations

### Label List
```python
def test_includes_rfc_emisor_labels(self):
    from prepare_datasets import get_label_list
    labels = get_label_list()
    assert 'B-RFC_EMISOR' in labels
    assert 'I-RFC_EMISOR' in labels
```

### Match Token To Field
```python
def test_matches_exact_text(self):
    from prepare_datasets import match_token_to_field
    ground_truth = {
        'fields': {
            'rfc_emisor': 'XAXX010101ABC',
            'total': 1160.00
        }
    }
    result = match_token_to_field('XAXX010101ABC', ground_truth)
    assert result == 'RFC_EMISOR'
```

### Create BIO Tags
```python
def test_tags_matching_token_with_b_prefix(self):
    from prepare_datasets import create_bio_tags
    tokens = [
        {'text': 'XAXX010101ABC', 'bbox': [10, 10, 150, 30]},
    ]
    ground_truth = {
        'fields': {
            'rfc_emisor': 'XAXX010101ABC'
        }
    }
    result = create_bio_tags(tokens, ground_truth)
    assert result[0] == 'B-RFC_EMISOR'
```

### Normalize BBox
```python
def test_handles_different_image_sizes(self):
    from prepare_datasets import normalize_bbox_layoutlm
    bbox = [50, 100, 150, 200]  # x1, y1, x2, y2 on 500x400 image
    result = normalize_bbox_layoutlm(bbox, 500, 400)
    assert result[0] == 100   # 50/500*1000
    assert result[1] == 250   # 100/400*1000
    assert result[2] == 300   # 150/500*1000
    assert result[3] == 500   # 200/400*1000
```

### Integration Tests
```python
def test_samples_json_is_valid(self):
    from prepare_datasets import format_layoutlm
    format_layoutlm(input_dir, output_dir)
    with open(samples_path, 'r') as f:
        data = json.load(f)
    assert isinstance(data, list)
```

---

## Full Test Suite Summary

**Total Tests for Project**: 638 tests

| Task | Tests |
|------|-------|
| Task 1 (Project Setup) | 27 |
| Task 2 (Invoice Generator) | 505 |
| Task 3.1 (Prepare Datasets) | 31 |
| Task 3.2 (TATR Format) | 37 |
| Task 3.3 (LayoutLM Format) | 38 |
| **Total** | **638** |
