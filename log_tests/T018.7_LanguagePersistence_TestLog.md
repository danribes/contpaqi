# T018.7 - Language Persistence Test Log

**Subtask**: 18.7 - Persist language preference across sessions
**Date**: 2025-12-12
**Test File**: `desktop-app/tests/language-manager.test.ts`

---

## Test Results Summary

```
Test Suites: 1 passed, 1 total
Tests:       71 passed, 71 total
Time:        2.256s
```

---

## Test Categories

### Language Manager Helper Functions (14 tests)

#### isSupportedLanguage (4 tests)
| Test | Status | Description |
|------|--------|-------------|
| should return true for "en" | PASS | Valid English code |
| should return true for "es" | PASS | Valid Spanish code |
| should return false for unsupported languages | PASS | fr, de, empty |
| should return false for null or undefined | PASS | Handles null safely |

#### normalizeLanguageCode (8 tests)
| Test | Status | Description |
|------|--------|-------------|
| should return "en" for "en-US" | PASS | US English locale |
| should return "en" for "en-GB" | PASS | UK English locale |
| should return "es" for "es-MX" | PASS | Mexican Spanish locale |
| should return "es" for "es-ES" | PASS | Spain Spanish locale |
| should return "es" for "es" | PASS | Simple Spanish code |
| should return "en" for unsupported locales | PASS | fr, de, zh fallback |
| should handle underscore separators | PASS | en_US, es_MX format |
| should return default for empty string | PASS | Empty string fallback |

#### getRegistryPath (2 tests)
| Test | Status |
|------|--------|
| should return correct registry key path | PASS |
| should return correct registry value name | PASS |

---

### Registry Operations (5 tests)

#### Mock Registry Read/Write
| Test | Status | Description |
|------|--------|-------------|
| should return error when key does not exist | PASS | Key not found error |
| should return error when value does not exist | PASS | Value not found error |
| should return value when it exists | PASS | Successful read |
| should write value successfully | PASS | Successful write |
| should overwrite existing value | PASS | Update existing value |

---

### Language Preference Resolution (7 tests)

| Test | Status | Description |
|------|--------|-------------|
| should prioritize localStorage over registry | PASS | Priority 1: localStorage |
| should use registry when localStorage is not set | PASS | Priority 2: Registry |
| should use system locale when registry is not set | PASS | Priority 3: System locale |
| should use default when nothing is set | PASS | Priority 4: Default (en) |
| should skip invalid localStorage value | PASS | Validates localStorage |
| should skip invalid registry value | PASS | Validates registry |
| should normalize unsupported system locale to English | PASS | Unsupported locale fallback |

---

### IPC Handler Patterns (7 tests)

#### Language IPC Channel Names (5 tests)
| Test | Status |
|------|--------|
| should have correct channel for getting registry language | PASS |
| should have correct channel for setting registry language | PASS |
| should have correct channel for getting system locale | PASS |
| should have correct channel for getting preference | PASS |
| should have correct channel for setting preference | PASS |

#### IPC Handler Responses (2 tests)
| Test | Status |
|------|--------|
| should create success response with data | PASS |
| should create error response | PASS |

---

### System Locale Detection (8 tests)

#### parseSystemLocale (5 tests)
| Test | Status |
|------|--------|
| should parse "en-US" correctly | PASS |
| should parse "es-MX" correctly | PASS |
| should parse underscore format "en_GB" | PASS |
| should handle language-only locale | PASS |
| should handle empty string | PASS |

#### getSystemLanguage (3 tests)
| Test | Status |
|------|--------|
| should return "en" for English locales | PASS |
| should return "es" for Spanish locales | PASS |
| should default to "en" for other locales | PASS |

---

### Electron API Pattern (6 tests)

#### electronAPI.language interface (3 tests)
| Test | Status |
|------|--------|
| should define getRegistryLanguage method | PASS |
| should define setRegistryLanguage method | PASS |
| should define getSystemLocale method | PASS |

#### Language API Return Types (3 tests)
| Test | Status |
|------|--------|
| getRegistryLanguage should return string or null | PASS |
| setRegistryLanguage should return success object | PASS |
| setRegistryLanguage should return error on failure | PASS |

---

### Language Change Flow (6 tests)

#### setLanguagePreference (4 tests)
| Test | Status |
|------|--------|
| should save to localStorage | PASS |
| should save to registry when requested | PASS |
| should not save to registry when not requested | PASS |
| should return success on completion | PASS |

#### Language Change Event (2 tests)
| Test | Status |
|------|--------|
| should create event with all properties | PASS |
| should have valid ISO timestamp | PASS |

---

### Registry Key Structure (3 tests)

#### ContPAQi Registry Keys
| Test | Status |
|------|--------|
| should have correct base key | PASS |
| should have correct app key under base | PASS |
| should store language as "Language" value | PASS |

---

### Error Handling (7 tests)

#### Registry Error Codes (3 tests)
| Test | Status |
|------|--------|
| should create KEY_NOT_FOUND error | PASS |
| should create ACCESS_DENIED error | PASS |
| should include details in message | PASS |

#### Graceful Fallback (4 tests)
| Test | Status |
|------|--------|
| should use registry when available | PASS |
| should fallback to localStorage when registry fails | PASS |
| should use default when both fail | PASS |
| should ignore invalid registry value | PASS |

---

### Integration Patterns (3 tests)

#### i18n Integration (2 tests)
| Test | Status |
|------|--------|
| should have matching language codes with i18n | PASS |
| should have matching localStorage key | PASS |

#### Installer Integration (1 test)
| Test | Status |
|------|--------|
| should use same registry path as installer | PASS |

---

### Platform Detection (5 tests)

#### isWindows (2 tests)
| Test | Status |
|------|--------|
| should return true for win32 | PASS |
| should return false for other platforms | PASS |

#### Registry Availability (3 tests)
| Test | Status |
|------|--------|
| should be available on Windows | PASS |
| should not be available on macOS | PASS |
| should not be available on Linux | PASS |

---

## Test Execution Command

```bash
cd desktop-app
npm test -- --testPathPattern="language-manager" --no-coverage
```

---

## Coverage Summary

The test file validates:
- Language code validation and normalization
- Windows Registry read/write operations
- Language preference priority resolution
- IPC handler patterns and channel names
- System locale parsing and detection
- Electron API interface design
- Language change flow with persistence
- Registry key structure
- Error handling and graceful fallback
- Integration with i18n and installer
- Platform-specific behavior
