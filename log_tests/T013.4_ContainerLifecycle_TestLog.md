# T013.4 Container Lifecycle Management - Test Log

## Test Execution Summary
**Date**: 2025-12-07
**Tests**: 30 | **Status**: Written (pending npm install)

## Test File
`desktop-app/tests/docker-lifecycle.test.ts`

## Test Categories

### startContainer (7 tests)
| Test | Description |
|------|-------------|
| should start container with docker-compose up -d | Basic start command |
| should return error when docker-compose up fails | Error handling |
| should handle spawn error | ENOENT handling |
| should timeout after configured duration | Timeout protection |
| should capture stdout messages | Message capture |
| should build images if --build flag is passed | Build option |
| should force recreate if --force-recreate flag is passed | Recreate option |

### stopContainer (5 tests)
| Test | Description |
|------|-------------|
| should stop container with docker-compose down | Basic stop command |
| should return error when docker-compose down fails | Error handling |
| should handle spawn error | ENOENT handling |
| should remove volumes if --volumes flag is passed | Volume removal |
| should remove orphans if flag is passed | Orphan cleanup |

### restartContainer (3 tests)
| Test | Description |
|------|-------------|
| should restart by stopping then starting | Sequential operations |
| should fail if stop fails | Stop failure propagation |
| should fail if start fails after successful stop | Start failure after stop |

### pullImages (2 tests)
| Test | Description |
|------|-------------|
| should pull images with docker-compose pull | Pull command |
| should return error when pull fails | Error handling |

### buildImages (2 tests)
| Test | Description |
|------|-------------|
| should build images with docker-compose build | Build command |
| should use --no-cache flag when specified | No cache option |

### ContainerLifecycleResult (1 test)
| Test | Description |
|------|-------------|
| should have success and optional fields | Type structure |

### Edge Cases (6 tests)
| Test | Description |
|------|-------------|
| should handle empty stderr on failure | Default error message |
| should handle mixed stdout and stderr | Output merging |
| should use docker compose (v2) command when available | v2 syntax |
| should handle concurrent lifecycle operations | Parallel ops |
| should pass environment variables to docker-compose | Env var passing |

## Mocking Strategy

### child_process Mock
```typescript
const mockSpawn = jest.fn();
jest.mock('child_process', () => ({
  spawn: mockSpawn,
}));
```

### Mock Process Factory
```typescript
function createMockProcess(options: {
  closeCode: number;
  stdout?: string;
  stderr?: string;
  delay?: number;
}) {
  const mockProcess = {
    stdout: { on: jest.fn() },
    stderr: { on: jest.fn() },
    on: jest.fn((event, callback) => {
      if (event === 'close') {
        setTimeout(() => callback(closeCode), delay);
      }
    }),
  };
  return mockProcess;
}
```

## Test Patterns

### Testing Start Command
```typescript
it('should start container with docker-compose up -d', async () => {
  const mockProcess = createMockProcess({ closeCode: 0 });
  mockSpawn.mockReturnValue(mockProcess);

  const result = await dockerManager.startContainer();

  expect(result.success).toBe(true);
  expect(mockSpawn).toHaveBeenCalledWith(
    'docker-compose',
    ['up', '-d'],
    expect.objectContaining({
      cwd: composePath,
      shell: true,
    })
  );
});
```

### Testing Options
```typescript
it('should build images if --build flag is passed', async () => {
  const mockProcess = createMockProcess({ closeCode: 0 });
  mockSpawn.mockReturnValue(mockProcess);

  await dockerManager.startContainer({ build: true });

  expect(mockSpawn).toHaveBeenCalledWith(
    'docker-compose',
    ['up', '-d', '--build'],
    expect.any(Object)
  );
});
```

### Testing Restart Sequence
```typescript
it('should restart by stopping then starting', async () => {
  const mockProcess = createMockProcess({ closeCode: 0 });
  mockSpawn.mockReturnValue(mockProcess);

  const result = await dockerManager.restartContainer();

  expect(result.success).toBe(true);
  // Should call docker-compose down, then docker-compose up -d
  expect(mockSpawn).toHaveBeenCalledTimes(2);
});
```

### Testing v2 Compose
```typescript
it('should use docker compose (v2) command when available', async () => {
  const dockerManager = new DockerManager('mcp-container', 10000, '/path', true);
  const mockProcess = createMockProcess({ closeCode: 0 });
  mockSpawn.mockReturnValue(mockProcess);

  await dockerManager.startContainer();

  expect(mockSpawn).toHaveBeenCalledWith(
    'docker',
    ['compose', 'up', '-d'],
    expect.any(Object)
  );
});
```

## Notes
- Tests mock all child_process.spawn calls
- Factory functions create consistent mock processes
- Timeout tests use Jest's extended timeout (15000ms)
- Tests verify command arguments and working directory
- Environment variable passing is tested
