# T002.7 - Ground Truth Generator - Test Log

**Subtask**: 2.7 - Create JSON sidecar file generator for ground truth labels
**Date**: 2025-12-03
**Test Framework**: pytest 9.0.1
**Status**: All Tests Passing (33/33)

---

## Test Summary

| Category | Tests | Passed | Failed |
|----------|-------|--------|--------|
| Module Exists | 4 | 4 | 0 |
| Create Ground Truth | 4 | 4 | 0 |
| Fields Structure | 9 | 9 | 0 |
| Line Items Structure | 7 | 7 | 0 |
| Save Ground Truth | 4 | 4 | 0 |
| Load Ground Truth | 2 | 2 | 0 |
| Null BBox Handling | 1 | 1 | 0 |
| Metadata Section | 2 | 2 | 0 |
| **Total** | **33** | **33** | **0** |

---

## Test File

**Location**: `tests/test_task002_7_ground_truth.py`

---

## Test Classes

### TestGroundTruthModuleExists (4 tests)
```
test_can_import_module                    PASSED
test_has_save_ground_truth_function       PASSED
test_has_create_ground_truth_function     PASSED
test_has_load_ground_truth_function       PASSED
```

### TestCreateGroundTruth (4 tests)
```
test_returns_dictionary                   PASSED
test_has_fields_section                   PASSED
test_has_line_items_section               PASSED
test_has_metadata_section                 PASSED
```

### TestFieldsStructure (9 tests)
```
test_has_rfc_emisor                       PASSED
test_has_rfc_receptor                     PASSED
test_has_date                             PASSED
test_has_subtotal                         PASSED
test_has_iva                              PASSED
test_has_total                            PASSED
test_field_has_value_and_bbox             PASSED
test_rfc_emisor_value_correct             PASSED
test_total_value_correct                  PASSED
```

### TestLineItemsStructure (7 tests)
```
test_line_items_count_matches             PASSED
test_line_item_has_description            PASSED
test_line_item_has_quantity               PASSED
test_line_item_has_unit_price             PASSED
test_line_item_has_amount                 PASSED
test_line_item_has_bbox                   PASSED
test_first_item_values_correct            PASSED
```

### TestSaveGroundTruth (4 tests)
```
test_creates_json_file                    PASSED
test_file_is_valid_json                   PASSED
test_file_content_has_fields              PASSED
test_creates_parent_directories           PASSED
```

### TestLoadGroundTruth (2 tests)
```
test_loads_saved_file                     PASSED
test_raises_on_missing_file               PASSED
```

### TestHandleNullBBoxes (1 test)
```
test_handles_null_bbox_gracefully         PASSED
```

### TestMetadataSection (2 tests)
```
test_includes_version                     PASSED
test_includes_currency                    PASSED
```

---

## Test Output

```
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /home/user/contpaqi
plugins: Faker-38.2.0
collected 33 items

tests/test_task002_7_ground_truth.py ................................. [100%]

============================== 33 passed in 0.31s ==============================
```

---

## Sample Test Data

### Sample Invoice Data
```python
invoice_data = {
    'emisor': {'name': 'Test Co', 'rfc': 'TEST010101XXX', 'address': 'Test Addr'},
    'receptor': {'name': 'Client', 'rfc': 'CLNT020202YYY', 'address': 'Client Addr'},
    'date': '2024-01-15',
    'folio': 'TEST1234',
    'items': [
        {'description': 'Test', 'quantity': 1, 'unit_price': 100.0, 'amount': 100.0}
    ],
    'subtotal': 100.0,
    'iva': 16.0,
    'total': 116.0,
    'currency': 'MXN'
}
```

### Sample Bounding Boxes
```python
bboxes = {
    'rfc_emisor': {'x': 10, 'y': 10, 'width': 100, 'height': 20},
    'rfc_receptor': {'x': 10, 'y': 40, 'width': 100, 'height': 20},
    'date': {'x': 200, 'y': 10, 'width': 80, 'height': 20},
    'folio': {'x': 300, 'y': 10, 'width': 60, 'height': 20},
    'subtotal': {'x': 400, 'y': 200, 'width': 70, 'height': 20},
    'iva': {'x': 400, 'y': 230, 'width': 50, 'height': 20},
    'total': {'x': 400, 'y': 260, 'width': 80, 'height': 20},
    'items': [{'x': 10, 'y': 100, 'width': 400, 'height': 25}]
}
```

---

## Key Test Validations

### Structure Tests
```python
def test_returns_dictionary(self, sample_invoice_data, sample_bboxes):
    result = create_ground_truth(sample_invoice_data, sample_bboxes)
    assert isinstance(result, dict)

def test_has_fields_section(self, sample_invoice_data, sample_bboxes):
    result = create_ground_truth(sample_invoice_data, sample_bboxes)
    assert 'fields' in result
    assert isinstance(result['fields'], dict)
```

### Value Correctness Tests
```python
def test_rfc_emisor_value_correct(self, ground_truth):
    assert ground_truth['fields']['rfc_emisor']['value'] == 'XAXX010101ABC'

def test_total_value_correct(self, ground_truth):
    assert ground_truth['fields']['total']['value'] == 1160.00
```

### File I/O Tests
```python
def test_creates_json_file(self, sample_data):
    invoice_data, bboxes = sample_data
    with tempfile.TemporaryDirectory() as tmpdir:
        output_path = os.path.join(tmpdir, 'test.json')
        save_ground_truth(invoice_data, bboxes, output_path)
        assert os.path.exists(output_path)
```

### Null Handling Tests
```python
def test_handles_null_bbox_gracefully(self):
    bboxes = {'rfc_emisor': None, ...}
    result = create_ground_truth(invoice_data, bboxes)
    assert result['fields']['rfc_emisor']['bbox'] is None
    assert result['fields']['rfc_emisor']['value'] == 'TEST123456XXX'
```

---

## Coverage Summary

- [x] Module imports correctly
- [x] All three main functions exist
- [x] Returns correct structure
- [x] Has fields section with all required fields
- [x] Has line_items section
- [x] Has metadata section
- [x] Field values match input data
- [x] BBoxes correctly paired with values
- [x] Line items include all properties
- [x] Creates valid JSON files
- [x] Creates parent directories
- [x] Loads saved files correctly
- [x] Handles null bboxes gracefully
- [x] Includes version in metadata
- [x] Includes currency in metadata
