# T004.3 - Requirements.txt with Pinned Versions Log

**Subtask**: 4.3 Create requirements.txt with pinned versions
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Create a requirements.txt file with all Python dependencies pinned to specific versions for reproducible builds in the MCP container.

---

## Implementation Details

### Requirements File Structure

The requirements.txt is organized into logical categories:

```
mcp-container/requirements.txt
├── Web framework (FastAPI, Uvicorn, python-multipart)
├── AI/ML (PyTorch, Transformers)
├── OCR (pytesseract, pdf2image, Pillow)
├── Validation (Pydantic)
└── Utilities (python-dotenv)
```

### Pinned Dependencies

| Category | Package | Version | Purpose |
|----------|---------|---------|---------|
| **Web Framework** | fastapi | 0.104.1 | REST API framework |
| | uvicorn[standard] | 0.24.0 | ASGI server |
| | python-multipart | 0.0.6 | File upload support |
| **AI/ML** | torch | 2.1.0 | Deep learning framework |
| | transformers | 4.35.0 | Hugging Face models (TATR, LayoutLM) |
| **OCR** | pytesseract | 0.3.10 | Python Tesseract wrapper |
| | pdf2image | 1.16.3 | PDF to image conversion |
| | Pillow | 10.1.0 | Image processing |
| **Validation** | pydantic | 2.5.0 | Data validation and settings |
| **Utilities** | python-dotenv | 1.0.0 | Environment file loading |

### Final requirements.txt

```
# Web framework
fastapi==0.104.1
uvicorn[standard]==0.24.0
python-multipart==0.0.6

# AI/ML
torch==2.1.0
transformers==4.35.0

# OCR
pytesseract==0.3.10
pdf2image==1.16.3
Pillow==10.1.0

# Validation
pydantic==2.5.0

# Utilities
python-dotenv==1.0.0
```

---

## Version Selection Rationale

### FastAPI 0.104.1
- Stable release with Pydantic v2 support
- Required for modern async API patterns
- Compatible with uvicorn 0.24.x

### PyTorch 2.1.0
- Latest stable 2.x release
- Improved performance and memory efficiency
- Compatible with Transformers 4.35.x

### Transformers 4.35.0
- Supports LayoutLMv3 and Table Transformer models
- Compatible with PyTorch 2.1
- Includes latest model improvements

### Pydantic 2.5.0
- Major version 2 with improved performance
- Native Rust-based core (pydantic-core)
- Breaking changes from v1 handled by FastAPI 0.100+

### Pillow 10.1.0
- Security updates and bug fixes
- Compatible with pdf2image 1.16.x
- Improved image format support

---

## Why Pin Versions?

### Benefits of Exact Pinning

1. **Reproducibility**: Same versions across all environments
2. **Stability**: Prevents unexpected breaking changes
3. **Security**: Controlled updates through explicit version bumps
4. **Debugging**: Easier to reproduce issues

### Pinning Format

```
# Good: Exact pinning
fastapi==0.104.1

# Avoid: Range specifiers
fastapi>=0.100.0,<0.105.0

# Avoid: No version
fastapi
```

---

## Note on Detectron2

The task specification mentioned `detectron2==0.6`, but this package has special installation requirements:

1. **Not on PyPI**: Detectron2 is installed from Facebook's repository
2. **Build-time compilation**: Requires specific PyTorch/CUDA versions
3. **Platform-specific**: Needs to be compiled for target platform

If Detectron2 is needed, it would be installed via:
```dockerfile
# In Dockerfile (not requirements.txt)
RUN pip install 'git+https://github.com/facebookresearch/detectron2.git@v0.6'
```

For this implementation, the Table Transformer (TATR) model from Hugging Face Transformers is used instead, which provides similar table detection functionality without requiring Detectron2.

---

## Files

| File | Status |
|------|--------|
| `mcp-container/requirements.txt` | Verified (already complete) |

---

## Testing

### Test File Created
- `tests/test_task004_3_requirements_pinned.py`

### Test Classes (10 classes, 40 tests)
1. `TestRequirementsFileExists` - File existence tests (4 tests)
2. `TestWebFrameworkDependencies` - FastAPI, Uvicorn tests (6 tests)
3. `TestAIMLDependencies` - PyTorch, Transformers tests (4 tests)
4. `TestOCRDependencies` - OCR package tests (6 tests)
5. `TestValidationDependencies` - Pydantic tests (2 tests)
6. `TestUtilityDependencies` - Utility package tests (2 tests)
7. `TestVersionPinningPractices` - Best practices tests (3 tests)
8. `TestRequirementsOrganization` - Organization tests (5 tests)
9. `TestCompleteDependenciesList` - Completeness tests (2 tests)
10. `TestDockerfileIntegration` - Docker integration tests (2 tests)
11. `TestSecurityPractices` - Security tests (2 tests)
12. `TestVersionCompatibility` - Compatibility tests (2 tests)

### Test Results
- **Total Tests**: 40
- **Passed**: 40
- **Failed**: 0

---

## Integration with Docker

The requirements.txt is used in the Dockerfile:

```dockerfile
# Builder stage - create wheels
COPY requirements.txt .
RUN pip wheel --no-cache-dir --no-deps --wheel-dir /app/wheels -r requirements.txt

# Runtime stage - install from wheels
COPY --from=builder /app/wheels /wheels
RUN pip install --no-cache /wheels/*
```

This approach:
1. Creates wheel packages in builder stage
2. Copies only wheels to runtime (smaller image)
3. Installs from local wheels (faster, reproducible)

---

## Next Steps

- Subtask 4.4: Implement multi-stage build for optimization
- Subtask 4.5: Create docker-compose.yml for local development
