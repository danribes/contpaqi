# T007.1 LayoutLM Model - Implementation Log

## Subtask Information
- **Task**: 7 - LayoutLM Model Integration
- **Subtask**: 7.1 - Create mcp-container/src/models/layoutlm.py
- **Date**: 2025-12-07
- **Status**: Complete

## Implementation Details

### Overview
This subtask creates the foundational LayoutLMv3 model integration file for token classification on Mexican invoice images. The model extracts structured fields using BIO tagging (Begin, Inside, Outside).

### File Created

#### `mcp-container/src/models/layoutlm.py` (308 lines)

**Module Structure:**
```
layoutlm.py
├── Imports (torch, transformers with fallbacks)
├── ExtractedField dataclass
└── LayoutLMModel class
    ├── LABELS (BIO tags)
    ├── __init__()
    ├── _load_model()
    ├── _ensure_model_loaded()
    ├── predict()
    ├── extract_fields()
    └── _merge_tokens()
```

### Key Components

#### 1. ExtractedField Dataclass
```python
@dataclass
class ExtractedField:
    label: str      # Field type (e.g., 'RFC_EMISOR', 'TOTAL')
    value: str      # Extracted text value
    confidence: float  # 0.0 to 1.0
    bbox: tuple     # (x1, y1, x2, y2)
```

Features:
- Validation in `__post_init__`
- Ensures bbox is 4-element tuple
- Validates confidence range

#### 2. LayoutLMModel Class

**BIO Labels for Mexican Invoices:**
```python
LABELS = [
    'O',                              # Outside
    'B-RFC_EMISOR', 'I-RFC_EMISOR',   # Issuer RFC
    'B-RFC_RECEPTOR', 'I-RFC_RECEPTOR', # Receiver RFC
    'B-DATE', 'I-DATE',               # Invoice date
    'B-SUBTOTAL', 'I-SUBTOTAL',       # Subtotal amount
    'B-IVA', 'I-IVA',                 # Tax (IVA)
    'B-TOTAL', 'I-TOTAL',             # Total amount
    'B-ITEM_DESC', 'I-ITEM_DESC',     # Line item description
    'B-ITEM_QTY', 'I-ITEM_QTY',       # Line item quantity
    'B-ITEM_PRICE', 'I-ITEM_PRICE',   # Line item unit price
    'B-ITEM_AMOUNT', 'I-ITEM_AMOUNT'  # Line item total
]
```

**Default Model:** `microsoft/layoutlmv3-base`

### Technical Decisions

1. **Graceful Import Fallbacks**
   ```python
   try:
       import torch
       TORCH_AVAILABLE = True
   except ImportError:
       TORCH_AVAILABLE = False
   ```
   - Allows module to be imported without torch/transformers
   - Runtime checks before model operations

2. **Lazy Model Loading**
   - `load_model=True` parameter controls immediate loading
   - `_ensure_model_loaded()` for on-demand loading
   - Reduces startup time when model isn't needed immediately

3. **Device Auto-Detection**
   ```python
   if torch.cuda.is_available():
       self.device = "cuda"
   else:
       self.device = "cpu"
   ```

4. **BIO Tagging Scheme**
   - B- prefix: Beginning of a field
   - I- prefix: Inside/continuation of a field
   - O: Outside (not a field)
   - Handles multi-token fields correctly

### Integration Points

- **Input**: PIL Image + OCR words + bounding boxes
- **Output**: Dictionary of `ExtractedField` objects
- **Used by**: `inference.py` pipeline (Task 8)
- **Depends on**: OCR (Tesseract) for word extraction

## API

### Constructor
```python
model = LayoutLMModel(
    model_name="microsoft/layoutlmv3-base",  # or local path
    device="cuda",  # or "cpu", None for auto
    load_model=True  # False for lazy loading
)
```

### Prediction
```python
# Get token-level predictions
predictions = model.predict(
    image=pil_image,
    words=["Invoice", "Total:", "$100.00"],
    boxes=[(10, 10, 50, 20), (10, 30, 60, 40), (70, 30, 120, 40)]
)

# Group into fields
fields = model.extract_fields(predictions)
# Returns: {'TOTAL': ExtractedField(label='TOTAL', value='$100.00', ...)}
```

## Dependencies
- `torch` - PyTorch for model inference
- `transformers` - HuggingFace for LayoutLMv3
- `PIL` - Image handling (passed as input)

## Notes
- Model requires fine-tuning on Mexican invoice dataset for production use
- Base model provides structure; labels need training data
- Bounding boxes normalized to 0-1000 scale for LayoutLMv3 input
