# T003.5 - Hugging Face Dataset Validation Implementation Log

**Subtask**: 3.5 - Validate dataset format compatibility with Hugging Face
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Implement validation functions to ensure formatted datasets are compatible with Hugging Face libraries (datasets, transformers) for model training.

---

## Files Modified/Created

### Modified

- `scripts/prepare_datasets.py` - Added validation utility functions and CLI option

### Created

- `tests/test_task003_5_huggingface_validation.py` - 27 tests

---

## Implementation Details

### New Functions Added

| Function | Purpose |
|----------|---------|
| `validate_coco_format()` | Validate COCO format structure for TATR |
| `validate_layoutlm_format()` | Validate LayoutLM format structure |
| `validate_dataset()` | Validate entire dataset directory |

### New CLI Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--validate` | flag | False | Validate dataset format after processing |

---

## COCO Format Validation

### Required Structure

```json
{
  "images": [
    {"id": 1, "file_name": "img.png", "width": 800, "height": 600}
  ],
  "annotations": [
    {"id": 1, "image_id": 1, "category_id": 1, "bbox": [x, y, w, h]}
  ],
  "categories": [
    {"id": 1, "name": "table", "supercategory": "document"}
  ]
}
```

### Validation Checks

| Check | Description |
|-------|-------------|
| Required keys | images, annotations, categories |
| Image fields | id, file_name, width, height |
| Annotation fields | id, image_id, category_id, bbox |
| Bbox format | List of 4 numeric values |
| Category fields | id, name |
| Reference integrity | image_id exists in images |

---

## LayoutLM Format Validation

### Required Structure

```json
[
  {
    "tokens": ["word1", "word2"],
    "bboxes": [[x1, y1, x2, y2], [x1, y1, x2, y2]],
    "ner_tags": [0, 1],
    "image_path": "image.png"
  }
]
```

### Validation Checks

| Check | Description |
|-------|-------------|
| Required keys | tokens, bboxes, ner_tags, image_path |
| Length consistency | tokens, bboxes, ner_tags same length |
| Bbox format | List of 4 values per bbox |
| Tag range | ner_tags within [0, num_labels-1] |
| Tag type | ner_tags are integers |

---

## Validation Results

```python
# COCO format result
{
    'valid': True,
    'errors': [],
    'warnings': [],
    'num_images': 100,
    'num_annotations': 350,
    'num_categories': 2
}

# LayoutLM format result
{
    'valid': True,
    'errors': [],
    'warnings': [],
    'num_samples': 100,
    'total_tokens': 5000,
    'num_labels': 17
}
```

---

## Usage

```bash
# Validate after formatting
python scripts/prepare_datasets.py --format both --validate

# Just validate existing dataset
python scripts/prepare_datasets.py --validate --input-dir data/formatted
```

---

## Hugging Face Compatibility

### COCO (TATR)

```python
# Can be loaded for object detection
from datasets import load_dataset

dataset = load_dataset(
    'json',
    data_files={'train': 'train/annotations.json'}
)
```

### LayoutLM

```python
# Can be loaded for token classification
from datasets import Dataset

dataset = Dataset.from_list(samples)

# Compatible with LayoutLMv3Processor
from transformers import LayoutLMv3Processor
processor = LayoutLMv3Processor.from_pretrained("microsoft/layoutlmv3-base")
```

---

## Error Messages

### COCO Errors
```
"Missing required key: 'images'"
"Image 0: missing 'file_name' field"
"Annotation 5: 'bbox' must be list of 4 values"
```

### LayoutLM Errors
```
"Sample 0: missing 'tokens' field"
"Sample 3: tokens (5) and bboxes (4) length mismatch"
"Sample 2, tag 0: value 99 out of range [0, 16]"
```

---

## Test Summary

| Category | Tests |
|----------|-------|
| Module Functions Exist | 3 |
| COCO Format Validation | 8 |
| LayoutLM Format Validation | 9 |
| Dataset Directory Validation | 3 |
| Hugging Face Integration | 2 |
| CLI Integration | 2 |
| **Total** | **27** |

---

## Dependencies

- `datasets` - Hugging Face datasets library
- `transformers` - Hugging Face transformers library

---

## Next Steps

With subtask 3.5 complete, **Task 3: Format Data for TATR & LayoutLM** is now complete (5/5 subtasks done). The next task is:

- **Task 4**: Docker Environment & Dependencies
