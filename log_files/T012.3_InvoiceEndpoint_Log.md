# T012.3 Implement POST /api/invoice Endpoint - Implementation Log

## Overview
Created the main endpoint for submitting invoices for async processing.

## Files Created
- `windows-bridge/src/ContpaqiBridge/Controllers/InvoiceController.cs`
- `windows-bridge/src/ContpaqiBridge/Models/InvoiceModels.cs`

## Implementation Details

### Controller Action
```csharp
[HttpPost("invoice")]
[ProducesResponseType(typeof(CreateInvoiceResponse), StatusCodes.Status202Accepted)]
[ProducesResponseType(StatusCodes.Status400BadRequest)]
public async Task<IActionResult> CreateInvoice([FromBody] CreateInvoiceRequest request)
{
    if (!ModelState.IsValid)
    {
        return BadRequest(ModelState);
    }

    // Business validation
    if (request.Total != request.Subtotal + request.Iva)
    {
        return BadRequest(new { error = "Total must equal Subtotal + IVA" });
    }

    var job = new InvoiceJob
    {
        InvoiceData = request
    };

    var jobId = await _jobQueue.EnqueueAsync(job);

    var response = new CreateInvoiceResponse
    {
        JobId = jobId,
        Status = "pending",
        CreatedAt = job.CreatedAt,
        Message = "Invoice queued for processing"
    };

    return Accepted(response);
}
```

### Request Model
```csharp
public class CreateInvoiceRequest
{
    [Required]
    public string RfcEmisor { get; set; } = string.Empty;

    [Required]
    public string RfcReceptor { get; set; } = string.Empty;

    [Required]
    public DateTime Fecha { get; set; }

    public string? Folio { get; set; }

    [Range(0.01, double.MaxValue)]
    public decimal Subtotal { get; set; }

    [Range(0, double.MaxValue)]
    public decimal Iva { get; set; }

    [Range(0.01, double.MaxValue)]
    public decimal Total { get; set; }

    public List<LineItemRequest> LineItems { get; set; } = new();
}
```

### Response Model
```csharp
public class CreateInvoiceResponse
{
    public string JobId { get; set; } = string.Empty;
    public string Status { get; set; } = "pending";
    public DateTime CreatedAt { get; set; }
    public string Message { get; set; } = string.Empty;
}
```

### HTTP 202 Accepted
Using 202 instead of 200/201 because:
- Request was accepted but not completed
- Processing happens asynchronously
- Client should poll for status

## Usage
```bash
POST /api/invoice
Content-Type: application/json

{
  "rfcEmisor": "AAA010101AAA",
  "rfcReceptor": "BBB020202BBB",
  "fecha": "2024-01-15",
  "subtotal": 1000.00,
  "iva": 160.00,
  "total": 1160.00
}
```
