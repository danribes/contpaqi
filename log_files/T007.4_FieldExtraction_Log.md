# T007.4 Field Extraction - Implementation Log

## Subtask Overview
**Task**: 7 - LayoutLM Model Integration
**Subtask**: 7.4 - Map tokens to field labels (RFC, date, total, etc.)
**Status**: Completed
**Date**: 2025-12-07
**Tests**: 34 passing

## Description
Implemented the `extract_fields()` method that groups BIO-tagged tokens into complete fields, and `_merge_tokens()` helper for combining multiple tokens into a single ExtractedField.

## Files Created/Modified

| File | Description |
|------|-------------|
| `mcp-container/src/models/layoutlm.py` | extract_fields() and _merge_tokens() methods |
| `tests/test_task007_4_layoutlm_field_extraction.py` | 34 tests for field extraction |

## Implementation Details

### extract_fields() Method
```python
def extract_fields(self, predictions: List[Dict]) -> Dict[str, ExtractedField]:
    """Group BIO-tagged tokens into complete fields."""
    fields = {}
    current_field = None
    current_tokens = []

    for pred in predictions:
        label = pred['label']

        if label.startswith('B-'):
            # Save previous field
            if current_field and current_tokens:
                fields[current_field] = self._merge_tokens(current_tokens, current_field)

            # Start new field
            current_field = label[2:]  # Remove 'B-' prefix
            current_tokens = [pred]

        elif label.startswith('I-') and current_field == label[2:]:
            # Continue current field
            current_tokens.append(pred)

        else:
            # End current field (O label or mismatched I- label)
            if current_field and current_tokens:
                fields[current_field] = self._merge_tokens(current_tokens, current_field)
            current_field = None
            current_tokens = []

    # Don't forget last field
    if current_field and current_tokens:
        fields[current_field] = self._merge_tokens(current_tokens, current_field)

    return fields
```

### _merge_tokens() Method
```python
def _merge_tokens(self, tokens: List[Dict], field_name: str) -> ExtractedField:
    """Merge multiple tokens into a single ExtractedField."""
    # Concatenate words with spaces
    value = ' '.join(t['word'] for t in tokens)

    # Average confidence
    confidence = sum(t['confidence'] for t in tokens) / len(tokens)

    # Union bounding boxes
    bbox = (
        min(t['bbox'][0] for t in tokens),  # min x1
        min(t['bbox'][1] for t in tokens),  # min y1
        max(t['bbox'][2] for t in tokens),  # max x2
        max(t['bbox'][3] for t in tokens)   # max y2
    )

    return ExtractedField(
        label=field_name,
        value=value,
        confidence=confidence,
        bbox=bbox
    )
```

## BIO Tagging Logic

### Tag Meanings
- **B-**: Beginning of a new field
- **I-**: Inside/continuation of current field
- **O**: Outside (not part of any field)

### State Machine
```
  ┌─────────────────────────────────────────┐
  │                                         ▼
[START] ──B-X──> [IN_FIELD_X] ──I-X──> [IN_FIELD_X]
                      │                     │
                      ├──O──> [SAVE & END]  │
                      │                     │
                      ├──B-Y──> [SAVE & NEW_FIELD_Y]
                      │                     │
                      └──I-Y (mismatch)──> [SAVE & END]
```

## Supported Field Types

| Field | Description |
|-------|-------------|
| RFC_EMISOR | Sender's RFC |
| RFC_RECEPTOR | Receiver's RFC |
| DATE | Invoice date |
| SUBTOTAL | Subtotal before tax |
| IVA | 16% tax amount |
| TOTAL | Total amount |
| ITEM_DESC | Line item description |
| ITEM_QTY | Line item quantity |
| ITEM_PRICE | Line item unit price |
| ITEM_AMOUNT | Line item total |

## Test Summary

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestExtractFieldsMethodExists | 3 | Method exists and is callable |
| TestExtractFieldsReturnsDict | 3 | Returns dict, handles empty/O-only |
| TestBIOTagGrouping | 6 | B/I/O tag state machine |
| TestMergeTokensMethod | 6 | Word concat, confidence avg, bbox union |
| TestExtractedFieldValues | 3 | RFC, date, total values |
| TestFieldBoundingBoxes | 3 | Single, horizontal, vertical |
| TestAllFieldTypes | 8 | All 8 field types extract |
| TestLastFieldHandling | 2 | Last field not forgotten |
| **Total** | **34** | All passing |

## Key Design Decisions

1. **I- without preceding B- is ignored**: Orphan continuation tags are discarded
2. **I- with mismatched type ends field**: `B-RFC I-TOTAL` saves RFC and ignores I-TOTAL
3. **Last field captured**: Don't forget field at end of predictions list
4. **Confidence averaging**: Simple mean of token confidences
5. **Bounding box union**: Enclosing rectangle of all token boxes
