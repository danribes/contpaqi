# T008.5 Row Intersection Logic - Implementation Log

## Subtask Overview
**Task**: 8 - Inference Pipeline
**Subtask**: 8.5 - Implement intersection logic (words in rows → line items)
**Status**: Completed
**Date**: 2025-12-07
**Tests**: 21 passing

## Description
Added the `_assign_words_to_rows()` method that assigns OCR words to table rows based on bounding box intersection using the word's center Y coordinate.

## Files Modified

| File | Description |
|------|-------------|
| `mcp-container/src/inference.py` | Added _assign_words_to_rows() method |
| `tests/test_task008_5_row_intersection.py` | 21 tests for row intersection |

## Implementation Details

### _assign_words_to_rows() Method
```python
def _assign_words_to_rows(
    self,
    words: List[str],
    boxes: List[tuple],
    rows: List[Dict]
) -> List[Dict]:
    """Assign words to table rows based on bbox intersection."""
    line_items = []

    for row in rows:
        row_bbox = row['bbox']
        row_words = []

        for word, box in zip(words, boxes):
            # Check if word center is inside row
            word_center_y = (box[1] + box[3]) / 2
            if row_bbox[1] <= word_center_y <= row_bbox[3]:
                row_words.append({'word': word, 'bbox': box})

        if row_words:
            line_items.append({
                'row_index': row['index'],
                'words': row_words,
                'bbox': row_bbox
            })

    return line_items
```

### Method Signature
- **Input**:
  - `words`: List of word strings from OCR
  - `boxes`: List of bounding box tuples (x1, y1, x2, y2)
  - `rows`: List of row dicts with 'bbox' and 'index' keys
- **Output**: List of line item dictionaries

## Intersection Algorithm

```
Word bbox: (x1, y1, x2, y2)
           │
           ▼
    center_y = (y1 + y2) / 2
           │
           ▼
    Is center_y within row's y range?
    row_y1 <= center_y <= row_y2
           │
     Yes   │   No
     ↓     │   ↓
  Assign   │  Skip
  to row   │
```

## Return Structure
```python
[
    {
        'row_index': 0,
        'words': [
            {'word': 'Descripción', 'bbox': (50, 100, 150, 120)},
            {'word': 'Cant', 'bbox': (200, 100, 250, 120)},
        ],
        'bbox': (40, 95, 510, 125)
    },
    {
        'row_index': 1,
        'words': [
            {'word': 'Producto', 'bbox': (50, 130, 120, 150)},
            {'word': 'A', 'bbox': (125, 130, 145, 150)},
        ],
        'bbox': (40, 125, 510, 155)
    }
]
```

## Test Summary

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestAssignWordsToRowsMethodExists | 2 | Method exists and is callable |
| TestAssignWordsToRowsSignature | 3 | Accepts words, boxes, rows |
| TestAssignWordsToRowsReturnType | 2 | Returns list |
| TestAssignWordsToRowsBasicLogic | 3 | Center Y assignment |
| TestAssignWordsToRowsMultipleRows | 2 | Multi-row scenarios |
| TestAssignWordsToRowsResultStructure | 4 | Result dict structure |
| TestAssignWordsToRowsEdgeCases | 4 | Boundaries, empty inputs |
| TestAssignWordsToRowsIntegration | 1 | Realistic table |
| **Total** | **21** | All passing |

## Key Design Decisions

1. **Center Y coordinate**: Uses word's vertical center for assignment
2. **Inclusive boundaries**: Words on row boundaries are included (`<=`)
3. **Skip empty rows**: Rows without words are not in result
4. **Preserve word data**: Each word entry includes original bbox
