# T002.5 - Data Randomization Implementation Log

**Subtask**: 2.5 - Implement data randomization logic for company names, dates, prices
**Date**: 2025-12-03
**Status**: Completed

---

## Objective

Create a `generate_invoice_data()` function that generates complete, randomized invoice data suitable for rendering with HTML templates.

---

## Files Created

### Main Module

- `scripts/invoice_data.py` - Invoice data generation module

### Test File

- `tests/test_task002_5_data_randomization.py` - 43 tests

---

## Implementation Details

### generate_invoice_data() Function

```python
def generate_invoice_data(seed: Optional[int] = None) -> Dict[str, Any]:
    """
    Generate complete invoice data with randomized Mexican business information.

    Returns:
        Dictionary with emisor, receptor, date, folio, items, subtotal, iva, total, currency
    """
```

### Data Structure

```python
{
    'emisor': {
        'name': 'Empresa ABC S.A. de C.V.',
        'rfc': 'XAXX010101ABC',
        'address': 'Calle Principal 123, Col. Centro, CDMX'
    },
    'receptor': {
        'name': 'Cliente XYZ S. de R.L. de C.V.',
        'rfc': 'XBXB020202XYZ',
        'address': 'Av. Reforma 456, Monterrey, NL'
    },
    'date': '2024-03-15',
    'folio': 'A1B2C3D4',
    'items': [
        {
            'description': 'Servicio de consultoría profesional',
            'quantity': 10,
            'unit_price': 1500.00,
            'amount': 15000.00
        }
    ],
    'subtotal': 15000.00,
    'iva': 2400.00,
    'total': 17400.00,
    'currency': 'MXN'
}
```

---

## Features Implemented

### 1. Company Data Generation
- Uses `mexican_data.py` module for RFC generation
- Adds Mexican company suffixes (S.A. de C.V., S. de R.L. de C.V., etc.)
- Generates realistic Mexican addresses

### 2. Line Items Generation
- Variable item count (1-10 items)
- 35+ product/service descriptions
- Realistic price ranges:
  - Low: $10 - $500
  - Medium: $500 - $5,000
  - High: $5,000 - $50,000
- Quantity ranges: 1-100

### 3. Financial Calculations
- Subtotal = sum of all item amounts
- IVA = 16% of subtotal
- Total = subtotal + IVA
- All amounts rounded to 2 decimal places

### 4. Date Generation
- Random dates within last 2 years
- Format: YYYY-MM-DD (ISO 8601)
- Never in the future

### 5. Reproducibility
- Optional `seed` parameter for reproducible results
- Same seed = same invoice data

---

## Product Descriptions

The module includes 35+ realistic descriptions:

**Services:**
- Servicio de consultoría profesional
- Servicio de mantenimiento preventivo
- Servicio de soporte técnico
- Servicio de desarrollo de software
- Servicio de capacitación
- ...

**Products:**
- Material de oficina
- Equipo de cómputo
- Licencia de software
- Mobiliario de oficina
- ...

---

## Helper Functions

### generate_line_items()
```python
def generate_line_items(fake, num_items=None) -> List[Dict]:
    """Generate 1-10 random line items."""
```

### generate_item_description()
```python
def generate_item_description(fake) -> str:
    """Generate realistic product/service description."""
```

### generate_batch_invoices()
```python
def generate_batch_invoices(count, seed=None) -> List[Dict]:
    """Generate multiple invoices for batch processing."""
```

### format_invoice_for_template()
```python
def format_invoice_for_template(invoice) -> Dict:
    """Format data for Jinja2 template rendering."""
```

---

## TDD Process

1. **Tests Written First**: 43 tests defined requirements
2. **Implementation**: Module created to pass all tests
3. **Validation**: All 43 tests passing in 0.77s

---

## Test Categories

| Category | Tests |
|----------|-------|
| Import/Module | 2 |
| Data Structure | 10 |
| Emisor Data | 3 |
| Receptor Data | 3 |
| Items Data | 7 |
| Calculations | 4 |
| Date Field | 3 |
| Randomization | 3 |
| Seed Reproducibility | 2 |
| Price Ranges | 2 |
| RFC Validation | 2 |
| Descriptions | 2 |
| **Total** | **43** |

---

## Integration with Templates

The generated data structure matches template placeholders:

| Template Placeholder | Data Field |
|---------------------|------------|
| `{{ emisor.name }}` | `invoice['emisor']['name']` |
| `{{ emisor.rfc }}` | `invoice['emisor']['rfc']` |
| `{{ receptor.name }}` | `invoice['receptor']['name']` |
| `{{ folio }}` | `invoice['folio']` |
| `{{ date }}` | `invoice['date']` |
| `{% for item in items %}` | `invoice['items']` |
| `{{ subtotal }}` | `invoice['subtotal']` |
| `{{ iva }}` | `invoice['iva']` |
| `{{ total }}` | `invoice['total']` |

---

## Next Steps

- Subtask 2.6: Implement bounding box calculation for all fields
