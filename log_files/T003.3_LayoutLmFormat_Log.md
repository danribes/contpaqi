# T003.3 - LayoutLMv3 Data Preparation Implementation Log

**Subtask**: 3.3 - Implement LayoutLMv3 data preparation (BIO tags, tokens)
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Implement the LayoutLMv3 data preparation pipeline that converts synthetic invoice PDFs and JSON labels into BIO-tagged token format for token classification training.

---

## Files Modified/Created

### Modified

- `scripts/prepare_datasets.py` - Added LayoutLM format utilities and full format_layoutlm() implementation

### Created

- `tests/test_task003_3_layoutlm_format.py` - 38 tests

---

## Implementation Details

### New Functions Added

| Function | Purpose |
|----------|---------|
| `get_label_list()` | Get BIO labels for token classification |
| `normalize_bbox_layoutlm()` | Normalize bboxes to 0-1000 scale (LayoutLM format) |
| `get_ocr_tokens()` | Extract tokens from image using pytesseract |
| `match_token_to_field()` | Match token text to ground truth fields |
| `create_bio_tags()` | Create BIO tags for tokens |
| `create_layoutlm_sample()` | Create LayoutLM format sample |

---

## BIO Tagging Format

BIO (Beginning-Inside-Outside) tagging labels each token:

- **B-ENTITY**: Beginning of an entity
- **I-ENTITY**: Inside (continuation) of an entity
- **O**: Outside any entity

### Entity Types

| Entity | Description |
|--------|-------------|
| RFC_EMISOR | Issuer's tax ID |
| RFC_RECEPTOR | Recipient's tax ID |
| TOTAL | Invoice total amount |
| SUBTOTAL | Subtotal before tax |
| IVA | Tax amount (16%) |
| DATE | Invoice date |
| INVOICE_NUMBER | Invoice number |
| COMPANY_NAME | Company name |

---

## LayoutLM Sample Structure

```json
{
  "tokens": ["Invoice", "XAXX010101ABC", "Total:", "$1,160.00"],
  "bboxes": [[50, 100, 120, 130], [200, 100, 350, 130], ...],
  "ner_tags": [0, 1, 0, 5],
  "image_path": "invoice_00001.png"
}
```

### Fields

- `tokens`: List of OCR-extracted token texts
- `bboxes`: Normalized bounding boxes [x1, y1, x2, y2] (0-1000 scale)
- `ner_tags`: Integer label IDs (index into label list)
- `image_path`: Path to image file

---

## Pipeline Flow

```
Input                     Processing                  Output
─────                     ──────────                  ──────
data/synthetic/
├── pdfs/
│   └── invoice_00001.pdf ─→ pdf_to_image()
│                          ─→ get_ocr_tokens() ─────→ layoutlm/images/
│                                                      └── invoice_00001.png
└── labels/
    └── invoice_00001.json ─→ match_token_to_field()
                            ─→ create_bio_tags() ───→ layoutlm/samples.json
                                                      layoutlm/labels.json
```

---

## OCR Token Extraction

Uses pytesseract to extract tokens with bounding boxes:

```python
def get_ocr_tokens(image):
    ocr_data = pytesseract.image_to_data(image, output_type=pytesseract.Output.DICT)

    tokens = []
    for i in range(len(ocr_data['text'])):
        text = ocr_data['text'][i].strip()
        if text:
            x, y = ocr_data['left'][i], ocr_data['top'][i]
            w, h = ocr_data['width'][i], ocr_data['height'][i]
            bbox = [x, y, x + w, y + h]  # [x1, y1, x2, y2] format
            tokens.append({'text': text, 'bbox': bbox})

    return tokens
```

---

## Token Matching

Matches OCR tokens to ground truth fields:

```python
def match_token_to_field(token_text, ground_truth):
    fields = ground_truth.get('fields', {})

    # Check RFC_EMISOR
    if fields.get('rfc_emisor') == token_text:
        return 'RFC_EMISOR'

    # Check numeric fields with formatting
    total = fields.get('total')
    if total:
        clean_token = token_text.replace(',', '').replace('$', '')
        if clean_token == f"{total:.2f}":
            return 'TOTAL'

    return None
```

---

## Dependencies

- **pytesseract**: OCR engine wrapper
- **tesseract-ocr**: OCR backend (system package)
- **pdf2image**: PDF to image conversion
- **Pillow (PIL)**: Image processing

---

## Usage

```bash
# Convert to LayoutLM format
python scripts/prepare_datasets.py --format layoutlm

# Full command
python scripts/prepare_datasets.py \
    --input-dir data/synthetic \
    --output-dir data/formatted \
    --format layoutlm
```

---

## Output Structure

```
data/formatted/layoutlm/
├── images/
│   ├── invoice_00000.png
│   ├── invoice_00001.png
│   └── ...
├── samples.json    # List of LayoutLM samples
└── labels.json     # Label mapping ["O", "B-RFC_EMISOR", "I-RFC_EMISOR", ...]
```

---

## Label Mapping

```json
[
  "O",
  "B-RFC_EMISOR", "I-RFC_EMISOR",
  "B-RFC_RECEPTOR", "I-RFC_RECEPTOR",
  "B-TOTAL", "I-TOTAL",
  "B-SUBTOTAL", "I-SUBTOTAL",
  "B-IVA", "I-IVA",
  "B-DATE", "I-DATE",
  "B-INVOICE_NUMBER", "I-INVOICE_NUMBER",
  "B-COMPANY_NAME", "I-COMPANY_NAME"
]
```

---

## Test Summary

| Category | Tests |
|----------|-------|
| Module Functions Exist | 4 |
| Label List | 8 |
| Match Token To Field | 4 |
| Create BIO Tags | 3 |
| Get OCR Tokens | 4 |
| Create LayoutLM Sample | 6 |
| Integration Tests | 6 |
| Normalize BBox | 3 |
| **Total** | **38** |

---

## Error Handling

- Missing PDFs: Logged and skipped
- Missing pytesseract: Returns error status with message
- OCR failures: Token list may be empty, sample still created
- Invalid ground truth: Tokens tagged as 'O'

---

## Performance

- OCR extraction: ~1-2s per image
- 100 invoices: ~3-4 minutes total

---

## Next Steps

- **Subtask 3.4**: Create train/val/test splits
- **Subtask 3.5**: Validate Hugging Face compatibility
