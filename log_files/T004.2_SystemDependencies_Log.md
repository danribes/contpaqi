# T004.2 - System Dependencies Installation Log

**Subtask**: 4.2 Install system deps (tesseract-ocr, tesseract-ocr-spa, poppler)
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Install runtime system dependencies in the Docker container required for:
- OCR text extraction from invoice images (Tesseract)
- Spanish language support for Mexican invoices
- PDF to image conversion (Poppler)
- Image processing libraries (OpenGL, GLib)

---

## Implementation Details

### Dependencies Installed

The following system packages were added to the Dockerfile runtime stage:

| Package | Purpose |
|---------|---------|
| `tesseract-ocr` | Core OCR engine for text extraction |
| `tesseract-ocr-spa` | Spanish language data for Mexican invoices |
| `libpoppler-cpp-dev` | Poppler C++ library for PDF processing |
| `poppler-utils` | PDF utilities including `pdftoppm` for PDFâ†’image |
| `libgl1-mesa-glx` | OpenGL support for image processing (OpenCV) |
| `libglib2.0-0` | GLib library for various image operations |
| `curl` | HTTP client for container health checks |

### Dockerfile Changes

System dependencies are installed in the runtime stage (not builder) to ensure they're available at runtime:

```dockerfile
# Runtime Stage
FROM python:3.9-slim-bullseye

WORKDIR /app

# Install runtime system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    tesseract-ocr \
    tesseract-ocr-spa \
    libpoppler-cpp-dev \
    poppler-utils \
    libgl1-mesa-glx \
    libglib2.0-0 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Verify tesseract installation
RUN tesseract --version && tesseract --list-langs
```

### Best Practices Applied

1. **Single RUN Command**: All apt packages installed in one `RUN` command to minimize Docker layers
2. **--no-install-recommends**: Prevents installation of unnecessary recommended packages
3. **Cache Cleanup**: Removes apt lists after installation to reduce image size
4. **Verification Step**: Validates Tesseract installation and available languages
5. **Runtime Stage Only**: System deps installed in runtime stage (not builder) for clean separation

### Verification Commands

The Dockerfile includes verification:
```dockerfile
RUN tesseract --version && tesseract --list-langs
```

Expected output:
- `tesseract --version`: Shows Tesseract 4.1.1 or similar
- `tesseract --list-langs`: Lists `eng`, `osd`, `spa` (Spanish)

---

## Files Modified

| File | Changes |
|------|---------|
| `mcp-container/Dockerfile` | System dependencies already present from previous implementation |

---

## Testing

### Test File Created
- `tests/test_task004_2_system_dependencies.py`

### Test Classes
1. `TestTesseractOCR` - Validates Tesseract installation (5 tests)
2. `TestPoppler` - Validates Poppler installation (3 tests)
3. `TestOpenGLDependencies` - Validates OpenGL/GLib libraries (2 tests)
4. `TestCurlDependency` - Validates curl for health checks (2 tests)
5. `TestAptBestPractices` - Validates APT best practices (4 tests)
6. `TestCompleteDependenciesList` - Validates all deps present (2 tests)
7. `TestRuntimeStageDependencies` - Validates runtime stage config (4 tests)
8. `TestDependencyOrder` - Validates proper ordering (2 tests)
9. `TestDependencyIntegration` - Integration validation (3 tests)
10. `TestDependencyDocumentation` - Validates documentation (2 tests)

### Test Results
- **Total Tests**: 29
- **Passed**: 29
- **Failed**: 0

---

## Dependencies Rationale

### Tesseract OCR
- **tesseract-ocr**: Core OCR engine using LSTM neural networks
- **tesseract-ocr-spa**: Spanish language training data
  - Critical for Mexican invoices which contain:
    - Spanish text (product descriptions)
    - RFC numbers (tax IDs)
    - Currency formatting (MXN)
    - Date formats (dd/mm/yyyy)

### Poppler
- **poppler-utils**: Provides `pdftoppm` and `pdftotext`
  - `pdftoppm`: Converts PDF pages to images (PNG/JPEG)
  - Used by `pdf2image` Python library
- **libpoppler-cpp-dev**: Development headers
  - Required for some Python PDF libraries

### Image Processing
- **libgl1-mesa-glx**: OpenGL runtime
  - Required by OpenCV for some operations
  - Provides `libGL.so` shared library
- **libglib2.0-0**: GLib library
  - Common dependency for GTK/image processing
  - Required by various Python image libraries

### Health Checks
- **curl**: HTTP client
  - Used in HEALTHCHECK command
  - Verifies container is responding on port 8000

---

## Notes

- The system dependencies were already implemented as part of the Dockerfile structure in subtask 4.1
- This subtask focused on documenting and testing the system dependency configuration
- All dependencies are installed using Debian's APT package manager
- Image size impact is minimized by:
  - Using `--no-install-recommends`
  - Cleaning apt cache after installation
  - Using slim base image

---

## Next Steps

- Subtask 4.3: Create requirements.txt with pinned versions
- Subtask 4.4: Implement multi-stage build optimization
