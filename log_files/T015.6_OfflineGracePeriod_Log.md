# T015.6 - Offline Grace Period Implementation Log

**Subtask**: 15.6 - Implement offline grace period (7 days)
**Date**: 2025-12-09
**Status**: Completed

---

## Objective

Create an offline grace period service that allows continued application usage when the licensing server is unreachable, with configurable grace periods and warning levels.

---

## Files Created

### Main Service

- `desktop-app/src/services/OfflineGracePeriod.ts` - Offline grace period service (~550 lines)

### Test File

- `desktop-app/tests/offline-grace-period.test.ts` - 44 tests with local implementations

---

## Implementation Details

### Data Types

```typescript
interface OfflineGraceConfig {
  gracePeriodDays: number;        // Default: 7 days
  warningThresholdDays: number;   // When to show warnings
  checkIntervalMinutes: number;   // How often to check status
  persistStatePath: string;       // Path for persisting state
}

interface OfflineState {
  lastOnlineValidation: Date | null;
  lastOfflineCheck: Date | null;
  graceStartedAt: Date | null;
  gracePeriodDays: number;
  licenseKey: string;
  fingerprint: string;
  licenseType: LicenseType;
  features: string[];
  isOffline: boolean;
}

interface GracePeriodStatus {
  isValid: boolean;
  isInGracePeriod: boolean;
  remainingDays: number;
  remainingHours: number;
  graceStartedAt: Date | null;
  graceEndsAt: Date | null;
  warningLevel: 'none' | 'warning' | 'critical' | 'expired';
  message: string;
}
```

---

## License Type Grace Periods

| License Type | Grace Period |
|--------------|--------------|
| Trial | 3 days |
| Standard | 7 days |
| Professional | 14 days |
| Enterprise | 30 days |

---

## Warning Levels

| Level | Condition | Action |
|-------|-----------|--------|
| none | > 2 days remaining | Normal operation |
| warning | ≤ 2 days remaining | Show warning message |
| critical | < 24 hours remaining | Show urgent message |
| expired | 0 remaining | Block application |

---

## Core Functions

### Config Management

| Function | Description |
|----------|-------------|
| `createDefaultGraceConfig()` | Create default configuration |
| `mergeGraceConfig(partial)` | Merge partial with defaults |

### State Management

| Function | Description |
|----------|-------------|
| `createEmptyOfflineState()` | Create empty state |
| `createOfflineState(partial)` | Create state with data |
| `startGracePeriod(state, days)` | Start grace period |
| `endGracePeriod(state)` | End grace period (online) |
| `updateLastOnlineValidation(state)` | Record online validation |
| `recordOfflineCheck(state)` | Record offline check |

### Time Calculations

| Function | Description |
|----------|-------------|
| `calculateGraceEndDate(start, days)` | Calculate when grace ends |
| `calculateRemainingGraceTime(end)` | Get days/hours/minutes |
| `isGracePeriodExpired(start, days)` | Check if expired |
| `isWithinWarningThreshold(end, days)` | Check if within warning |
| `isCriticalThreshold(end)` | Check if < 24 hours |

### Status Functions

| Function | Description |
|----------|-------------|
| `getGracePeriodStatus(state, config)` | Get full status |
| `determineWarningLevel(end, threshold)` | Get warning level |
| `canUseOffline(state, config)` | Check if can use |
| `shouldWarnUser(state, config)` | Check if should warn |
| `isGracePeriodActive(state)` | Check if in grace period |

---

## OfflineGraceManager Class

```typescript
class OfflineGraceManager {
  constructor(config?: Partial<OfflineGraceConfig>);

  // License info
  setLicenseInfo(key: string, fp: string, type: LicenseType, features: string[]): void;

  // State transitions
  recordOnlineValidation(): void;
  recordValidationFailure(): void;
  goOffline(): void;
  goOnline(): void;

  // Status
  getStatus(): GracePeriodStatus;
  isValid(): boolean;
  shouldWarn(): boolean;
  isInGracePeriod(): boolean;
  getRemainingDays(): number;
  getFormattedTimeRemaining(): string;
  getWarningMessage(): string;

  // Events
  onEvent(handler: OfflineEventHandler): void;
  offEvent(handler: OfflineEventHandler): void;
  getEvents(): OfflineEvent[];

  // State management
  getState(): OfflineState;
  setState(state: OfflineState): void;
  saveState(): string;
  loadState(json: string): boolean;
  clear(): void;
  dispose(): void;
}
```

---

## Event Types

| Event | Triggered When |
|-------|----------------|
| `GRACE_STARTED` | Going offline, starting grace period |
| `GRACE_WARNING` | Entering warning threshold |
| `GRACE_CRITICAL` | Less than 24 hours remaining |
| `GRACE_EXPIRED` | Grace period ended |
| `BACK_ONLINE` | Reconnected and validated |
| `VALIDATION_SUCCESS` | Online validation succeeded |
| `VALIDATION_FAILED` | Online validation failed |

---

## State Flow

```
┌────────────┐     Network    ┌────────────┐
│   ONLINE   │ ──── Lost ───► │  OFFLINE   │
│  (Valid)   │                │ (In Grace) │
└────────────┘                └────────────┘
      ▲                             │
      │                             ▼
      │                       ┌──────────┐
      │                       │  Warning │
      │                       │ (≤2 days)│
      │                       └──────────┘
      │                             │
      │                             ▼
      │                       ┌──────────┐
      │                       │ Critical │
      │                       │ (<24 hrs)│
      │                       └──────────┘
      │                             │
      │     Network              ▼
      └─── Restored ◄───── ┌──────────┐
                           │ Expired  │
                           │(Invalid) │
                           └──────────┘
```

---

## Serialization

```typescript
function serializeOfflineState(state: OfflineState): string {
  return JSON.stringify({
    ...state,
    lastOnlineValidation: state.lastOnlineValidation?.toISOString() || null,
    lastOfflineCheck: state.lastOfflineCheck?.toISOString() || null,
    graceStartedAt: state.graceStartedAt?.toISOString() || null,
  });
}

function deserializeOfflineState(json: string): OfflineState | null {
  try {
    const data = JSON.parse(json);
    return {
      ...data,
      lastOnlineValidation: data.lastOnlineValidation ? new Date(data.lastOnlineValidation) : null,
      lastOfflineCheck: data.lastOfflineCheck ? new Date(data.lastOfflineCheck) : null,
      graceStartedAt: data.graceStartedAt ? new Date(data.graceStartedAt) : null,
    };
  } catch {
    return null;
  }
}
```

---

## TDD Process

1. **Tests Written First**: 44 tests with local implementations
2. **Implementation**: OfflineGracePeriod.ts service created
3. **Validation**: All tests passing
4. **Full Suite**: All 891 tests passing

---

## Test Summary

| Category | Tests |
|----------|-------|
| Config Management | 2 |
| Offline State | 2 |
| Time Calculations | 5 |
| Warning Level | 4 |
| Grace Period Status | 5 |
| State Transitions | 4 |
| Serialization | 4 |
| Event Creation | 2 |
| Display Functions | 2 |
| License Type Grace Periods | 1 |
| Validation Helpers | 3 |
| Edge Cases | 3 |
| Manager Lifecycle | 4 |
| Manager Events | 1 |
| Manager Persistence | 1 |
| Manager License Types | 1 |
| **Total** | **44** |

---

## Usage Examples

### Basic Usage

```typescript
import { OfflineGraceManager } from './services/OfflineGracePeriod';

const manager = new OfflineGraceManager({
  warningThresholdDays: 2,
});

// Set license info
manager.setLicenseInfo('KEY-1234', 'fp-abc123', 'professional', ['basic', 'export']);

// Record successful online validation
manager.recordOnlineValidation();

// Simulate going offline
manager.goOffline();

// Check status
const status = manager.getStatus();
console.log(status.message); // "Operating in offline mode. 14 days remaining..."

// Check if should warn user
if (manager.shouldWarn()) {
  showWarningDialog(manager.getWarningMessage());
}
```

### Event Handling

```typescript
manager.onEvent((event) => {
  switch (event.type) {
    case 'GRACE_WARNING':
      showNotification('License grace period ending soon');
      break;
    case 'GRACE_CRITICAL':
      showUrgentWarning('Connect to internet today!');
      break;
    case 'GRACE_EXPIRED':
      blockApplication('Please connect to validate license');
      break;
  }
});
```

### Persistence

```typescript
// Save state before app closes
const stateJson = manager.saveState();
localStorage.setItem('offline_state', stateJson);

// Restore state on app start
const savedState = localStorage.getItem('offline_state');
if (savedState) {
  manager.loadState(savedState);
}
```

---

## Integration Points

- **LicenseValidator** (T015.4): Uses grace period for offline validation
- **JwtLicenseToken** (T015.5): Tokens used for validation tracking
- **HardwareFingerprintService** (T015.1): Fingerprint stored in state

---

## Next Steps

- Subtask 15.7: Integrate license check into JobQueueService
- Subtask 15.8: Create license management UI
