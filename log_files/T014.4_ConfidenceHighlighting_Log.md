# T014.4 - Confidence-Based Highlighting Implementation Log

**Subtask**: 14.4 - Implement confidence-based highlighting (orange <0.90)
**Date**: 2025-12-08
**Status**: Completed

---

## Objective

Implement visual confidence-based highlighting that shows users which extracted invoice fields need review, with synchronized highlighting between PDF viewer and form fields.

---

## Files Created

### Main Component

- `desktop-app/src/components/ConfidenceHighlighting.tsx` - Utilities and components (~450 lines)

### Test File

- `desktop-app/tests/confidence-highlighting.test.ts` - 38 tests

### Modified Files

- `desktop-app/src/components/PDFViewer.tsx` - Added highlight overlay support
- `desktop-app/src/App.tsx` - Integrated confidence highlighting

---

## Implementation Details

### Confidence Thresholds

```typescript
const HIGH_CONFIDENCE_THRESHOLD = 0.90;    // Green - auto-accept
const MEDIUM_CONFIDENCE_THRESHOLD = 0.70;  // Orange - needs review
// Below 0.70 = Red - requires attention
```

### Utility Functions

| Function | Purpose |
|----------|---------|
| `needsReview(confidence)` | Check if field needs review (<0.90) |
| `getHighlightColor(confidence)` | Get color name (green/orange/red) |
| `getHighlightOpacity(confidence)` | Get opacity (lower confidence = more visible) |
| `calculateHighlightConfig(field)` | Create highlight config from field |
| `normalizeBoxToPage(bbox, width, height)` | Convert 0-1000 coords to page coords |
| `calculateConfidenceSummary(fields)` | Aggregate field statistics |
| `getFieldsNeedingReview(fields)` | Get sorted list of fields to review |
| `getSummaryStatus(summary)` | Get overall status (good/review/attention) |
| `getStatusMessage(summary)` | Get human-readable status message |

### Components Created

#### 1. ConfidenceSummary

Shows overview of field confidence levels:

```tsx
<ConfidenceSummary
  fields={fieldConfidenceData}
  onFieldClick={(fieldName) => setActiveHighlight(fieldName)}
/>
```

Features:
- Color-coded status indicator (green/orange/red)
- Count of high/medium/low confidence fields
- Average confidence percentage
- Clickable list of fields needing review

#### 2. ConfidenceBadge

Individual field confidence indicator:

```tsx
<ConfidenceBadge confidence={0.85} showPercent size="sm" />
```

#### 3. PDFHighlightOverlay

Renders colored rectangles over PDF to highlight fields:

```tsx
<PDFHighlightOverlay
  highlights={highlights}
  activeField={activeHighlight}
  pageWidth={pageSize.width}
  pageHeight={pageSize.height}
  scale={scale}
/>
```

#### 4. FieldHighlightIndicator

Visual indicator for form field highlighting.

---

## Color Scheme

| Confidence | Color | Opacity | Meaning |
|------------|-------|---------|---------|
| >= 0.90 | Green | 10% | High confidence, auto-accept |
| 0.70 - 0.89 | Orange | 25% | Medium confidence, needs review |
| < 0.70 | Red | 40% | Low confidence, requires attention |

---

## PDFViewer Integration

Added new props to PDFViewer:

```typescript
interface PDFViewerProps {
  // ... existing props ...
  highlights?: HighlightConfig[];
  activeHighlight?: string;
}
```

Highlight overlay rendered within Document/Page:

```tsx
<Document>
  <div className="relative inline-block">
    <Page ... />
    <PDFHighlightOverlay
      highlights={highlights}
      activeField={activeHighlight}
      pageWidth={pageSize.width}
      pageHeight={pageSize.height}
      scale={scale}
    />
  </div>
</Document>
```

---

## App.tsx Integration

### State Management

```typescript
// Active highlight for PDF viewer (syncs with form field focus)
const [activeHighlight, setActiveHighlight] = useState<string | undefined>();

// Convert extracted data to field confidence array
const fieldConfidenceData = useMemo(() => { ... }, [extractedInvoiceData]);

// Calculate highlight configs for PDF overlay
const pdfHighlights = useMemo(() => { ... }, [fieldConfidenceData]);
```

### Form-to-PDF Sync

When a form field is focused, the corresponding PDF region is highlighted:

```tsx
<InvoiceForm
  onFieldFocus={(fieldName, bbox) => {
    setActiveHighlight(fieldName);
  }}
/>
```

### PDF-to-Form Sync

Clicking a field in ConfidenceSummary highlights it in PDF:

```tsx
<ConfidenceSummary
  onFieldClick={(fieldName) => {
    setActiveHighlight(fieldName);
  }}
/>
```

---

## TDD Process

1. **Tests Written First**: 38 tests covering all requirements
2. **Implementation**: Module created to pass all tests
3. **Integration**: Added to PDFViewer and App.tsx
4. **Validation**: All 114 tests passing (38 + 33 + 43)

---

## Test Categories

| Category | Tests |
|----------|-------|
| Confidence Threshold Detection | 3 |
| Highlight Color Assignment | 3 |
| Highlight Opacity | 3 |
| Bounding Box Highlight Config | 3 |
| Bounding Box Normalization | 2 |
| Confidence Summary Calculation | 6 |
| Fields Needing Review | 3 |
| Summary Status Indicator | 3 |
| Status Message Generation | 3 |
| PDF Highlight Overlay | 2 |
| Active Field Highlighting | 3 |
| Confidence Badge Logic | 4 |
| **Total** | **38** |

---

## Bounding Box Coordinate System

LayoutLM uses 0-1000 normalized coordinates. The `normalizeBoxToPage` function converts these to actual page dimensions:

```typescript
function normalizeBoxToPage(bbox, pageWidth, pageHeight) {
  return {
    x1: (bbox.x1 / 1000) * pageWidth,
    y1: (bbox.y1 / 1000) * pageHeight,
    x2: (bbox.x2 / 1000) * pageWidth,
    y2: (bbox.y2 / 1000) * pageHeight,
  };
}
```

---

## Next Steps

- Subtask 14.5: Implement math error highlighting (red)
- Subtask 14.6: Implement validation blocking (disable Submit)
