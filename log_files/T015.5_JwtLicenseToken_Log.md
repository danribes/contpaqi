# T015.5 - JWT Signing and Validation Implementation Log

**Subtask**: 15.5 - Implement JWT signing and validation
**Date**: 2025-12-09
**Status**: Completed

---

## Objective

Create JWT-based token service for secure license authentication between client and server, including token creation, signing, validation, and refresh handling.

---

## Files Created

### Main Service

- `desktop-app/src/services/JwtLicenseToken.ts` - JWT token service (~500 lines)

### Test File

- `desktop-app/tests/jwt-license-token.test.ts` - 57 tests with local implementations

---

## Implementation Details

### JWT Structure

```
header.payload.signature

Header: {"alg":"HS256","typ":"JWT"}
Payload: {standard claims + license claims}
Signature: HMAC(header.payload, secret)
```

### Data Types

```typescript
interface JwtHeader {
  alg: 'HS256' | 'HS384' | 'HS512';
  typ: 'JWT';
}

interface LicenseTokenPayload {
  // Standard JWT claims
  iss: string;           // Issuer
  sub: string;           // Subject (license key)
  aud: string;           // Audience (app identifier)
  exp: number;           // Expiration timestamp
  iat: number;           // Issued at timestamp
  nbf: number;           // Not before timestamp
  jti: string;           // JWT ID (unique token ID)

  // Custom license claims
  licenseId: string;
  licenseType: LicenseType;
  fingerprint: string;
  features: string[];
  maxActivations: number;
  currentActivations: number;
}

interface TokenValidationResult {
  valid: boolean;
  payload: LicenseTokenPayload | null;
  error?: string;
  errorCode?: TokenErrorCode;
}
```

---

## Supported Algorithms

| Algorithm | Hash | Description |
|-----------|------|-------------|
| HS256 | SHA-256 | Default, good balance |
| HS384 | SHA-384 | Higher security |
| HS512 | SHA-512 | Maximum security |

---

## Core Functions

### Base64URL Encoding

| Function | Description |
|----------|-------------|
| `base64UrlEncode(str)` | Encode string to URL-safe base64 |
| `base64UrlDecode(str)` | Decode URL-safe base64 to string |
| `base64UrlEncodeJson(obj)` | Encode object as base64 JSON |
| `base64UrlDecodeJson<T>(str)` | Decode base64 JSON to object |

### HMAC Signing

| Function | Description |
|----------|-------------|
| `createHmacSignature(data, secret, alg)` | Create HMAC signature |
| `verifyHmacSignature(data, sig, secret, alg)` | Verify with constant-time compare |

### Token Creation

| Function | Description |
|----------|-------------|
| `createJwtHeader(algorithm)` | Create JWT header |
| `generateJti()` | Generate unique token ID |
| `createTokenPayload(...)` | Create payload with claims |
| `createToken(payload, config)` | Create complete JWT |
| `signToken(...)` | High-level token creation |

### Token Parsing

| Function | Description |
|----------|-------------|
| `parseToken(token)` | Parse JWT into parts |
| `getTokenParts(token)` | Get header/payload/signature parts |
| `extractPayload(token)` | Extract payload only |
| `extractHeader(token)` | Extract header only |

### Token Validation

| Function | Description |
|----------|-------------|
| `isTokenFormatValid(token)` | Check 3-part format |
| `isSignatureValid(token, secret, alg)` | Verify HMAC signature |
| `isTokenExpired(payload)` | Check expiration |
| `isTokenNotYetValid(payload)` | Check nbf claim |
| `isIssuerValid(payload, issuer)` | Verify issuer |
| `isAudienceValid(payload, audience)` | Verify audience |
| `isFingerprintValid(payload, fp)` | Verify fingerprint |
| `validateToken(token, fp, config)` | Full validation |

---

## Token Error Codes

| Code | Message |
|------|---------|
| INVALID_FORMAT | The token format is invalid |
| INVALID_SIGNATURE | The token signature could not be verified |
| TOKEN_EXPIRED | The token has expired |
| TOKEN_NOT_YET_VALID | The token is not yet valid |
| INVALID_ISSUER | The token issuer is not trusted |
| INVALID_AUDIENCE | The token is not intended for this application |
| FINGERPRINT_MISMATCH | The token is not valid for this device |
| DECODE_ERROR | The token could not be decoded |

---

## JwtTokenManager Class

```typescript
class JwtTokenManager {
  constructor(config?: Partial<JwtConfig>);

  // Configuration
  setSecret(secret: string): void;
  getConfig(): JwtConfig;
  updateConfig(partial: Partial<JwtConfig>): void;

  // Token operations
  createToken(...): string;
  validateToken(token: string, fingerprint: string): TokenValidationResult;
  setCurrentToken(token: string): boolean;
  getCurrentToken(): string | null;
  getCurrentPayload(): LicenseTokenPayload | null;
  clearToken(): void;

  // Token status
  hasValidToken(fingerprint: string): boolean;
  needsRefresh(thresholdMinutes?: number): boolean;
  getRemainingMinutes(): number;
  getFormattedExpiry(): string;

  // License info from token
  getLicenseType(): LicenseType | null;
  getFeatures(): string[];
  hasFeature(feature: string): boolean;

  // Persistence
  serializeToken(): string | null;
  restoreToken(token: string): boolean;
}
```

---

## Default Configuration

| Setting | Default Value |
|---------|---------------|
| secret | '' (must be set) |
| issuer | 'contpaqi-license-server' |
| audience | 'contpaqi-ai-bridge' |
| algorithm | 'HS256' |
| tokenLifetimeMinutes | 60 |

---

## Security Features

### Constant-Time Signature Comparison

```typescript
// Prevents timing attacks
function verifyHmacSignature(data, signature, secret, algorithm) {
  const expected = createHmacSignature(data, secret, algorithm);
  if (expected.length !== signature.length) return false;
  let result = 0;
  for (let i = 0; i < expected.length; i++) {
    result |= expected.charCodeAt(i) ^ signature.charCodeAt(i);
  }
  return result === 0;
}
```

### Token Binding

- Fingerprint embedded in token
- Validated on each use
- Prevents token theft/sharing

### Unique Token IDs (JTI)

```typescript
function generateJti(): string {
  return crypto.randomBytes(16).toString('hex');
}
```

---

## Token Refresh

| Function | Description |
|----------|-------------|
| `shouldRefreshToken(payload, threshold)` | Check if refresh needed |
| `getTokenRemainingSeconds(payload)` | Seconds until expiry |
| `getTokenRemainingMinutes(payload)` | Minutes until expiry |

Default refresh threshold: 5 minutes before expiry.

---

## Display Functions

| Function | Description |
|----------|-------------|
| `formatTokenExpiry(payload)` | Human-readable expiry |
| `getTokenErrorMessage(code)` | User-friendly error |

---

## TDD Process

1. **Tests Written First**: 57 tests with local implementations
2. **Implementation**: JwtLicenseToken.ts service created
3. **Validation**: All tests passing
4. **Full Suite**: All 847 tests passing

---

## Test Summary

| Category | Tests |
|----------|-------|
| Base64URL Encoding | 4 |
| HMAC Signing | 6 |
| JWT Header | 2 |
| Token Payload Creation | 4 |
| Token Creation | 3 |
| Token Parsing | 5 |
| Token Format Validation | 2 |
| Signature Validation | 3 |
| Token Expiration | 4 |
| Issuer/Audience Validation | 4 |
| Fingerprint Validation | 2 |
| Full Token Validation | 8 |
| Config Management | 2 |
| Token Refresh | 5 |
| Display Functions | 2 |
| JTI Generation | 1 |
| **Total** | **57** |

---

## Usage Examples

### Create Token

```typescript
import { JwtTokenManager } from './services/JwtLicenseToken';

const manager = new JwtTokenManager({
  secret: 'your-secret-key',
  tokenLifetimeMinutes: 60,
});

const token = manager.createToken(
  'TEST-1234-5678-ABCD',  // license key
  'license-123',          // license ID
  'professional',         // type
  'fp-abc123',           // fingerprint
  ['basic', 'export'],   // features
  5,                     // max activations
  1                      // current activations
);
```

### Validate Token

```typescript
const result = manager.validateToken(token, 'fp-abc123');

if (result.valid) {
  console.log('Token valid:', result.payload);
} else {
  console.error('Validation failed:', result.error);
}
```

### Token Refresh Check

```typescript
if (manager.needsRefresh()) {
  // Request new token from server
  const newToken = await refreshTokenFromServer();
  manager.setCurrentToken(newToken);
}
```

### Feature Access

```typescript
if (manager.hasFeature('export')) {
  enableExportButton();
}
```

---

## Integration Points

- **LicensingServerClient** (T015.3): Server returns JWT on activation
- **LicenseValidator** (T015.4): Uses JWT for authenticated validation
- **Offline mode**: Token used for cached validation

---

## Next Steps

- Subtask 15.6: Implement offline grace period (7 days)
- Subtask 15.7: Integrate license check into JobQueueService
