# T002.6 - Bounding Box Calculation Implementation Log

**Subtask**: 2.6 - Implement bounding box calculation for all fields
**Date**: 2025-12-03
**Status**: Completed

---

## Objective

Create utility functions for finding and calculating bounding boxes of text fields in invoice images using OCR data from pytesseract.

---

## Files Created

### Main Module

- `scripts/bbox_utils.py` - Bounding box utility functions

### Test File

- `tests/test_task002_6_bounding_boxes.py` - 27 tests

---

## Implementation Details

### Core Functions

| Function | Purpose |
|----------|---------|
| `create_bbox()` | Create bbox dict from coordinates |
| `normalize_bbox()` | Normalize to 0-1 range for ML |
| `merge_bboxes()` | Merge multiple bboxes into one |
| `ocr_image()` | Perform OCR using pytesseract |
| `filter_ocr_by_confidence()` | Filter low-quality OCR results |
| `find_text_bbox()` | Find bbox for specific text |
| `find_numeric_bbox()` | Find bbox for numeric values |
| `find_labeled_field_bbox()` | Find field by label and value |
| `find_date_bbox()` | Find dates in various formats |
| `find_item_bbox()` | Find line item row bbox |
| `find_all_field_bboxes()` | Find all invoice field bboxes |

---

## Bounding Box Structure

```python
bbox = {
    'x': 100,      # Left coordinate (pixels)
    'y': 200,      # Top coordinate (pixels)
    'width': 150,  # Width (pixels)
    'height': 30   # Height (pixels)
}
```

### Normalized BBox (for ML)

```python
normalized = {
    'x': 0.1,      # 0-1 range
    'y': 0.143,
    'width': 0.15,
    'height': 0.021
}
```

---

## Key Features

### 1. Text Search
- Exact match search
- Partial match (substring) search
- Case-insensitive option
- RFC pattern detection

### 2. Numeric Value Search
- Handles formatted numbers: `1,234.56`
- Handles currency: `$1,234.56`
- European format: `1.234,56`
- Tolerance for floating point

### 3. Date Search
- Multiple formats supported:
  - `YYYY-MM-DD`
  - `DD/MM/YYYY`
  - `DD-MM-YYYY`
  - `DD.MM.YYYY`

### 4. Field Detection
- Finds fields by label+value pairs
- Searches for nearby text
- Same-line detection

### 5. Item Row Detection
- Finds line items by description
- Merges quantity, price, amount boxes
- Returns encompassing bbox

---

## OCR Data Structure

pytesseract returns data in this format:

```python
ocr_data = {
    'text': ['FACTURA', 'Total:', '$17,400.00'],
    'left': [100, 50, 150],      # X coordinates
    'top': [50, 200, 200],       # Y coordinates
    'width': [120, 60, 100],     # Widths
    'height': [30, 25, 25],      # Heights
    'conf': [95, 90, 88],        # Confidence (0-100)
}
```

---

## find_all_field_bboxes() Output

```python
result = {
    'rfc_emisor': {'x': 100, 'y': 150, 'width': 130, 'height': 25},
    'rfc_receptor': {'x': 100, 'y': 200, 'width': 130, 'height': 25},
    'date': {'x': 400, 'y': 50, 'width': 100, 'height': 25},
    'folio': {'x': 300, 'y': 50, 'width': 80, 'height': 25},
    'subtotal': {'x': 450, 'y': 400, 'width': 90, 'height': 25},
    'iva': {'x': 450, 'y': 430, 'width': 80, 'height': 25},
    'total': {'x': 450, 'y': 460, 'width': 100, 'height': 25},
    'emisor_name': {'x': 50, 'y': 100, 'width': 200, 'height': 30},
    'receptor_name': {'x': 50, 'y': 170, 'width': 180, 'height': 30},
    'items': [
        {'x': 50, 'y': 300, 'width': 500, 'height': 25},
        {'x': 50, 'y': 330, 'width': 500, 'height': 25},
    ]
}
```

---

## Confidence Filtering

Low-confidence OCR results are filtered out:

```python
# Filter results with confidence < 50
filtered = filter_ocr_by_confidence(ocr_data, min_confidence=50)
```

---

## TDD Process

1. **Tests Written First**: 27 tests defined requirements
2. **Implementation**: Module created to pass all tests
3. **Mocking**: Used unittest.mock for OCR function tests
4. **Validation**: All 27 tests passing in 0.42s

---

## Test Categories

| Category | Tests |
|----------|-------|
| Module Exists | 4 |
| BBox Structure | 3 |
| Find Text | 5 |
| Find Numeric | 2 |
| Find All Fields | 3 |
| Normalization | 2 |
| Merge BBoxes | 3 |
| OCR Processing | 2 |
| Search Patterns | 2 |
| Item BBoxes | 1 |
| **Total** | **27** |

---

## Dependencies

- `pytesseract` - OCR library (optional for testing)
- Module works without pytesseract for unit testing
- Full functionality requires Tesseract OCR installed

---

## Next Steps

- Subtask 2.7: Create JSON sidecar file generator for ground truth labels
