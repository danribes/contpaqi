# T015.1 - Hardware Fingerprint Collection Implementation Log

**Subtask**: 15.1 - Implement hardware fingerprint collection (UUID)
**Date**: 2025-12-09
**Status**: Completed

---

## Objective

Create a hardware fingerprint service that collects unique machine identifiers (UUID, Machine GUID, hardware info) to generate a unique fingerprint for license validation purposes.

---

## Files Created

### Main Service

- `desktop-app/src/services/HardwareFingerprint.ts` - Hardware fingerprint service (~450 lines)

### Test File

- `desktop-app/tests/hardware-fingerprint.test.ts` - 60 tests with local implementations

---

## Implementation Details

### Data Types

```typescript
interface HardwareIdentifiers {
  machineId: string;        // Windows Machine GUID or fallback
  systemUuid: string | null; // SMBIOS/DMI UUID
  hostname: string;         // Machine hostname
  platform: string;         // win32, linux, darwin
  cpuModel: string;         // CPU model name
  cpuCores: number;         // Number of CPU cores
  totalMemory: number;      // Total RAM in bytes
}

interface FingerprintResult {
  fingerprint: string;      // SHA-256/512 hash
  identifiers: HardwareIdentifiers;
  generatedAt: Date;
  version: string;          // Service version
}

interface FingerprintConfig {
  includeHostname?: boolean;   // Include hostname in hash
  includeCpuInfo?: boolean;    // Include CPU info (default: true)
  includeMemory?: boolean;     // Include RAM size
  hashAlgorithm?: 'sha256' | 'sha512';
}

type FingerprintStatus = 'valid' | 'invalid' | 'expired' | 'mismatch';
```

### UUID Collection Functions

| Function | Description |
|----------|-------------|
| `getSystemUuid()` | Get SMBIOS/DMI UUID (platform-specific) |
| `getMachineId()` | Get Windows Machine GUID or fallback |
| `getWindowsSystemUuid()` | Execute `wmic csproduct get uuid` |
| `getWindowsMachineGuid()` | Query `HKLM\SOFTWARE\Microsoft\Cryptography` |
| `getLinuxSystemUuid()` | Read `/sys/class/dmi/id/product_uuid` |
| `getMacSystemUuid()` | Execute `ioreg` command |

### Fingerprint Functions

| Function | Description |
|----------|-------------|
| `generateFingerprint(identifiers, config)` | Generate hash from identifiers |
| `createFingerprintResult(identifiers, config)` | Create full result object |
| `generateSystemFingerprint(config)` | Generate from current system |
| `validateFingerprint(result, expected, maxAge)` | Validate fingerprint |
| `validateFingerprintFormat(fingerprint)` | Check SHA-256/512 format |
| `compareFingerprints(fp1, fp2)` | Case-insensitive comparison |

### Utility Functions

| Function | Description |
|----------|-------------|
| `normalizeUuid(uuid)` | Normalize UUID format |
| `isValidUuid(uuid)` | Validate UUID format |
| `parseWmicUuidOutput(output)` | Parse WMIC command output |
| `parseMachineGuid(output)` | Parse registry query output |
| `maskFingerprint(fp, visibleChars)` | Mask for display |
| `getFingerprintStrength(identifiers)` | Get strength score (0-100) |

### Serialization Functions

| Function | Description |
|----------|-------------|
| `serializeFingerprint(result)` | Convert to JSON string |
| `deserializeFingerprint(json)` | Parse from JSON string |

---

## Service Class

```typescript
class HardwareFingerprintService {
  constructor(config?: FingerprintConfig);

  // Core methods
  async initialize(): Promise<FingerprintResult>;
  async getFingerprint(): Promise<FingerprintResult>;
  async getFingerprintString(): Promise<string>;

  // Validation
  async validate(expected: string): Promise<FingerprintValidation>;
  async matches(expected: string): Promise<boolean>;

  // Utility
  async refresh(): Promise<FingerprintResult>;
  async getStrength(): Promise<number>;
  async getMaskedFingerprint(visibleChars?: number): Promise<string>;

  // Serialization
  async serialize(): Promise<string>;
  loadFromSerialized(json: string): boolean;
}
```

---

## Platform-Specific Implementation

### Windows (Primary Target)

```typescript
// 1. SMBIOS UUID via WMIC
const { stdout } = await execAsync('wmic csproduct get uuid');
// Output:
// UUID
// A1B2C3D4-E5F6-7890-ABCD-EF1234567890

// 2. Machine GUID from Registry
const { stdout } = await execAsync(
  'reg query HKLM\\SOFTWARE\\Microsoft\\Cryptography /v MachineGuid'
);
// Output:
// HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography
//     MachineGuid    REG_SZ    xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

### Linux

```typescript
// Read from DMI or machine-id
const { stdout } = await execAsync(
  'cat /sys/class/dmi/id/product_uuid 2>/dev/null || cat /etc/machine-id'
);
```

### macOS

```typescript
// Use ioreg command
const { stdout } = await execAsync(
  'ioreg -d2 -c IOPlatformExpertDevice | grep IOPlatformUUID'
);
```

---

## Fingerprint Generation Algorithm

```typescript
function generateFingerprint(identifiers, config) {
  // 1. Build components array
  const components = [
    identifiers.machineId,
    identifiers.platform,
  ];

  if (identifiers.systemUuid) {
    components.push(identifiers.systemUuid);
  }

  if (config.includeHostname) {
    components.push(identifiers.hostname);
  }

  if (config.includeCpuInfo) {
    components.push(identifiers.cpuModel);
    components.push(identifiers.cpuCores.toString());
  }

  // 2. Join with delimiter
  const joined = components.join('|');

  // 3. Hash with SHA-256
  return crypto.createHash('sha256').update(joined).digest('hex');
}
```

---

## Fingerprint Strength Scoring

| Component | Points |
|-----------|--------|
| Machine ID | 40 |
| System UUID | 30 |
| CPU Model | 15 |
| CPU Cores | 5 |
| Platform | 10 |
| **Max Total** | **100** |

Minimum requirement: Machine ID OR System UUID must be present.

---

## Caching

```typescript
// Cache TTL: 1 hour
const CACHE_TTL_MS = 60 * 60 * 1000;

// Get with caching
const fingerprint = await getCachedFingerprint(config, forceRefresh);

// Clear cache
clearFingerprintCache();
```

---

## UUID Format

Standard UUID format: `XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX`

```typescript
// Normalization handles:
// - Lowercase → UPPERCASE
// - Whitespace trimming
// - Raw hex → formatted UUID
// - Various delimiters

normalizeUuid('a1b2c3d4-e5f6-7890-abcd-ef1234567890');
// → 'A1B2C3D4-E5F6-7890-ABCD-EF1234567890'

normalizeUuid('A1B2C3D4E5F67890ABCDEF1234567890');
// → 'A1B2C3D4-E5F6-7890-ABCD-EF1234567890'
```

---

## Validation States

| Status | Description |
|--------|-------------|
| `valid` | Fingerprint is valid |
| `invalid` | Invalid format (not SHA-256/512) |
| `expired` | Exceeded max age |
| `mismatch` | Doesn't match expected value |

---

## TDD Process

1. **Tests Written First**: 60 tests with local implementations
2. **Implementation**: HardwareFingerprint.ts service created
3. **Validation**: All tests passing
4. **Full Suite**: All 619 tests passing

---

## Test Summary

| Category | Tests |
|----------|-------|
| UUID Normalization | 10 |
| Hardware Identifiers | 7 |
| Fingerprint Generation | 8 |
| Fingerprint Validation | 9 |
| WMIC Output Parsing | 6 |
| Serialization | 5 |
| Display/Utility Functions | 11 |
| Hash Function | 4 |
| **Total** | **60** |

---

## Usage Examples

### Basic Usage

```typescript
import { HardwareFingerprintService } from './services/HardwareFingerprint';

const service = new HardwareFingerprintService();

// Get fingerprint
const result = await service.getFingerprint();
console.log(result.fingerprint); // SHA-256 hash

// Validate against expected
const validation = await service.validate(expectedFingerprint);
if (!validation.isValid) {
  console.error(validation.message);
}
```

### With Configuration

```typescript
const service = new HardwareFingerprintService({
  includeHostname: true,    // Include hostname
  includeCpuInfo: true,     // Include CPU info
  includeMemory: false,     // Exclude memory
  hashAlgorithm: 'sha256',  // Use SHA-256
});
```

### Serialization for Storage

```typescript
// Save fingerprint
const json = await service.serialize();
localStorage.setItem('fingerprint', json);

// Load fingerprint
const saved = localStorage.getItem('fingerprint');
if (saved) {
  service.loadFromSerialized(saved);
}
```

---

## Next Steps

- Subtask 15.2: Add fallback identifiers (MAC address)
- Subtask 15.3: Set up cloud licensing server

