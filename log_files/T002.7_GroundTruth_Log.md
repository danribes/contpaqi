# T002.7 - JSON Ground Truth Generator Implementation Log

**Subtask**: 2.7 - Create JSON sidecar file generator for ground truth labels
**Date**: 2025-12-03
**Status**: Completed

---

## Objective

Create a module for generating JSON sidecar files that contain ground truth labels for invoice images, pairing field values with their bounding boxes for OCR model training.

---

## Files Created

### Main Module

- `scripts/ground_truth.py` - Ground truth generator module

### Test File

- `tests/test_task002_7_ground_truth.py` - 33 tests

---

## Implementation Details

### Core Functions

| Function | Purpose |
|----------|---------|
| `create_ground_truth()` | Create ground truth dict from invoice data + bboxes |
| `save_ground_truth()` | Save ground truth to JSON file |
| `load_ground_truth()` | Load ground truth from JSON file |
| `create_sidecar_path()` | Generate JSON path from image path |

---

## Ground Truth Structure

```json
{
  "fields": {
    "rfc_emisor": {
      "value": "XAXX010101ABC",
      "bbox": {"x": 100, "y": 150, "width": 130, "height": 25}
    },
    "rfc_receptor": {
      "value": "XBBB020202XYZ",
      "bbox": {"x": 100, "y": 200, "width": 130, "height": 25}
    },
    "date": {
      "value": "2024-03-15",
      "bbox": {"x": 400, "y": 50, "width": 100, "height": 25}
    },
    "folio": {
      "value": "A1B2C3D4",
      "bbox": {"x": 300, "y": 50, "width": 80, "height": 25}
    },
    "subtotal": {
      "value": 16000.00,
      "bbox": {"x": 450, "y": 400, "width": 90, "height": 25}
    },
    "iva": {
      "value": 2560.00,
      "bbox": {"x": 450, "y": 430, "width": 80, "height": 25}
    },
    "total": {
      "value": 18560.00,
      "bbox": {"x": 450, "y": 460, "width": 100, "height": 25}
    }
  },
  "line_items": [
    {
      "description": "Servicio de consultor√≠a",
      "quantity": 10,
      "unit_price": 1500.00,
      "amount": 15000.00,
      "bbox": {"x": 50, "y": 300, "width": 500, "height": 25}
    }
  ],
  "metadata": {
    "version": "1.0",
    "currency": "MXN"
  }
}
```

---

## Key Features

### 1. Three-Section Structure

- **fields**: Invoice header fields with values and bounding boxes
- **line_items**: Invoice line items with all data and bboxes
- **metadata**: Format version and currency information

### 2. Required Fields

- `rfc_emisor` - Issuer's RFC
- `rfc_receptor` - Receiver's RFC
- `date` - Invoice date
- `folio` - Invoice number
- `subtotal` - Pre-tax total
- `iva` - Tax amount (16% VAT)
- `total` - Final total

### 3. Null BBox Handling

- Gracefully handles missing bounding boxes
- Value is preserved even when OCR couldn't find the field
- `bbox` is set to `null` in JSON

### 4. Automatic Directory Creation

- Creates parent directories if they don't exist
- Allows nested output paths

---

## Usage Example

```python
from ground_truth import create_ground_truth, save_ground_truth

# Invoice data from generator
invoice_data = {
    'emisor': {'name': 'Company', 'rfc': 'COMP010101XXX', 'address': 'Addr'},
    'receptor': {'name': 'Client', 'rfc': 'CLNT020202YYY', 'address': 'Addr'},
    'date': '2024-03-15',
    'folio': 'INV-001',
    'items': [...],
    'subtotal': 1000.00,
    'iva': 160.00,
    'total': 1160.00,
    'currency': 'MXN'
}

# Bboxes from OCR detection
bboxes = {
    'rfc_emisor': {'x': 100, 'y': 150, 'width': 130, 'height': 25},
    'rfc_receptor': {'x': 100, 'y': 200, 'width': 130, 'height': 25},
    ...
}

# Save to JSON sidecar file
save_ground_truth(invoice_data, bboxes, 'output/invoice_001.json')
```

---

## TDD Process

1. **Tests Written First**: 33 tests defined requirements
2. **Implementation**: Module created to pass all tests
3. **Validation**: All 33 tests passing in 0.31s

---

## Test Categories

| Category | Tests |
|----------|-------|
| Module Exists | 4 |
| Create Ground Truth | 4 |
| Fields Structure | 9 |
| Line Items Structure | 7 |
| Save Ground Truth | 4 |
| Load Ground Truth | 2 |
| Null BBox Handling | 1 |
| Metadata Section | 2 |
| **Total** | **33** |

---

## Dependencies

- Standard library only: `json`, `os`, `typing`
- No external dependencies required

---

## Integration Points

- **Input**: Invoice data from `invoice_data.py`
- **Input**: Bounding boxes from `bbox_utils.py`
- **Output**: JSON sidecar files for ML training

---

## Next Steps

- Subtask 2.8: Integrate all components into the full pipeline
