# T007.1 LayoutLM Module Structure - Implementation Log

## Subtask Overview
**Task**: 7 - LayoutLM Model Integration
**Subtask**: 7.1 - Create mcp-container/src/models/layoutlm.py
**Status**: Completed
**Date**: 2025-12-07
**Tests**: 43 passing

## Description
Created the basic module structure for LayoutLMv3 token classification model, including the ExtractedField dataclass and LayoutLMModel class with BIO tagging labels.

## Files Created/Modified

### Created Files
| File | Description |
|------|-------------|
| `mcp-container/src/models/layoutlm.py` | Main LayoutLM module (270 lines) |
| `tests/test_task007_1_layoutlm_module.py` | Module structure tests (43 tests) |

### Modified Files
| File | Change |
|------|--------|
| `mcp-container/src/models/__init__.py` | Added LayoutLM exports |

## Implementation Details

### ExtractedField Dataclass
```python
@dataclass
class ExtractedField:
    label: str       # Field type (e.g., 'RFC_EMISOR', 'TOTAL')
    value: str       # Extracted text value
    confidence: float # 0.0 to 1.0
    bbox: tuple      # (x1, y1, x2, y2)
```

**Validation**:
- bbox must be tuple of 4 elements
- confidence must be between 0.0 and 1.0

### LayoutLMModel Class
```python
class LayoutLMModel:
    DEFAULT_MODEL_NAME = "microsoft/layoutlmv3-base"
    LABELS = [
        'O',
        'B-RFC_EMISOR', 'I-RFC_EMISOR',
        'B-RFC_RECEPTOR', 'I-RFC_RECEPTOR',
        'B-DATE', 'I-DATE',
        'B-SUBTOTAL', 'I-SUBTOTAL',
        'B-IVA', 'I-IVA',
        'B-TOTAL', 'I-TOTAL',
        'B-ITEM_DESC', 'I-ITEM_DESC',
        'B-ITEM_QTY', 'I-ITEM_QTY',
        'B-ITEM_PRICE', 'I-ITEM_PRICE',
        'B-ITEM_AMOUNT', 'I-ITEM_AMOUNT'
    ]  # 21 labels total
```

### BIO Tagging Scheme
| Prefix | Meaning |
|--------|---------|
| O | Outside - not part of any field |
| B- | Beginning - first token of a field |
| I- | Inside - continuation of a field |

### Field Types (10 entity types)
| Field | Description |
|-------|-------------|
| RFC_EMISOR | Issuer's RFC (tax ID) |
| RFC_RECEPTOR | Receiver's RFC |
| DATE | Invoice date |
| SUBTOTAL | Subtotal amount |
| IVA | Tax amount (16%) |
| TOTAL | Total amount |
| ITEM_DESC | Line item description |
| ITEM_QTY | Line item quantity |
| ITEM_PRICE | Line item unit price |
| ITEM_AMOUNT | Line item total amount |

## Key Methods

| Method | Description |
|--------|-------------|
| `__init__()` | Initialize with model_name, device, load_model |
| `predict()` | Run token classification on words/boxes |
| `extract_fields()` | Group BIO tokens into ExtractedField objects |
| `_merge_tokens()` | Merge multiple tokens into single field |

## Conditional Imports
- `TORCH_AVAILABLE` - True if torch is installed
- `TRANSFORMERS_AVAILABLE` - True if transformers is installed

## Test Summary

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestLayoutLMModuleExists | 3 | File, import, docstring |
| TestExtractedFieldDataclass | 7 | Dataclass structure |
| TestExtractedFieldValidation | 3 | Bbox/confidence validation |
| TestLayoutLMModelClass | 16 | Class structure, LABELS |
| TestLayoutLMModelInit | 2 | Init parameters |
| TestModuleExports | 3 | __all__ exports |
| TestLayoutLMAvailabilityFlags | 2 | TORCH/TRANSFORMERS flags |
| TestPredictMethodSignature | 3 | predict() params |
| TestExtractFieldsMethodSignature | 1 | extract_fields() params |
| TestBIOTaggingLabels | 3 | BIO format validation |
| **Total** | **43** | All passing |
