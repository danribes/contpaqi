# T007.2 LayoutLMv3 Model Loading - Implementation Log

## Subtask Overview
**Task**: 7 - LayoutLM Model Integration
**Subtask**: 7.2 - Implement LayoutLMv3 model loading
**Status**: Completed
**Date**: 2025-12-07
**Tests**: 23 passing

## Description
Implemented model loading functionality for LayoutLMv3 token classification using HuggingFace Transformers.

## Files Created/Modified

| File | Description |
|------|-------------|
| `tests/test_task007_2_layoutlm_loading.py` | 23 tests for model loading |

## Implementation Details

### Model Loading Method
```python
def _load_model(self):
    """Load the model and processor."""
    if not TORCH_AVAILABLE:
        raise RuntimeError("PyTorch is not available")
    if not TRANSFORMERS_AVAILABLE:
        raise RuntimeError("Transformers is not available")

    self.processor = LayoutLMv3Processor.from_pretrained(self.model_name)
    self.model = LayoutLMv3ForTokenClassification.from_pretrained(
        self.model_name,
        num_labels=len(self.LABELS)  # 21 labels
    )
    self.model.to(self.device)
    self.model.eval()
    self._model_loaded = True
```

### Label Mappings
```python
# Created in __init__
self.label2id = {label: idx for idx, label in enumerate(self.LABELS)}
self.id2label = {idx: label for idx, label in enumerate(self.LABELS)}

# Example:
# label2id = {'O': 0, 'B-RFC_EMISOR': 1, 'I-RFC_EMISOR': 2, ...}
# id2label = {0: 'O', 1: 'B-RFC_EMISOR', 2: 'I-RFC_EMISOR', ...}
```

### Device Selection
```python
if device is None:
    if TORCH_AVAILABLE and torch is not None and torch.cuda.is_available():
        self.device = "cuda"
    else:
        self.device = "cpu"
```

### Lazy Loading
- `load_model=False` allows initialization without loading
- `_ensure_model_loaded()` loads on first inference if needed

## Test Summary

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestLayoutLMModelLoading | 8 | Init with defaults/custom params |
| TestLayoutLMModelLoadingWithMocks | 5 | from_pretrained, device, eval |
| TestLayoutLMModelLoadingErrors | 2 | Raises without torch/transformers |
| TestEnsureModelLoaded | 2 | Loads if needed, skips if loaded |
| TestModelConstants | 5 | Microsoft model, label counts |
| TestNumLabelsParameter | 1 | num_labels=21 passed to model |
| **Total** | **23** | All passing |
