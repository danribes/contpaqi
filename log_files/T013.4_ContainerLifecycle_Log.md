# T013.4 Container Lifecycle Management - Implementation Log

## Overview
Implemented container lifecycle management (start/stop/restart) in the DockerManager class, using docker-compose commands for container orchestration.

## Files Created/Modified
- `desktop-app/electron/docker-manager.ts` - Added lifecycle methods (270+ lines added)
- `desktop-app/electron/main.ts` - Updated to use DockerManager lifecycle methods
- `desktop-app/electron/preload.ts` - Added dockerRestart IPC bridge
- `desktop-app/tests/docker-lifecycle.test.ts` - 30 unit tests

## Implementation Details

### 1. New Interfaces
```typescript
// Result from lifecycle operations
export interface ContainerLifecycleResult {
  success: boolean;
  message?: string;
  error?: string;
}

// Start options
export interface StartContainerOptions {
  build?: boolean;        // Rebuild images
  forceRecreate?: boolean; // Force recreate containers
  env?: Record<string, string>; // Environment variables
}

// Stop options
export interface StopContainerOptions {
  removeVolumes?: boolean; // Remove volumes
  removeOrphans?: boolean; // Remove orphan containers
}

// Build options
export interface BuildImageOptions {
  noCache?: boolean; // Don't use cache
}
```

### 2. DockerManager Constructor Update
```typescript
constructor(
  containerName: string,
  timeout: number = 10000,
  composePath: string = process.cwd(),
  useComposeV2: boolean = false
)
```

### 3. New Methods

| Method | Command | Description |
|--------|---------|-------------|
| `startContainer(options)` | `docker-compose up -d` | Start container with optional build/recreate |
| `stopContainer(options)` | `docker-compose down` | Stop container with optional volume removal |
| `restartContainer()` | stop + start | Restart by stopping then starting |
| `pullImages()` | `docker-compose pull` | Pull latest images |
| `buildImages(options)` | `docker-compose build` | Build images with optional --no-cache |

### 4. Docker Compose v1 vs v2 Support
```typescript
private getComposeCommand(): { cmd: string; baseArgs: string[] } {
  if (this.useComposeV2) {
    return { cmd: 'docker', baseArgs: ['compose'] }; // v2
  }
  return { cmd: 'docker-compose', baseArgs: [] }; // v1
}
```

### 5. Main Process Integration
```typescript
// Updated functions to use DockerManager
async function startContainer() {
  const result = await dockerManager.startContainer();
  return { success: result.success, error: result.error };
}

async function stopContainer() {
  const result = await dockerManager.stopContainer();
  return { success: result.success, error: result.error };
}

async function restartContainer() {
  const result = await dockerManager.restartContainer();
  return { success: result.success, error: result.error };
}

// IPC handlers
ipcMain.handle('docker:start', async () => startContainer());
ipcMain.handle('docker:stop', async () => stopContainer());
ipcMain.handle('docker:restart', async () => restartContainer());
```

### 6. Preload Bridge
```typescript
contextBridge.exposeInMainWorld('electronAPI', {
  dockerStart: () => ipcRenderer.invoke('docker:start'),
  dockerStop: () => ipcRenderer.invoke('docker:stop'),
  dockerRestart: () => ipcRenderer.invoke('docker:restart'),
});
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    DockerManager                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                 Lifecycle Methods                        ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ ││
│  │  │ startCont.  │  │ stopCont.   │  │ restartCont.    │ ││
│  │  │ up -d       │  │ down        │  │ down + up       │ ││
│  │  └─────────────┘  └─────────────┘  └─────────────────┘ ││
│  │  ┌─────────────┐  ┌─────────────┐                       ││
│  │  │ pullImages  │  │ buildImages │                       ││
│  │  │ pull        │  │ build       │                       ││
│  │  └─────────────┘  └─────────────┘                       ││
│  └─────────────────────────────────────────────────────────┘│
│                           │                                  │
│                           ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              getComposeCommand()                         ││
│  │  v1: docker-compose args...                              ││
│  │  v2: docker compose args...                              ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

## Key Features

1. **docker-compose Integration**: Uses docker-compose for container orchestration
2. **v1/v2 Support**: Supports both `docker-compose` and `docker compose`
3. **Timeout Protection**: 30-second timeout for lifecycle operations
4. **Environment Variables**: Can pass custom env vars to containers
5. **Build Options**: Support for --build, --force-recreate, --no-cache
6. **Volume Management**: Option to remove volumes on stop
7. **Orphan Cleanup**: Option to remove orphan containers

## Command Mappings

| Action | Command |
|--------|---------|
| Start | `docker-compose up -d` |
| Start + Build | `docker-compose up -d --build` |
| Start + Recreate | `docker-compose up -d --force-recreate` |
| Stop | `docker-compose down` |
| Stop + Volumes | `docker-compose down --volumes` |
| Stop + Orphans | `docker-compose down --remove-orphans` |
| Pull | `docker-compose pull` |
| Build | `docker-compose build` |
| Build No Cache | `docker-compose build --no-cache` |

## Verification
- All lifecycle methods implemented
- IPC handlers registered
- Preload bridge updated with restart
- Tests written for all scenarios
