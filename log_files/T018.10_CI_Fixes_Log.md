# Implementation Log - CI Fixes for Subtask 18.10
## Inno Setup Compilation Fixes for Windows Installer

**Date:** 2025-12-12
**Status:** Completed
**PRs Merged:** #119, #120, #121, #122

---

## Overview

After merging Subtask 18.10 (i18n unit tests), the CI build for the Windows Installer failed multiple times due to issues in the Inno Setup script (`installer/contpaqi-bridge.iss`). This document records all the fixes applied to get the CI pipeline passing.

---

## CI Failures and Fixes

### Fix 1: Missing icon.ico Reference (PR #119)

**Error:**
```
Error on line 46 in D:\a\contpaqi\contpaqi\installer\contpaqi-bridge.iss: The system cannot find the file specified.
```

**Root Cause:**
Line 46 referenced `SetupIconFile=assets\icon.ico` but no icon file existed in the `installer/assets/` directory.

**Solution:**
Comment out the SetupIconFile directive until a custom icon is provided.

**File Changed:** `installer/contpaqi-bridge.iss`
```pascal
; SetupIconFile=assets\icon.ico  ; TODO: Add custom icon file when available
```

**Commit:** `1975832` - `fix(ci): Comment out missing icon.ico reference in Inno Setup`

---

### Fix 2: Invalid Inno Setup Flag (PR #120)

**Error:**
```
Error on line 116 in D:\a\contpaqi\contpaqi\installer\contpaqi-bridge.iss: Parameter "Flags" includes an unknown flag.
```

**Root Cause:**
Used `skipifdoesntexist` flag which doesn't exist in Inno Setup. The flag was an attempt to make optional files skip if not present.

**Initial Attempt (Failed):**
```pascal
Source: "dist\docker\contpaqi-mcp.tar"; DestDir: "{app}\docker"; Flags: ignoreversion skipifdoesntexist
```

**Solution Applied in PR #121:**
Use the `#ifexist` preprocessor directive instead.

**Commit:** `6ed3783` - `fix(ci): Make Docker tar and scripts optional in Inno Setup`

---

### Fix 3: Use #ifexist Preprocessor (PR #121)

**Error:**
```
Error on line 116: Parameter "Flags" includes an unknown flag.
```

**Root Cause:**
Inno Setup requires all source files to exist at compile time. There's no runtime flag to skip missing files.

**Solution:**
Use `#ifexist` preprocessor directive to conditionally include file entries.

**File Changed:** `installer/contpaqi-bridge.iss`
```pascal
; Docker image (saved tar) - optional, may not exist in CI builds
#ifexist "dist\docker\contpaqi-mcp.tar"
Source: "dist\docker\contpaqi-mcp.tar"; DestDir: "{app}\docker"; Flags: ignoreversion
#endif

; Utilities - optional, may not exist in CI builds
#ifexist "dist\scripts\*"
Source: "dist\scripts\*"; DestDir: "{app}\scripts"; Flags: ignoreversion recursesubdirs createallsubdirs
#endif
```

**Commit:** `43c74a6` - `fix(ci): Use #ifexist preprocessor for optional Inno Setup files`

---

### Fix 4: ShellExec Type Mismatch (PR #122)

**Error:**
```
Error on line 356 in D:\a\contpaqi\contpaqi\installer\contpaqi-bridge.iss: Column 111:
Type mismatch.
```

**Root Cause:**
The `ShellExec` function expects an Integer variable for the error code (last parameter), but the code was passing `Result` which is a Boolean in the `InitializeSetup()` function context.

**Problematic Code:**
```pascal
function InitializeSetup(): Boolean;
begin
  Result := True;
  // ...
  ShellExec('open', 'https://...', '', '', SW_SHOW, ewNoWait, Result);  // Result is Boolean!
end;
```

**Solution:**
Declare a separate Integer variable for the error code.

**File Changed:** `installer/contpaqi-bridge.iss`
```pascal
function InitializeSetup(): Boolean;
var
  ErrorCode: Integer;  // Added for ShellExec
begin
  Result := True;
  // ...
  ShellExec('open', 'https://dotnet.microsoft.com/download/dotnet/6.0', '', '', SW_SHOW, ewNoWait, ErrorCode);
end;
```

**Commit:** `f2f8a82` - `fix(ci): Fix ShellExec type mismatch in InitializeSetup()`

---

## Summary of All Changes

| Issue | Line | Error | Fix |
|-------|------|-------|-----|
| Missing icon.ico | 46 | File not found | Comment out SetupIconFile directive |
| Docker tar missing | 116 | Invalid flag | Use `#ifexist` preprocessor |
| Scripts missing | 127 | Invalid flag | Use `#ifexist` preprocessor |
| ShellExec type | 356 | Type mismatch | Add ErrorCode Integer variable |

---

## Final CI Build Result

After PR #122 was merged, the CI build succeeded:

```
Successful compile (18.828 sec). Resulting Setup program filename is:
D:\a\contpaqi\contpaqi\installer\output\ContPAQi-AI-Bridge-Setup-1.0.0-dev.20.exe
```

**Warnings (Non-blocking):**
- Architecture identifier "x64" is deprecated (suggest using "x64compatible")
- OnlyBelowVersion parameter warning (Windows Vista no longer supported)
- UninstallRun entries without RunOnceId parameter
- UsedUserAreasWarning for HKCU with admin install mode
- Unused variable 'DOCKERPATH' hint

---

## Lessons Learned

1. **Inno Setup File Handling:** Source files must exist at compile time. Use `#ifexist` preprocessor for optional files.

2. **Inno Setup Flags:** The `skipifdoesntexist` flag doesn't exist. Always consult Inno Setup documentation for valid flags.

3. **Pascal Type Safety:** Inno Setup's Pascal script is strictly typed. ShellExec requires an Integer variable for error codes, not Boolean.

4. **CI Testing:** Windows-specific installers can fail in ways not caught by local development on other platforms.

---

## Related Commits

| Commit | Message |
|--------|---------|
| `1975832` | fix(ci): Comment out missing icon.ico reference in Inno Setup |
| `6ed3783` | fix(ci): Make Docker tar and scripts optional in Inno Setup |
| `43c74a6` | fix(ci): Use #ifexist preprocessor for optional Inno Setup files |
| `f2f8a82` | fix(ci): Fix ShellExec type mismatch in InitializeSetup() |
