# T003.2 - TATR Data Preparation (COCO Format) Implementation Log

**Subtask**: 3.2 - Implement TATR data preparation (COCO format, normalized boxes)
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Implement the TATR (Table Transformer) data preparation pipeline that converts synthetic invoice PDFs and JSON labels into COCO format for table detection training.

---

## Files Modified/Created

### Modified

- `scripts/prepare_datasets.py` - Added COCO format utilities and full format_tatr() implementation

### Created

- `tests/test_task003_2_tatr_format.py` - 37 tests

---

## Implementation Details

### New Functions Added

| Function | Purpose |
|----------|---------|
| `normalize_bbox()` | Normalize bboxes to 0-1000 scale |
| `create_coco_dataset()` | Create empty COCO structure |
| `add_image_to_coco()` | Add image entry to dataset |
| `add_annotation_to_coco()` | Add annotation with bbox and area |
| `extract_table_bbox()` | Get bbox encompassing all line items |
| `extract_row_bboxes()` | Get individual row bboxes |
| `pdf_to_image()` | Convert PDF to PIL Image |

---

## COCO Format Structure

```json
{
  "images": [
    {
      "id": 1,
      "file_name": "invoice_00001.png",
      "width": 1275,
      "height": 1650
    }
  ],
  "annotations": [
    {
      "id": 1,
      "image_id": 1,
      "category_id": 1,
      "bbox": [50, 300, 900, 400],
      "area": 360000,
      "iscrowd": 0
    }
  ],
  "categories": [
    {"id": 1, "name": "table", "supercategory": "document"},
    {"id": 2, "name": "table_row", "supercategory": "table"}
  ]
}
```

---

## Normalization

Bounding boxes are normalized to 0-1000 scale for consistency:

```python
def normalize_bbox(bbox, width, height):
    return [
        int(bbox[0] * 1000 / width),
        int(bbox[1] * 1000 / height),
        int(bbox[2] * 1000 / width),
        int(bbox[3] * 1000 / height)
    ]
```

Example:
- Original: `[100, 200, 50, 30]` on 1000x800 image
- Normalized: `[100, 250, 50, 37]` (0-1000 scale)

---

## Pipeline Flow

```
Input                     Processing                  Output
─────                     ──────────                  ──────
data/synthetic/
├── pdfs/
│   └── invoice_00001.pdf ─→ pdf_to_image() ─────→ tatr/images/
│                                                    └── invoice_00001.png
└── labels/
    └── invoice_00001.json ─→ extract_table_bbox()
                            ─→ extract_row_bboxes() ─→ tatr/annotations.json
```

---

## Dependencies

- **pdf2image**: PDF to image conversion
- **Pillow (PIL)**: Image processing
- **poppler-utils**: Backend for pdf2image

---

## Usage

```bash
# Convert to TATR format
python scripts/prepare_datasets.py --format tatr

# Full command
python scripts/prepare_datasets.py \
    --input-dir data/synthetic \
    --output-dir data/formatted \
    --format tatr
```

---

## Output Structure

```
data/formatted/tatr/
├── images/
│   ├── invoice_00000.png
│   ├── invoice_00001.png
│   └── ...
└── annotations.json
```

---

## Categories

| ID | Name | Description |
|----|------|-------------|
| 1 | table | Encompasses all line items |
| 2 | table_row | Individual line item row |

---

## Test Summary

| Category | Tests |
|----------|-------|
| Module Functions Exist | 4 |
| Normalize BBox | 4 |
| Create COCO Dataset | 7 |
| Add Image to COCO | 3 |
| Add Annotation to COCO | 4 |
| Extract Table BBox | 3 |
| Extract Row BBoxes | 3 |
| PDF to Image | 2 |
| Integration Tests | 7 |
| **Total** | **37** |

---

## Error Handling

- Missing PDFs: Logged and skipped
- Missing poppler: Returns error status with message
- Invalid ground truth: Skipped with error count

---

## Performance

- PDF conversion: ~0.5s per page at 150 DPI
- 100 invoices: ~60 seconds total

---

## Next Steps

- **Subtask 3.3**: Implement LayoutLMv3 data preparation (BIO tags)
- **Subtask 3.4**: Create train/val/test splits
- **Subtask 3.5**: Validate Hugging Face compatibility
