# T015.2 - Fallback Identifiers Implementation Log

**Subtask**: 15.2 - Add fallback identifiers (MAC address)
**Date**: 2025-12-09
**Status**: Completed

---

## Objective

Extend the hardware fingerprint system with fallback identifiers (MAC address, disk serial, BIOS serial) to ensure license validation works even when primary identifiers (UUID, Machine GUID) are unavailable.

---

## Files Created

### Main Service

- `desktop-app/src/services/FallbackIdentifiers.ts` - Fallback identifiers service (~500 lines)

### Test File

- `desktop-app/tests/fallback-identifiers.test.ts` - 60 tests with local implementations

---

## Implementation Details

### Data Types

```typescript
interface FallbackIdentifiers {
  primaryMac: string | null;      // Primary physical MAC
  allMacs: string[];              // All physical MACs
  diskSerial: string | null;      // Primary disk serial
  biosSerial: string | null;      // BIOS serial number
  motherboardSerial: string | null; // Motherboard serial
}

interface EnhancedHardwareIdentifiers extends HardwareIdentifiers {
  fallback: FallbackIdentifiers;
}

interface EnhancedFingerprintResult extends FingerprintResult {
  identifiers: EnhancedHardwareIdentifiers;
  fallbackUsed: boolean;       // True if primary IDs unavailable
  strengthScore: number;       // 0-100 reliability score
}

type IdentifierPriority = 'uuid' | 'machineId' | 'mac' | 'disk' | 'bios';

interface IdentifierStrength {
  identifier: IdentifierPriority;
  available: boolean;
  score: number;
}
```

### MAC Address Functions

| Function | Description |
|----------|-------------|
| `isValidMacAddress(mac)` | Validate MAC format (XX:XX:XX:XX:XX:XX) |
| `normalizeMacAddress(mac)` | Normalize to uppercase with colons |
| `isVirtualMacAddress(mac)` | Check locally administered bit |
| `isKnownVirtualVendor(mac)` | Check against VM vendor OUIs |

### Network Interface Functions

| Function | Description |
|----------|-------------|
| `getNetworkInterfaces()` | Get all interfaces from OS |
| `filterPhysicalInterfaces(interfaces)` | Filter to physical only |
| `getPrimaryMacAddress(interfaces)` | Get best MAC (prefer Ethernet) |
| `getAllMacAddresses(interfaces)` | Get all physical MACs |

### Serial Number Functions

| Function | Description |
|----------|-------------|
| `getDiskSerial()` | Get disk serial (platform-specific) |
| `getBiosSerial()` | Get BIOS serial |
| `getMotherboardSerial()` | Get baseboard serial |
| `parseWmicDiskSerial(output)` | Parse WMIC disk output |
| `parseWmicBiosSerial(output)` | Parse WMIC BIOS output |
| `parseWmicBaseboardSerial(output)` | Parse WMIC baseboard output |

### Strength Functions

| Function | Description |
|----------|-------------|
| `getIdentifierStrengths(hasUuid, hasMachineId, fallback)` | Get all strengths |
| `calculateTotalStrength(...)` | Calculate total score |
| `getBestIdentifier(uuid, machineId, fallback)` | Get best available ID |

---

## Virtual MAC Detection

### Known Virtual Vendor OUIs

| OUI | Vendor |
|-----|--------|
| 00:50:56 | VMware |
| 00:0C:29 | VMware |
| 08:00:27 | VirtualBox |
| 52:54:00 | QEMU/KVM |
| 00:16:3E | Xen |
| 00:15:5D | Hyper-V |
| 00:03:FF | Microsoft Virtual PC |

### Locally Administered Bit

```typescript
function isVirtualMacAddress(mac: string): boolean {
  const firstByte = parseInt(normalized.substring(0, 2), 16);
  // Second least significant bit = locally administered
  return (firstByte & 0x02) !== 0;
}
```

---

## Platform-Specific Collection

### Windows

```cmd
# Disk Serial
wmic diskdrive get serialnumber

# BIOS Serial
wmic bios get serialnumber

# Motherboard Serial
wmic baseboard get serialnumber
```

### Linux

```bash
# Disk Serial
lsblk -dno SERIAL /dev/sda

# BIOS Serial
cat /sys/class/dmi/id/product_serial

# Motherboard Serial
cat /sys/class/dmi/id/board_serial
```

### macOS

```bash
# Disk Serial
system_profiler SPSerialATADataType | grep "Serial Number"

# Hardware Serial
system_profiler SPHardwareDataType | grep "Serial Number"
```

---

## Identifier Priority

| Priority | Identifier | Score | Description |
|----------|------------|-------|-------------|
| 1 | UUID | 40 | SMBIOS/DMI UUID |
| 2 | Machine ID | 35 | Windows Machine GUID |
| 3 | MAC | 25 | Primary physical MAC |
| 4 | Disk | 20 | Disk serial number |
| 5 | BIOS | 15 | BIOS serial number |

---

## Service Class

```typescript
class EnhancedFingerprintService {
  constructor(config?: EnhancedFingerprintConfig);

  // Core methods
  async initialize(): Promise<EnhancedFingerprintResult>;
  async getFingerprint(): Promise<EnhancedFingerprintResult>;
  async getFingerprintString(): Promise<string>;

  // Fallback methods
  async getFallbackIdentifiers(): Promise<FallbackIdentifiers>;
  async getBestIdentifier(): Promise<string | null>;
  async isFallbackUsed(): Promise<boolean>;

  // Strength
  async getStrength(): Promise<number>;
  async getIdentifiersSummary(): Promise<IdentifierStrength[]>;

  // Refresh
  async refresh(): Promise<EnhancedFingerprintResult>;
}
```

---

## Interface Filtering Logic

```typescript
function filterPhysicalInterfaces(interfaces) {
  return interfaces.filter(iface => {
    // Skip internal (loopback)
    if (iface.internal) return false;

    // Skip zero MAC
    if (iface.mac === '00:00:00:00:00:00') return false;

    // Skip locally administered (virtual)
    if (isVirtualMacAddress(iface.mac)) return false;

    // Skip known VM vendors
    if (isKnownVirtualVendor(iface.mac)) return false;

    return true;
  });
}
```

---

## Ethernet Priority

```typescript
function getPrimaryMacAddress(interfaces) {
  const physical = filterPhysicalInterfaces(interfaces);

  // Prefer Ethernet over WiFi
  const ethernet = physical.find(iface =>
    iface.name.includes('eth') ||
    iface.name.includes('en0') ||
    iface.name.includes('ethernet')
  );

  if (ethernet) return ethernet.mac;

  // Fallback to first physical
  return physical[0]?.mac || null;
}
```

---

## TDD Process

1. **Tests Written First**: 60 tests with local implementations
2. **Implementation**: FallbackIdentifiers.ts service created
3. **Validation**: All tests passing
4. **Full Suite**: All 679 tests passing

---

## Test Summary

| Category | Tests |
|----------|-------|
| MAC Address Validation | 11 |
| Virtual MAC Detection | 7 |
| Network Interface Filtering | 10 |
| Serial Number Parsing | 8 |
| Fallback Identifiers Management | 10 |
| Identifier Strength Calculation | 5 |
| Best Identifier Selection | 5 |
| Fallback Component Generation | 3 |
| Enhanced Identifiers | 1 |
| **Total** | **60** |

---

## Usage Examples

### Basic Usage

```typescript
import { EnhancedFingerprintService } from './services/FallbackIdentifiers';

const service = new EnhancedFingerprintService();

// Get fingerprint with fallback support
const result = await service.getFingerprint();

// Check if fallback was used
if (result.fallbackUsed) {
  console.warn('Primary identifiers unavailable, using fallback');
}

// Get strength score
console.log(`Fingerprint strength: ${result.strengthScore}%`);
```

### With Configuration

```typescript
const service = new EnhancedFingerprintService({
  includeMac: true,           // Include MAC in fingerprint
  includeDiskSerial: true,    // Include disk serial
  includeBiosSerial: false,   // Exclude BIOS serial
  hashAlgorithm: 'sha256',
});
```

### Get Best Identifier

```typescript
const best = await service.getBestIdentifier();
// Returns: UUID > Machine ID > MAC > Disk Serial > BIOS Serial

const summary = await service.getIdentifiersSummary();
// Returns array of { identifier, available, score }
```

---

## Next Steps

- Subtask 15.3: Set up cloud licensing server (Lambda/Firebase)
- Subtask 15.4: Create license validation endpoint

