# T003.1 - Prepare Datasets Script Implementation Log

**Subtask**: 3.1 - Create prepare_datasets.py script
**Date**: 2025-12-04
**Status**: Completed

---

## Objective

Create the main data preparation script that converts synthetic invoice PDFs and JSON labels into formats required by Hugging Face Transformers for training TATR (table detection) and LayoutLMv3 (token classification) models.

---

## Files Created

### Main Module

- `scripts/prepare_datasets.py` - Main data preparation script with CLI

### Test File

- `tests/test_task003_1_prepare_datasets.py` - 31 tests

---

## Implementation Details

### Core Functions

| Function | Purpose |
|----------|---------|
| `create_argument_parser()` | Configure CLI arguments |
| `validate_input_dir()` | Validate input directory exists |
| `prepare_output_dir()` | Create output directories |
| `format_tatr()` | Convert to COCO format (stub for 3.2) |
| `format_layoutlm()` | Convert to BIO format (stub for 3.3) |
| `main()` | Main entry point |

---

## CLI Arguments

| Argument | Short | Default | Description |
|----------|-------|---------|-------------|
| `--input-dir` | `-i` | `../data/synthetic` | Input directory with PDFs/labels |
| `--output-dir` | `-o` | `../data/formatted` | Output directory for formatted data |
| `--format` | `-f` | `both` | Output format: tatr, layoutlm, or both |
| `--seed` | `-s` | `42` | Random seed for reproducibility |

---

## Usage

```bash
# Format for both TATR and LayoutLM (default)
python scripts/prepare_datasets.py

# Format only for TATR
python scripts/prepare_datasets.py --format tatr

# Format only for LayoutLM
python scripts/prepare_datasets.py --format layoutlm

# Custom directories
python scripts/prepare_datasets.py \
    --input-dir data/synthetic \
    --output-dir data/formatted \
    --format both \
    --seed 42
```

---

## Architecture

```
prepare_datasets.py
├── create_argument_parser()    # CLI configuration
├── validate_input_dir()        # Input validation
├── prepare_output_dir()        # Output setup
├── format_tatr()               # COCO format (stub → 3.2)
├── format_layoutlm()           # BIO format (stub → 3.3)
└── main()                      # Entry point
```

---

## Output Format (Planned)

### TATR (Task 3.2)
```
data/formatted/tatr/
├── train/
│   ├── images/
│   └── annotations.json  (COCO format)
├── val/
└── test/
```

### LayoutLM (Task 3.3)
```
data/formatted/layoutlm/
├── train/
│   └── *.json  (BIO-tagged tokens)
├── val/
└── test/
```

---

## Format Functions (Stubs)

The `format_tatr()` and `format_layoutlm()` functions are currently stubs that:
- Create the appropriate output directories
- Count available input files
- Return statistics dict with status

Full implementation will be completed in:
- **Subtask 3.2**: TATR COCO format conversion
- **Subtask 3.3**: LayoutLM BIO tagging

---

## Test Summary

| Category | Tests |
|----------|-------|
| Module Exists | 5 |
| Argument Parser | 11 |
| Format Validation | 1 |
| Directory Handling | 2 |
| Format Functions | 2 |
| Main Function | 4 |
| Input Validation | 4 |
| Seed Option | 2 |
| **Total** | **31** |

---

## TDD Process

1. **Tests Written First**: 31 tests defined requirements
2. **Implementation**: Script created to pass all tests
3. **Validation**: All 31 tests passing in 0.37s

---

## Dependencies

- Standard library only: `argparse`, `json`, `os`, `sys`, `pathlib`
- No external dependencies for this subtask

---

## Next Steps

- **Subtask 3.2**: Implement TATR data preparation (COCO format)
- **Subtask 3.3**: Implement LayoutLMv3 data preparation (BIO tags)
- **Subtask 3.4**: Create train/val/test splits
- **Subtask 3.5**: Validate Hugging Face compatibility
