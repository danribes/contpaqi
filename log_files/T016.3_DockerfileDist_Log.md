# Subtask 16.3: Modify Dockerfile to use obfuscated dist/

## Implementation Log

### Date: 2025-12-09

### Objective
Create a production Dockerfile that uses the obfuscated code from dist/ directory instead of the plain source code from src/.

---

## Files Created

### 1. `mcp-container/Dockerfile.prod` (~90 lines)
Production Dockerfile using obfuscated code.

**Key Differences from Development Dockerfile:**

| Feature | Dockerfile (dev) | Dockerfile.prod (prod) |
|---------|------------------|------------------------|
| Source | `COPY src/` | `COPY dist/` |
| Version | Hardcoded 3.9 | ARG PYTHON_VERSION=3.9 |
| Labels | None | Build metadata labels |
| Env vars | None | PYTHONUNBUFFERED, APP_ENV |

### 2. `tests/test_task016_3_dockerfile_dist.py` (~350 lines)
31 unit tests for Dockerfile configuration.

**Test Categories:**
- DockerfileExistence (2 tests)
- DevelopmentDockerfile (6 tests)
- ProductionDockerfile (10 tests)
- DockerfileStructure (4 tests)
- MakefileDockerIntegration (3 tests)
- RuntimeConsistency (3 tests)
- DockerfileSecurity (3 tests)

---

## Production Dockerfile Structure

### Build Arguments
```dockerfile
ARG PYTHON_VERSION=3.9
ARG APP_VERSION=1.0.0
```

Allows overriding at build time:
```bash
docker build --build-arg PYTHON_VERSION=3.10 -f Dockerfile.prod .
```

### Multi-Stage Build
```
Stage 1: builder
├── Python 3.9 slim base
├── Build dependencies
└── Create pip wheels

Stage 2: runtime
├── Python 3.9 slim base
├── Runtime dependencies (tesseract, poppler)
├── Install wheels from builder
├── Copy obfuscated code (dist/ → src/)
├── Non-root user
└── Run uvicorn
```

### Labels
```dockerfile
LABEL maintainer="ContPAQi AI Bridge Team"
LABEL version="${APP_VERSION}"
LABEL description="ContPAQi AI Bridge - Invoice Processing Engine (Obfuscated)"
LABEL build.type="production"
LABEL build.obfuscated="true"
```

### Security Features
- Non-root user (`appuser`)
- Python optimization (`PYTHONDONTWRITEBYTECODE=1`)
- Clean apt cache after install
- Specific Python version (not `:latest`)

---

## Key Implementation Details

### Copying Obfuscated Code
```dockerfile
# Copy obfuscated application code from dist/
# The dist/ directory is created by 'make obfuscate' using PyArmor
COPY dist/ ./src/
```

The obfuscated code is copied to `./src/` in the container to maintain the same module structure (`src.main:app`).

### Environment Variables
```dockerfile
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV APP_ENV=production
```

### Health Check
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1
```

---

## Build Commands

### Production Build (with obfuscation)
```bash
cd mcp-container
make build  # Runs: obfuscate → docker-build
```

### Development Build (no obfuscation)
```bash
cd mcp-container
make build-dev  # Uses Dockerfile, not Dockerfile.prod
```

### Direct Docker Build
```bash
# After running 'make obfuscate'
docker build -f Dockerfile.prod -t contpaqi-mcp:latest .
```

---

## Runtime Consistency

Both Dockerfiles install the same dependencies:

| Dependency | Purpose |
|------------|---------|
| tesseract-ocr | OCR engine |
| tesseract-ocr-spa | Spanish language support |
| poppler-utils | PDF processing |
| libgl1-mesa-glx | OpenCV support |
| libglib2.0-0 | Glib library |
| curl | Health check |

---

## Test Results

```
tests/test_task016_3_dockerfile_dist.py
============================== 31 passed in 0.10s ==============================
```

All tests passing:
- Existence tests (2)
- Development Dockerfile tests (6)
- Production Dockerfile tests (10)
- Structure tests (4)
- Makefile integration tests (3)
- Runtime consistency tests (3)
- Security tests (3)

---

## Build Pipeline Integration

```
┌─────────────────┐
│  Source Code    │
│  (src/)         │
└────────┬────────┘
         │ make obfuscate
         ▼
┌─────────────────┐
│  Obfuscated     │
│  (dist/)        │
└────────┬────────┘
         │ docker build -f Dockerfile.prod
         ▼
┌─────────────────┐
│  Container      │
│  (src/ inside)  │
└─────────────────┘
```

---

## Summary

Created production Dockerfile (`Dockerfile.prod`) that:
- Uses obfuscated code from `dist/` directory
- Maintains same runtime dependencies as development
- Adds build labels for identification
- Uses ARG for version flexibility
- Runs as non-root user for security
- Integrates with Makefile build system
