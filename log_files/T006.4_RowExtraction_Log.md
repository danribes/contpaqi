# T006.4 Row Extraction - Implementation Log

## Subtask Overview
**Task**: 6 - TATR Model Integration
**Subtask**: 6.4 - Return bounding boxes for detected rows
**Status**: Completed
**Date**: 2025-12-07
**Tests**: 15 passing

## Description
Implemented methods to extract and sort table rows and table bounds.

## Implementation Details

### get_table_rows Method
```python
def get_table_rows(self, image: Any, threshold: float = None) -> List[Dict]:
    """Get sorted row bounding boxes from detected tables."""
    detections = self.detect(image, threshold)

    # Filter for rows only
    rows = [d for d in detections if d.label == 'table row']

    # Sort by y-coordinate (top to bottom)
    rows.sort(key=lambda r: r.bbox[1])

    return [
        {
            'bbox': row.bbox,
            'confidence': row.confidence,
            'index': i
        }
        for i, row in enumerate(rows)
    ]
```

### get_table_bounds Method
```python
def get_table_bounds(self, image: Any, threshold: float = None) -> Optional[Dict]:
    """Get the bounding box of the main table."""
    detections = self.detect(image, threshold)

    # Filter for tables only
    tables = [d for d in detections if d.label == 'table']

    if not tables:
        return None

    # Return highest confidence table
    best_table = max(tables, key=lambda t: t.confidence)
    return {
        'bbox': best_table.bbox,
        'confidence': best_table.confidence
    }
```

### Row Sorting
- Rows sorted by `bbox[1]` (y1 coordinate)
- Top-to-bottom order for invoice line items
- Index assigned after sorting

### Return Format
```python
# get_table_rows returns:
[
    {'bbox': (10, 50, 790, 80), 'confidence': 0.95, 'index': 0},
    {'bbox': (10, 90, 790, 120), 'confidence': 0.92, 'index': 1},
]

# get_table_bounds returns:
{'bbox': (0, 0, 800, 600), 'confidence': 0.98}
# or None if no table found
```

## Test Summary

| Test Class | Tests |
|------------|-------|
| TestGetTableRowsBasic | 2 |
| TestGetTableRowsWithMocks | 5 |
| TestGetTableBoundsBasic | 2 |
| TestGetTableBoundsWithMocks | 5 |
| TestGetTableRowsDictStructure | 3 |
| TestThresholdPropagation | 2 |
| TestEmptyDetections | 2 |
