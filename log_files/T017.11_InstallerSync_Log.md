# Automated Installer Sync - Implementation Log

**Task**: Automated synchronization of downloadable installer between contpaqi and contpaqi-website
**Status**: Completed
**Date**: 2025-12-11
**Author**: Claude Code

---

## Summary

Implemented an automated system to synchronize the downloadable installer file between the `contpaqi` repository and the `contpaqi-website` repository. When a new version is released in contpaqi, the website automatically updates with the latest download information.

---

## Implementation Details

### 1. Build and Release Workflow (`.github/workflows/build-installer.yml`)

Created a comprehensive GitHub Actions workflow that:

**Build Jobs:**
- Sets up Node.js, .NET SDK, and Python environments
- Builds Electron desktop app (`npm run electron:build`)
- Builds Windows Bridge (.NET) with self-contained publish
- Builds and saves Docker image as tar file
- Compiles Inno Setup installer

**Release Jobs:**
- Generates SHA256 and MD5 checksums
- Creates `checksums.json` with file metadata
- Creates GitHub release with version tag
- Uploads installer and checksums as release assets

**Website Update:**
- Triggers `repository_dispatch` event to contpaqi-website
- Passes version, download URL, and release URL in payload

### 2. Website Update Workflow Template (`docs/website-integration/update-download-workflow.yml`)

Created a template workflow for contpaqi-website that:

- Listens for `repository_dispatch` events
- Fetches release information and checksums
- Updates `public/download-info.json` with latest version
- Commits and pushes changes automatically
- Optionally triggers Vercel deployment

### 3. React Download Components (`docs/website-integration/DownloadButton.tsx`)

Created reusable React components:

| Component | Description |
|-----------|-------------|
| `useDownloadInfo()` | Hook to fetch download information from JSON |
| `DownloadButton` | Simple download button with version info |
| `DownloadCard` | Full card with requirements and checksums |

### 4. Documentation (`docs/website-integration/README.md`)

Comprehensive setup guide including:
- Architecture diagram
- Step-by-step setup instructions
- Secret configuration
- Usage examples
- Troubleshooting guide

---

## Files Created

| File | Location | Purpose |
|------|----------|---------|
| `build-installer.yml` | `.github/workflows/` | Main CI/CD workflow |
| `update-download-workflow.yml` | `docs/website-integration/` | Template for website repo |
| `DownloadButton.tsx` | `docs/website-integration/` | React components |
| `README.md` | `docs/website-integration/` | Setup documentation |

---

## Workflow Triggers

The build workflow triggers on:

1. **Git Tags**: Push of `v*` tags (e.g., `v1.0.0`)
2. **Push to main**: Changes to `installer/`, `desktop-app/`, `windows-bridge/`, or `mcp-container/`
3. **Manual dispatch**: Via GitHub Actions UI with version input

---

## Data Flow

```
1. Developer creates tag: git tag v1.0.1 && git push origin v1.0.1
2. build-installer.yml triggered
3. Builds: Electron → .NET → Docker → Inno Setup
4. Creates GitHub release with:
   - ContPAQi-AI-Bridge-Setup-1.0.1.exe
   - checksums.json
   - checksums.txt
5. Sends repository_dispatch to contpaqi-website
6. Website workflow updates download-info.json
7. Website auto-deploys with new version
```

---

## Configuration Required

### contpaqi Repository

| Secret | Value |
|--------|-------|
| `WEBSITE_REPO_TOKEN` | Personal Access Token with `repo` and `workflow` scopes |

### contpaqi-website Repository

| File | Purpose |
|------|---------|
| `.github/workflows/update-download.yml` | Workflow to receive updates |
| `public/download-info.json` | Download information JSON |
| `src/components/DownloadButton.tsx` | UI components |

---

## Technical Notes

### Cross-Repository Communication

Used `peter-evans/repository-dispatch@v2` action to trigger workflows across repositories. This requires a Personal Access Token (PAT) stored as a secret.

### Checksum Generation

```powershell
$sha256 = (Get-FileHash $installer -Algorithm SHA256).Hash
$md5 = (Get-FileHash $installer -Algorithm MD5).Hash
```

### JSON Structure for Download Info

```json
{
  "version": "1.0.0",
  "downloadUrl": "https://github.com/.../releases/download/v1.0.0/...",
  "releaseUrl": "https://github.com/.../releases/tag/v1.0.0",
  "sha256": "abc123...",
  "fileSize": 123456789,
  "updatedAt": "2025-12-11T00:00:00Z",
  "requirements": {
    "os": "Windows 10/11 (64-bit)",
    "docker": "Docker Desktop",
    "dotnet": ".NET 6.0 Runtime"
  }
}
```

---

## Security Considerations

1. **Token Scope**: PAT uses minimal required scopes (`repo`, `workflow`)
2. **Checksum Verification**: SHA256 provided for download verification
3. **Signed URLs**: GitHub releases use HTTPS
4. **No Secrets in Payload**: Only public information passed between repos

---

## Future Improvements

- Add code signing for installer (SignTool)
- Add automatic changelog generation
- Add Slack/Discord notifications on release
- Add rollback mechanism for failed releases
