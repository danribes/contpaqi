# T018.7 - Language Persistence Implementation Log

**Subtask**: 18.7 - Persist language preference across sessions
**Date**: 2025-12-12
**Status**: Completed

---

## Objective

Implement language preference persistence across sessions by reading from and writing to the Windows Registry, integrating with the Electron main process, and providing IPC handlers for renderer communication.

---

## Files Created/Modified

### New Files

1. **`desktop-app/electron/language-manager.ts`**
   - Language preference manager for Electron main process
   - Windows Registry read/write operations
   - System locale detection
   - IPC handlers for renderer communication

2. **`desktop-app/tests/language-manager.test.ts`**
   - 71 comprehensive tests for language persistence

### Modified Files

3. **`desktop-app/electron/preload.ts`**
   - Added language API methods to electronAPI
   - Added TypeScript type definitions

4. **`desktop-app/electron/main.ts`**
   - Added import for language-manager
   - Registered language IPC handlers on app ready

---

## Implementation Details

### Language Priority Resolution

The language manager resolves the user's language preference in this order:

1. **localStorage** (user preference from renderer)
2. **Windows Registry** (installer preference)
3. **System Locale** (OS language setting)
4. **Default** (English)

### Registry Configuration

```typescript
REGISTRY_CONFIG = {
  KEY: 'HKCU\\Software\\ContPAQi\\AIBridge',
  VALUE_NAME: 'Language',
  VALUE_TYPE: 'REG_SZ',
}
```

### IPC Channels

| Channel | Purpose |
|---------|---------|
| `language:getFromRegistry` | Read language from Windows Registry |
| `language:setToRegistry` | Write language to Windows Registry |
| `language:getSystemLocale` | Get system locale from OS |

### Electron API (exposed to renderer)

```typescript
electronAPI: {
  getRegistryLanguage: () => Promise<string | null>;
  setRegistryLanguage: (lang: string) => Promise<{ success: boolean; error?: string }>;
  getSystemLocale: () => Promise<string>;
}
```

---

## Key Functions

### language-manager.ts

| Function | Description |
|----------|-------------|
| `isSupportedLanguage(lang)` | Check if language code is valid |
| `normalizeLanguageCode(locale)` | Convert locale to supported language |
| `readRegistry(key, value)` | Read from Windows Registry |
| `writeRegistry(key, value, data)` | Write to Windows Registry |
| `getLanguageFromRegistry()` | Get saved language preference |
| `setLanguageToRegistry(lang)` | Save language preference |
| `getSystemLocale()` | Get OS locale via Electron |
| `getSystemLanguage()` | Get normalized OS language |
| `resolveLanguagePreference()` | Resolve language from all sources |
| `registerLanguageIpcHandlers()` | Register IPC handlers |

---

## Windows Registry Integration

### Reading from Registry

```typescript
async function readRegistry(key: string, valueName: string): Promise<RegistryResult> {
  const command = `reg query "${key}" /v "${valueName}"`;
  const { stdout } = await execAsync(command);
  // Parse output to extract value
}
```

### Writing to Registry

```typescript
async function writeRegistry(key: string, valueName: string, value: string): Promise<RegistryResult> {
  const command = `reg add "${key}" /v "${valueName}" /t REG_SZ /d "${value}" /f`;
  await execAsync(command);
}
```

---

## Error Handling

### Registry Error Codes

| Code | Description |
|------|-------------|
| `KEY_NOT_FOUND` | Registry key does not exist |
| `VALUE_NOT_FOUND` | Registry value does not exist |
| `ACCESS_DENIED` | Permission denied to access registry |
| `INVALID_VALUE` | Value is not a valid language code |
| `WRITE_FAILED` | Failed to write to registry |
| `NOT_WINDOWS` | Registry operations not available on non-Windows |

### Graceful Fallback

The system gracefully falls back through the priority chain when:
- Registry key/value doesn't exist
- Registry access is denied
- Invalid language code is stored
- Running on non-Windows platform

---

## Integration with i18n

### Renderer Side (i18n/index.ts)

The existing `loadLanguageFromRegistry()` function now works with the new IPC handlers:

```typescript
export async function loadLanguageFromRegistry(): Promise<string | null> {
  const electronAPI = window.electronAPI;
  if (electronAPI?.getRegistryLanguage) {
    return await electronAPI.getRegistryLanguage();
  }
  return null;
}
```

### Initialization Flow

1. App starts
2. Main process registers IPC handlers
3. Renderer loads, i18next initializes
4. `initializeLanguagePreference()` checks localStorage
5. If no localStorage, calls `getRegistryLanguage()`
6. If no registry value, uses system locale
7. Falls back to 'en' if nothing found

---

## Platform Support

| Platform | Registry Available | Fallback |
|----------|-------------------|----------|
| Windows | ✅ Yes | N/A |
| macOS | ❌ No | System locale → Default |
| Linux | ❌ No | System locale → Default |

---

## Test Summary

| Category | Tests |
|----------|-------|
| Helper Functions | 14 |
| Registry Operations | 5 |
| Language Preference Resolution | 7 |
| IPC Handler Patterns | 7 |
| System Locale Detection | 8 |
| Electron API Pattern | 6 |
| Language Change Flow | 6 |
| Registry Key Structure | 3 |
| Error Handling | 7 |
| Integration Patterns | 3 |
| Platform Detection | 5 |
| **Total** | **71** |

---

## Related Tasks

- **Task 18.1**: Installer language selection
- **Task 18.2**: i18n framework setup
- **Task 18.6**: Language switcher component
