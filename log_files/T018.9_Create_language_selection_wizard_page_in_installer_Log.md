# Implementation Log - Subtask 18.9
## Create Language Selection Wizard Page in Installer

**Date:** 2025-12-12
**Status:** Completed

---

## Overview

This subtask implements the language selection wizard page in the Inno Setup installer. The page allows users to select their preferred application language (English or Spanish) during installation, with the selection saved to the Windows Registry for use by PowerShell scripts.

---

## Files Modified

### 1. installer/contpaqi-bridge.iss (Modified)
**Purpose:** Add language selection wizard page and fix registry path consistency.

**Changes:**
- Fixed `SaveLanguagePreference()` procedure to use `HKEY_CURRENT_USER` instead of `HKEY_LOCAL_MACHINE`
- Updated registry path from `SOFTWARE\{#MyAppPublisher}\{#MyAppName}` to `SOFTWARE\ContPAQi AI Bridge`
- Fixed `LoadLanguagePreference()` function with same HKCU path
- Updated `[Registry]` section to use HKCU for language preference

**Key Code (SaveLanguagePreference):**
```pascal
procedure SaveLanguagePreference();
var
  LanguageCode: String;
begin
  LanguageCode := GetSelectedLanguage();
  SelectedLanguageCode := LanguageCode;

  // Write to registry under user key (matches PowerShell LocalizedMessages.psm1)
  RegWriteStringValue(HKEY_CURRENT_USER,
    'SOFTWARE\ContPAQi AI Bridge',
    'Language',
    LanguageCode);
end;
```

### 2. desktop-app/tests/inno-setup-language-page.test.ts (New)
**Purpose:** Validate Inno Setup language selection page implementation.

**Test Coverage:**
- 39 tests across 10 test suites
- Validates page structure, functions, registry path, custom messages
- Ensures consistency with PowerShell LocalizedMessages.psm1

---

## Pre-existing Features Verified

The language selection wizard page was already implemented in the Inno Setup script with:

1. **LanguagePage Variable** - `TInputOptionWizardPage` for radio button selection
2. **Language Options** - English and Español with native text labels
3. **GetSelectedLanguage()** - Returns 'en' or 'es' based on selection
4. **SaveLanguagePreference()** - Saves to registry (path fixed)
5. **LoadLanguagePreference()** - Loads from registry (path fixed)
6. **Custom Messages** - Bilingual labels for page UI
7. **Language Detection** - Uses `ActiveLanguage` to set default

---

## Registry Path Alignment

### Before (Inconsistent)
- **Inno Setup**: `HKLM\SOFTWARE\ContPAQi AI Bridge\ContPAQi AI Bridge\Language`
- **PowerShell**: `HKCU:\SOFTWARE\ContPAQi AI Bridge\Language`

### After (Consistent)
- **Inno Setup**: `HKCU\SOFTWARE\ContPAQi AI Bridge\Language`
- **PowerShell**: `HKCU:\SOFTWARE\ContPAQi AI Bridge\Language`

---

## Language Selection Flow

1. User runs installer
2. After Welcome page, Language Selection page appears
3. User selects English or Español (radio buttons)
4. Default based on installer language (ActiveLanguage)
5. Selection saved to registry during `ssPostInstall`
6. PowerShell scripts read same registry path

---

## Custom Messages

| Key | English | Spanish |
|-----|---------|---------|
| SelectLanguage | Select Installation Language | Seleccione el Idioma de Instalación |
| AppLanguage | Application Language | Idioma de la Aplicación |
| LanguageSelectionPrompt | Select the language for the application interface: | Seleccione el idioma para la interfaz de la aplicación: |
| LanguageEnglish | English | Inglés |
| LanguageSpanish | Spanish | Español |
| LanguageNote | This setting can be changed later... | Esta configuración se puede cambiar más tarde... |

---

## Testing Summary

- **Test File:** `desktop-app/tests/inno-setup-language-page.test.ts`
- **Total Tests:** 39 passed
- **Test Suites:** 10 categories
- **Duration:** ~3.3s

---

## CI/CD Fixes Required

After merging the initial implementation, two CI build failures occurred that required additional fixes:

### CI Fix #1: Missing appsettings.json

**Error:**
```
Cannot find path 'windows-bridge\src\ContpaqiBridge\appsettings.json' because it does not exist.
```

**Root Cause:** The Windows Bridge .NET project was missing the standard ASP.NET Core configuration files.

**Solution:**
1. Created `windows-bridge/src/ContpaqiBridge/appsettings.json`:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "localhost",
  "ContpaqiBridge": {
    "Port": 5000,
    "EnableSwagger": false,
    "JobQueue": {
      "MaxConcurrentJobs": 5,
      "JobTimeoutSeconds": 300
    }
  }
}
```

2. Created `windows-bridge/src/ContpaqiBridge/appsettings.Production.json`

3. Updated `ContpaqiBridge.csproj` to ensure config files are copied to publish output:
```xml
<ItemGroup>
  <Content Update="appsettings.json">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </Content>
  <Content Update="appsettings.*.json">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </Content>
</ItemGroup>
```

4. Updated workflow to copy config from publish output instead of source directory

### CI Fix #2: PowerShell vs Bash Shell Issue

**Error:**
```
Could not find a part of the path 'D:\dev\null'.
```

**Root Cause:** The "Prepare installer distribution" step was running in PowerShell (default on Windows) instead of bash. PowerShell doesn't understand Unix redirections like `2>/dev/null`.

**Solution:** Added `shell: bash` to the workflow step:
```yaml
- name: Prepare installer distribution
  run: |
    mkdir -p installer/dist/config
    # ... commands using 2>/dev/null ...
  shell: bash  # <-- Added this line
```

---

## Files Created/Modified (Complete List)

| File | Action | Purpose |
|------|--------|---------|
| `installer/contpaqi-bridge.iss` | Modified | Fixed registry path (HKLM → HKCU) |
| `desktop-app/tests/inno-setup-language-page.test.ts` | Created | 39 tests for language page |
| `windows-bridge/src/ContpaqiBridge/appsettings.json` | Created | Default app configuration |
| `windows-bridge/src/ContpaqiBridge/appsettings.Production.json` | Created | Production configuration |
| `windows-bridge/src/ContpaqiBridge/ContpaqiBridge.csproj` | Modified | Ensure config files in publish output |
| `.github/workflows/build-installer.yml` | Modified | Shell fix + config copy path |
| `log_files/T018.9_*.md` | Created | Implementation log |
| `log_tests/T018.9_*.md` | Created | Test log |
| `log_learn/T018.9_*.md` | Created | Learning guide |

---

## Commit Summary

### Commit 1: Main Implementation
```
feat(installer): Fix registry path for language selection wizard page (18.9)

- Update SaveLanguagePreference() to use HKCU instead of HKLM
- Fix registry path to 'SOFTWARE\ContPAQi AI Bridge' for consistency
- Update LoadLanguagePreference() with matching HKCU path
- Update [Registry] section for language preference under HKCU
- Add 39 tests validating language selection page structure
- Ensure registry path matches PowerShell LocalizedMessages.psm1
```

### Commit 2: CI Fix - Missing Config
```
fix(ci): Add missing appsettings.json for Windows Bridge

- Create appsettings.json with default configuration
- Create appsettings.Production.json for production settings
- Update .csproj to ensure appsettings are copied to publish output
- Update workflow to copy config from publish output directory
```

### Commit 3: CI Fix - Shell Issue
```
fix(ci): Add shell: bash to installer distribution step
```
