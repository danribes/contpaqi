# T008.7 Confidence Scoring - Implementation Log

## Overview
Implemented the `_calculate_confidence()` method that computes overall extraction confidence by combining OCR confidence, field extraction confidence, and required field presence.

## Files Modified
- `mcp-container/src/inference.py`
- `tests/test_task008_6_predict_method.py` (updated mock fields with confidence)

## Implementation Details

### _calculate_confidence() Method
```python
def _calculate_confidence(
    self,
    fields: Dict,
    ocr_confidences: List[float]
) -> float:
    """Calculate overall extraction confidence."""
    scores = []

    # OCR confidence (average of all word confidences)
    if ocr_confidences:
        ocr_avg = sum(ocr_confidences) / len(ocr_confidences)
        scores.append(ocr_avg)

    # Field extraction confidence (average of field confidences)
    for field in fields.values():
        if hasattr(field, 'confidence'):
            scores.append(field.confidence)

    # Required fields presence score
    required = ['RFC_EMISOR', 'RFC_RECEPTOR', 'TOTAL']
    present = sum(1 for r in required if r in fields)
    required_score = present / len(required)
    scores.append(required_score)

    return sum(scores) / len(scores) if scores else 0.0
```

### Updated predict() Method
```python
# Step 5: Calculate overall confidence
confidence = self._calculate_confidence(fields, ocr_conf)
```

## Confidence Factors

The method combines three factors:

| Factor | Weight | Description |
|--------|--------|-------------|
| OCR Confidence | 1/N | Average of all word confidence scores |
| Field Confidence | 1/N per field | Each extracted field's confidence |
| Required Fields | 1/N | Proportion of required fields present |

Where N = total number of scores added.

## Required Fields
- `RFC_EMISOR` - Issuer's tax ID
- `RFC_RECEPTOR` - Receiver's tax ID
- `TOTAL` - Invoice total amount

## Design Decisions

1. **Simple Average**: All factors weighted equally for simplicity
2. **Defensive Checks**: Uses `hasattr()` for field confidence access
3. **Always Add Required Score**: Even with empty fields, required presence is calculated
4. **Return 0.0 for Empty**: No scores means zero confidence

## Test Results
- 20 new tests for confidence scoring
- 152 total Task 8 tests passing
