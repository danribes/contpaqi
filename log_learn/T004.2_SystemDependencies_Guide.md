# T004.2 - System Dependencies Guide

**Subtask**: 4.2 Install system deps (tesseract-ocr, tesseract-ocr-spa, poppler)
**Date**: 2025-12-04

---

## Learning Objectives

After completing this guide, you will understand:
1. How OCR (Optical Character Recognition) works with Tesseract
2. Why specific system dependencies are needed for PDF processing
3. Docker best practices for package installation
4. How to optimize Docker image size while maintaining functionality

---

## 1. Understanding OCR with Tesseract

### What is Tesseract?

Tesseract is an open-source OCR engine originally developed by HP and now maintained by Google. It's considered one of the most accurate open-source OCR engines available.

### How Tesseract Works

```
                    ┌─────────────────┐
                    │   Input Image   │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Preprocessing  │
                    │ (binarization)  │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ Line Detection  │
                    │  & Segmentation │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Word & Char    │
                    │  Recognition    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   LSTM Neural   │
                    │    Network      │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │  Output Text    │
                    └─────────────────┘
```

### Tesseract Packages

| Package | Purpose |
|---------|---------|
| `tesseract-ocr` | Core engine with English support |
| `tesseract-ocr-spa` | Spanish language training data |
| `tesseract-ocr-[lang]` | Other language packs |

### Why Spanish Language Pack?

Mexican invoices contain Spanish text:
- Product descriptions: "Servicio de consultoría"
- Tax labels: "Subtotal", "IVA", "Total"
- RFC format: Tax identification numbers
- Dates: Spanish date formatting

---

## 2. PDF Processing Pipeline

### The Full Pipeline

```
PDF Document → Images → OCR → Structured Data

1. PDF Input     : Customer uploads invoice.pdf
2. PDF → Image   : Poppler converts PDF pages to PNG images
3. Image → Text  : Tesseract extracts text with bounding boxes
4. Text → Data   : AI models extract structured fields
```

### Why Convert PDF to Images?

1. **Consistency**: Images provide consistent input format
2. **Quality Control**: Can control DPI for better OCR
3. **Position Data**: Easier to get bounding box coordinates
4. **Model Input**: ML models expect image input

### Poppler Utilities

| Tool | Function |
|------|----------|
| `pdftoppm` | Convert PDF pages to images (PNG, JPEG, PPM) |
| `pdftotext` | Extract text from PDF directly |
| `pdfinfo` | Get PDF metadata |

Example usage:
```bash
# Convert first page of PDF to PNG at 300 DPI
pdftoppm -png -r 300 -f 1 -l 1 invoice.pdf output

# Result: output-1.png
```

---

## 3. Docker System Dependencies

### Dependency Categories

#### OCR Dependencies
```dockerfile
tesseract-ocr        # Core OCR engine
tesseract-ocr-spa    # Spanish language data
```

#### PDF Processing
```dockerfile
libpoppler-cpp-dev   # Poppler C++ development files
poppler-utils        # PDF command-line utilities
```

#### Image Processing
```dockerfile
libgl1-mesa-glx      # OpenGL runtime (for OpenCV)
libglib2.0-0         # GLib library
```

#### Health Checks
```dockerfile
curl                 # HTTP client for container health
```

### Why These Specific Libraries?

**libgl1-mesa-glx**:
- OpenCV uses OpenGL for some operations
- Required even for headless image processing
- Provides `libGL.so` shared library

**libglib2.0-0**:
- GTK/GLib dependency chain
- Used by many image processing libraries
- Required by poppler internally

---

## 4. Docker Best Practices for Dependencies

### Single RUN Command

**Bad** (creates multiple layers):
```dockerfile
RUN apt-get update
RUN apt-get install tesseract-ocr
RUN apt-get install poppler-utils
RUN rm -rf /var/lib/apt/lists/*
```

**Good** (single layer):
```dockerfile
RUN apt-get update && apt-get install -y --no-install-recommends \
    tesseract-ocr \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*
```

### Why This Matters

1. **Layer Size**: Each RUN creates a new layer
2. **Cache Efficiency**: Single command caches better
3. **Cleanup**: Must clean in same layer or cleanup doesn't reduce size

### The --no-install-recommends Flag

Without flag:
```bash
apt-get install tesseract-ocr
# Installs: tesseract-ocr + recommended packages (fonts, docs, etc.)
# Size: ~150MB
```

With flag:
```bash
apt-get install --no-install-recommends tesseract-ocr
# Installs: only tesseract-ocr and required dependencies
# Size: ~50MB
```

### Cleaning APT Cache

```dockerfile
rm -rf /var/lib/apt/lists/*
```

This removes:
- Package lists downloaded by `apt-get update`
- Typically saves 20-30MB per image

---

## 5. Multi-Stage Build Considerations

### Builder vs Runtime Dependencies

**Builder Stage**:
- `build-essential` - Compilers for building wheels
- Development headers
- Only temporary, not in final image

**Runtime Stage**:
- Only what's needed to run the application
- Tesseract, Poppler for actual processing
- No compilers or dev tools

### Visual Representation

```
┌────────────────────────────────────────────────────────────┐
│                    BUILDER STAGE                            │
│                                                             │
│  python:3.9-slim-bullseye                                  │
│  ├── build-essential (gcc, make, etc.)                     │
│  ├── Python dev headers                                    │
│  └── Creates wheel packages → /app/wheels                  │
│                                                             │
└──────────────────────────┬─────────────────────────────────┘
                           │
                           │ COPY --from=builder /app/wheels
                           ▼
┌────────────────────────────────────────────────────────────┐
│                    RUNTIME STAGE                            │
│                                                             │
│  python:3.9-slim-bullseye (fresh, clean)                   │
│  ├── tesseract-ocr, tesseract-ocr-spa (OCR)               │
│  ├── poppler-utils, libpoppler-cpp-dev (PDF)              │
│  ├── libgl1-mesa-glx, libglib2.0-0 (Image)                │
│  ├── curl (Health checks)                                  │
│  └── /wheels (pre-built Python packages)                   │
│                                                             │
│  Final image size: Much smaller than single-stage          │
└────────────────────────────────────────────────────────────┘
```

---

## 6. Verification Steps

### Why Verify?

1. **Early Failure**: Catch issues at build time, not runtime
2. **Documentation**: Shows expected behavior in Dockerfile
3. **Debugging**: Easier to troubleshoot build issues

### Tesseract Verification

```dockerfile
RUN tesseract --version && tesseract --list-langs
```

Expected output:
```
tesseract 4.1.1
 leptonica-1.79.0
  libgif 5.1.4 : libjpeg 6b (libjpeg-turbo 2.0.6) : libpng 1.6.37 : libtiff 4.2.0 : zlib 1.2.11 : libwebp 0.6.1 : libopenjp2 2.4.0
 Found AVX2
 Found AVX
 Found FMA
 Found SSE
List of available languages (3):
eng
osd
spa
```

---

## 7. Common Issues and Solutions

### Issue: Missing Language Pack

**Symptom**:
```
Error: Failed loading language 'spa'
```

**Solution**:
```dockerfile
RUN apt-get install -y tesseract-ocr-spa
```

### Issue: PDF Conversion Fails

**Symptom**:
```
pdf2image.exceptions.PDFInfoNotInstalledError
```

**Solution**:
```dockerfile
RUN apt-get install -y poppler-utils
```

### Issue: OpenCV Import Error

**Symptom**:
```
ImportError: libGL.so.1: cannot open shared object file
```

**Solution**:
```dockerfile
RUN apt-get install -y libgl1-mesa-glx
```

---

## 8. Performance Considerations

### OCR Performance Tips

1. **DPI Matters**: Use 300 DPI for best OCR accuracy
2. **Preprocessing**: Clean images improve results
3. **Language Hint**: Specify language for faster processing

```python
# Python example with pytesseract
import pytesseract

# Good - specify language
text = pytesseract.image_to_string(image, lang='spa')

# Better - specify OCR engine mode
text = pytesseract.image_to_string(image, lang='spa', config='--oem 3 --psm 6')
```

### OEM and PSM Modes

| OEM | Description |
|-----|-------------|
| 0 | Legacy engine only |
| 1 | Neural nets LSTM engine only |
| 2 | Legacy + LSTM engines |
| 3 | Default, based on availability |

| PSM | Description |
|-----|-------------|
| 3 | Fully automatic page segmentation |
| 6 | Assume single uniform block of text |
| 11 | Sparse text, find as much text as possible |

---

## 9. Summary

### Key Takeaways

1. **Tesseract** provides OCR capabilities with language-specific training data
2. **Poppler** enables PDF to image conversion for the processing pipeline
3. **OpenGL/GLib** libraries support image processing operations
4. **Single RUN** commands minimize Docker layers
5. **--no-install-recommends** keeps image size small
6. **Cache cleanup** must happen in same layer as install
7. **Verification** catches issues at build time

### Dockerfile Pattern for System Dependencies

```dockerfile
# Install runtime system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    package1 \
    package2 \
    package3 \
    && rm -rf /var/lib/apt/lists/*

# Verify installation
RUN command1 --version && command2 --version
```

---

## Further Reading

1. [Tesseract Documentation](https://tesseract-ocr.github.io/)
2. [Poppler PDF Library](https://poppler.freedesktop.org/)
3. [Docker Best Practices](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
4. [Multi-stage Builds](https://docs.docker.com/build/building/multi-stage/)
