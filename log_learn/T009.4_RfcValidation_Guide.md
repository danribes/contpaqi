# T009.4 RFC Validation - Learning Guide

## Overview
This guide explains how to validate Mexican RFC (Registro Federal de Contribuyentes) tax identification numbers.

## What is RFC?

RFC is Mexico's federal taxpayer registry number. Every business and individual that pays taxes in Mexico has an RFC.

### RFC Format
```
AAAA YYMMDD HHH
│    │      │
│    │      └── Homoclave (3 alphanumeric)
│    └── Date (6 digits)
└── Name initials (3-4 letters)
```

### Types of RFC
| Type | Letters | Length | Example |
|------|---------|--------|---------|
| Persona Moral (Company) | 3 | 12 | ABC010101XYZ |
| Persona Física (Individual) | 4 | 13 | ABCD010101XYZ |

## Regular Expression Pattern

### Building the Pattern
```python
import re

RFC_PATTERN = re.compile(
    r'^[A-ZÑ&]{3,4}'  # Name initials
    r'\d{6}'          # Date
    r'[A-Z0-9]{3}$'   # Homoclave
)
```

### Pattern Components
1. `^` - Start of string
2. `[A-ZÑ&]{3,4}` - 3-4 uppercase letters, Ñ, or &
3. `\d{6}` - Exactly 6 digits
4. `[A-Z0-9]{3}` - 3 alphanumeric characters
5. `$` - End of string

## Special Characters in RFC

### Ñ (eñe)
Mexican RFCs can contain the letter Ñ in the name portion.
```python
# Valid: XAÑX010101ABC
```

### & (ampersand)
Companies with "Y" in their name use &.
```python
# Valid: AB&010101ABC (for "A & B Company")
```

## Validation Function Pattern

### Return Tuple Pattern
```python
def validate_rfc(rfc: str) -> Tuple[bool, str]:
    """
    Returns:
        Tuple of (is_valid, error_message)
    """
    if not rfc:
        return False, "RFC is empty"

    if not RFC_PATTERN.match(rfc.upper()):
        return False, f"Invalid format: {rfc}"

    return True, ""
```

### Usage
```python
is_valid, error = validate_rfc("ABCD010101ABC")
if not is_valid:
    print(f"Error: {error}")
```

## Generic RFCs

Mexico has special generic RFCs for specific cases:

| RFC | Use Case |
|-----|----------|
| XAXX010101000 | Public (general public) |
| XEXX010101000 | Foreign residents |

## Normalization Best Practice

Always normalize input before validation:
```python
def normalize_rfc(rfc: str) -> str:
    if rfc is None:
        return ""
    return rfc.upper().strip()
```

## Integration with Pydantic

```python
from pydantic import validator

class Invoice(BaseModel):
    rfc_emisor: str

    @validator('rfc_emisor')
    def validate_rfc_format(cls, v):
        is_valid, error = validate_rfc(v)
        if not is_valid:
            raise ValueError(error)
        return normalize_rfc(v)
```

## Key Takeaways

1. **RFC Length**: 12 characters for companies, 13 for individuals
2. **Special Characters**: Allow Ñ and & in name portion
3. **Date Portion**: Must be exactly 6 digits
4. **Normalization**: Always uppercase and trim whitespace
5. **Generic RFCs**: XAXX010101000 and XEXX010101000 are valid
