# T008.4 LayoutLM Integration - Learning Guide

## Overview
This guide explains how the `_extract_fields()` method integrates the LayoutLM model for field extraction from invoice images.

## The LayoutLM Pipeline

LayoutLM is a transformer model that understands both text and layout:

```
┌─────────────────────────────────────────────────────────┐
│                    Invoice Image                         │
│  ┌─────────────────────────────────────────────────────┐│
│  │  RFC: XAXX010101000           Fecha: 01/01/2024    ││
│  │                                                     ││
│  │  ┌─────────────────────────────────────────────┐   ││
│  │  │ Descripción    │ Cant │ Precio  │ Importe   │   ││
│  │  ├─────────────────────────────────────────────┤   ││
│  │  │ Producto A     │  2   │ $500    │ $1,000    │   ││
│  │  └─────────────────────────────────────────────┘   ││
│  │                                                     ││
│  │  TOTAL: $1,160.00                                  ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
                  OCR: words + boxes
                          │
                          ▼
              LayoutLM: predict() → labels
                          │
                          ▼
              LayoutLM: extract_fields() → fields
```

## Two-Step Process

The method uses two LayoutLM calls:

### Step 1: predict()
```python
predictions = self.layoutlm.predict(image, words, boxes)
# Returns: [{'word': 'RFC123', 'label': 'B-RFC_EMISOR', ...}, ...]
```

This runs the transformer to classify each word.

### Step 2: extract_fields()
```python
fields = self.layoutlm.extract_fields(predictions)
# Returns: {'RFC_EMISOR': ExtractedField(...), ...}
```

This groups BIO-tagged words into complete fields.

## Why Separate Steps?

Keeping predict() and extract_fields() separate allows:

1. **Debugging**: Inspect raw predictions before grouping
2. **Flexibility**: Apply different grouping strategies
3. **Testing**: Mock each step independently

```python
# Debugging example
predictions = layoutlm.predict(image, words, boxes)
for p in predictions:
    print(f"{p['word']} -> {p['label']} ({p['confidence']:.2f})")

# Then group
fields = layoutlm.extract_fields(predictions)
```

## Integration with OCR

The method expects pre-processed OCR output:

```python
# From _run_ocr()
texts, boxes, confidences = engine._run_ocr(image)

# To _extract_fields()
fields = engine._extract_fields(image, texts, boxes)
```

Note: `confidences` from OCR aren't used by LayoutLM (it computes its own).

## Field Names

The method returns fields by their type:

| Field Key | Description |
|-----------|-------------|
| RFC_EMISOR | Issuer's RFC |
| RFC_RECEPTOR | Receiver's RFC |
| DATE | Invoice date |
| SUBTOTAL | Amount before tax |
| IVA | Tax amount (16%) |
| TOTAL | Final amount |
| ITEM_DESC | Line item description |
| ITEM_QTY | Line item quantity |
| ITEM_PRICE | Line item unit price |
| ITEM_AMOUNT | Line item total |

## Error Handling

The method fails naturally if LayoutLM is unavailable:

```python
engine = InvoiceInferenceEngine(load_models=False)
engine._extract_fields(image, words, boxes)  # AttributeError!
```

This is intentional - calling without a model is a programming error.

## Logging for Debugging

The method logs extracted field names:

```python
logger.debug(f"Extracted fields: {list(fields.keys())}")
# Output: Extracted fields: ['RFC_EMISOR', 'DATE', 'TOTAL']
```

This helps track what was found without logging values (which might be sensitive).

## Key Takeaways

1. **Two-step process**: predict() → extract_fields()
2. **Takes OCR output**: words and boxes from _run_ocr()
3. **Returns dict**: Field names to ExtractedField objects
4. **Simple orchestration**: Delegates to LayoutLM methods
5. **Debug-friendly**: Logs field names extracted
