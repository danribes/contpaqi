# T009.8 API Integration Tests - Learning Guide

## Overview
This guide explains how to write integration tests for FastAPI applications.

## FastAPI TestClient

### Basic Usage
```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)
response = client.get("/health")
assert response.status_code == 200
```

### Key Methods
| Method | HTTP Verb | Usage |
|--------|-----------|-------|
| client.get() | GET | Fetch resources |
| client.post() | POST | Create/submit |
| client.put() | PUT | Update |
| client.delete() | DELETE | Remove |
| client.options() | OPTIONS | CORS preflight |

## File Upload Testing

### Uploading Files
```python
response = client.post(
    "/process_pdf",
    files={"file": ("test.pdf", b"%PDF-1.4", "application/pdf")}
)
```

### File Tuple Format
```python
files={"field_name": (filename, content, content_type)}
```

## Mocking Dependencies

### Mock Engine Pattern
```python
import main
from unittest.mock import Mock, patch

original_engine = main.engine
main.engine = Mock()

try:
    response = client.get("/ready")
finally:
    main.engine = original_engine
```

### Mock with Return Value
```python
mock_engine = Mock()
mock_result = Mock()
mock_result.rfc_emisor = "XAXX010101000"
mock_engine.predict.return_value = mock_result
```

### Mock Exception
```python
mock_engine = Mock()
mock_engine.predict.side_effect = RuntimeError("Error")
```

## Testing Response Structure

### JSON Response
```python
response = client.get("/health")
data = response.json()
assert "status" in data
assert data["version"] == "1.0.0"
```

### Headers
```python
assert "application/json" in response.headers.get("content-type", "")
```

## Testing Error Cases

### Validation Errors (422)
```python
response = client.post("/process_pdf")  # Missing file
assert response.status_code == 422
```

### Bad Request (400)
```python
response = client.post(
    "/process_pdf",
    files={"file": ("test.txt", b"text", "text/plain")}
)
assert response.status_code == 400
```

### Not Found (404)
```python
response = client.get("/nonexistent")
assert response.status_code == 404
```

## CORS Testing

```python
response = client.options(
    "/health",
    headers={"Origin": "http://localhost:3000"}
)
assert response.status_code in [200, 204, 405]
```

## Best Practices

1. **Isolate Tests**: Reset state after each test
2. **Mock External Dependencies**: Don't rely on real services
3. **Test Edge Cases**: Empty files, wrong types, missing data
4. **Verify Response Structure**: Check all expected fields
5. **Test Error Paths**: Ensure errors are handled gracefully

## Key Takeaways

1. **TestClient**: Synchronous testing of async endpoints
2. **Mocking**: Use unittest.mock for dependencies
3. **File Uploads**: Use `files=` parameter with tuple
4. **Cleanup**: Always restore original state in finally block
5. **Response Checking**: Verify status codes, headers, and JSON
