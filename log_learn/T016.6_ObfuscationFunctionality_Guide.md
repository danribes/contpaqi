# Learning Guide: Subtask 16.6 - Test Obfuscated Code Functionality

## Overview

Testing obfuscated code is critical to ensure the application still works after obfuscation. This guide covers how to verify obfuscated code functionality.

---

## Why Test Obfuscated Code?

Obfuscation can break code:

```
┌─────────────────────────────────────────────────────────┐
│ Common Issues After Obfuscation                         │
├─────────────────────────────────────────────────────────┤
│ 1. Reflection fails (renamed members)                   │
│ 2. Serialization breaks (renamed properties)            │
│ 3. Routes don't work (renamed controllers)              │
│ 4. Imports fail (renamed modules)                       │
│ 5. DI fails (renamed services)                          │
└─────────────────────────────────────────────────────────┘
```

---

## Test Categories

### 1. Configuration Validity Tests

Ensure configurations are valid before obfuscation:

```python
def test_pyarmor_config_is_valid_json(self):
    """PyArmor config should be valid JSON."""
    try:
        config = json.loads(PYARMOR_CONFIG.read_text())
        assert config is not None
    except json.JSONDecodeError as e:
        pytest.fail(f"Invalid JSON: {e}")
```

### 2. Module Structure Tests

Verify source structure exists:

```python
def test_src_has_main_module(self):
    """Source should have main.py module."""
    main_path = PYTHON_SRC_DIR / 'main.py'
    assert main_path.exists()
```

### 3. Build Pipeline Tests

Verify build infrastructure:

```python
def test_makefile_has_obfuscate_target(self):
    """Makefile should have obfuscate target."""
    content = MAKEFILE.read_text()
    assert 'obfuscate' in content
```

### 4. Functionality Tests

Verify code structure is valid:

```python
def test_python_has_fastapi_app(self):
    """Python main should have FastAPI app."""
    main_path = PYTHON_SRC_DIR / 'main.py'
    content = main_path.read_text()
    assert 'FastAPI' in content
```

---

## Testing Strategy

### Pre-Obfuscation Tests
Run before obfuscation to ensure source is valid:

```bash
pytest tests/test_task016_6_obfuscation_functionality.py -v
```

### Post-Obfuscation Tests
Run after obfuscation to verify functionality:

```bash
# Python
cd mcp-container
make obfuscate
python -c "from dist.main import app; print('OK')"

# C#
cd windows-bridge
.\scripts\obfuscate.ps1
dotnet obfuscated/ContpaqiBridge.dll --urls http://localhost:5000
```

---

## Configuration Verification

### Python (PyArmor)

Required sections:
```json
{
  "project": { ... },
  "obfuscation": {
    "src": "src",
    "output": "dist",
    "entry": "main.py"
  },
  "settings": { ... },
  "targets": { ... }
}
```

### C# (Dotfuscator)

Required elements:
```xml
<dotfuscator>
  <input>...</input>
  <output>...</output>
  <renaming>...</renaming>
</dotfuscator>
```

---

## Module Structure Verification

### Python
```
mcp-container/
├── src/
│   ├── main.py          ← Entry point
│   ├── inference.py     ← Core logic
│   ├── models/          ← Data models
│   └── utils/           ← Utilities
└── dist/                ← Obfuscated output
```

### C#
```
windows-bridge/
├── src/ContpaqiBridge/
│   ├── Program.cs       ← Entry point
│   ├── Controllers/     ← API endpoints
│   ├── Models/          ← Data models
│   ├── Services/        ← Business logic
│   └── Sdk/             ← SDK interop
└── obfuscated/          ← Obfuscated output
```

---

## Integration Testing

Verify both platforms work together:

```python
def test_both_have_string_encryption(self):
    """Both configs should have string encryption."""
    py_config = json.loads(PYARMOR_CONFIG.read_text())
    cs_content = DOTFUSCATOR_CONFIG.read_text()

    py_has_strings = 'string_encryption' in py_config
    cs_has_strings = 'string' in cs_content.lower()

    assert py_has_strings and cs_has_strings
```

---

## Exclusion Verification

Ensure critical code is excluded from obfuscation:

### Python
```python
def test_obfuscation_excludes_tests(self):
    """Tests should be excluded."""
    config = json.loads(PYARMOR_CONFIG.read_text())
    excludes = config.get('obfuscation', {}).get('excludes', [])

    has_test_exclusion = any('test' in e.lower() for e in excludes)
    assert has_test_exclusion
```

### C#
```python
def test_csharp_excludes_controllers(self):
    """Controllers should be excluded."""
    content = DOTFUSCATOR_CONFIG.read_text()
    assert 'Controller' in content
```

---

## Common Obfuscation Issues

### Issue 1: Reflection Failure

```csharp
// Before obfuscation
Type.GetType("MyNamespace.MyClass")  // Works

// After obfuscation (class renamed)
Type.GetType("MyNamespace.MyClass")  // Returns null!
```

**Solution**: Exclude from renaming or use nameof()

### Issue 2: JSON Serialization

```csharp
public class User {
    public string Name { get; set; }  // Renamed to 'a'
}

// JSON: { "Name": "John" }  // Doesn't match 'a'!
```

**Solution**: Exclude models or use [JsonPropertyName]

### Issue 3: Routing

```csharp
[Route("api/[controller]")]
public class InvoiceController  // Renamed to 'b'
{
    // Route becomes api/b instead of api/Invoice!
}
```

**Solution**: Exclude controllers from renaming

---

## Build Pipeline Verification

```makefile
# Makefile should have these targets
obfuscate:
    python scripts/obfuscate.py

build: obfuscate
    docker build -f Dockerfile.prod -t app .

clean:
    rm -rf dist/
```

Test verification:
```python
def test_makefile_has_obfuscate_target(self):
    content = MAKEFILE.read_text()
    assert 'obfuscate' in content
```

---

## Dockerfile Verification

Production Dockerfile should use obfuscated code:

```dockerfile
# Copy obfuscated code
COPY dist/ ./src/
```

Test verification:
```python
def test_dockerfile_prod_uses_dist(self):
    content = dockerfile.read_text()
    assert 'dist' in content
```

---

## Summary

| Test Category | Purpose |
|--------------|---------|
| Config Validity | Ensure configs are valid |
| Module Structure | Source files exist |
| Script Functionality | Scripts have required options |
| Build Pipeline | Makefile/Dockerfile correct |
| Output Config | Output directories set |
| Integration | Cross-platform consistency |
| Functionality | Code is valid |

---

## Task 16 Complete

With subtask 16.6, Task 16 (Code Obfuscation) is now complete:

| Subtask | Description | Status |
|---------|-------------|--------|
| 16.1 | Install and configure PyArmor | ✓ |
| 16.2 | Obfuscate inference.py and main.py | ✓ |
| 16.3 | Modify Dockerfile to use obfuscated dist/ | ✓ |
| 16.4 | Configure Dotfuscator Community for C# | ✓ |
| 16.5 | Enable string encryption | ✓ |
| 16.6 | Test obfuscated code functionality | ✓ |
