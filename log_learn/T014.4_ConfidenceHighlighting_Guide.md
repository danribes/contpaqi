# T014.4 - Confidence-Based Highlighting Learning Guide

**Subtask**: 14.4 - Implement confidence-based highlighting (orange <0.90)
**Date**: 2025-12-08
**Type**: ML/UI Integration Pattern

---

## Overview

This guide covers implementing visual confidence indicators for ML-extracted data, including synchronized highlighting between document viewer and data entry form.

---

## Key Concepts

### 1. Confidence Threshold Design

When displaying ML extraction results, use multiple tiers to help users prioritize review:

```
High (>=90%)    → Green  → Auto-accept, quick review
Medium (70-89%) → Orange → Needs verification
Low (<70%)      → Red    → Requires attention
```

**Design Principle**: Use color + opacity to indicate urgency. Lower confidence = more visible highlight.

```typescript
function getHighlightOpacity(confidence: number): number {
  if (confidence >= 0.90) return 0.1;  // Subtle
  if (confidence >= 0.70) return 0.25; // Noticeable
  return 0.4;                           // Prominent
}
```

### 2. Bounding Box Coordinate Systems

ML models (like LayoutLM) often use normalized coordinates (0-1000 scale). Converting to pixel coordinates requires:

```typescript
function normalizeBoxToPage(
  bbox: BoundingBox,
  pageWidth: number,
  pageHeight: number
): BoundingBox {
  return {
    x1: (bbox.x1 / 1000) * pageWidth,
    y1: (bbox.y1 / 1000) * pageHeight,
    x2: (bbox.x2 / 1000) * pageWidth,
    y2: (bbox.y2 / 1000) * pageHeight,
  };
}
```

**Important**: Account for zoom scale when rendering overlays.

### 3. Form-to-Document Synchronization

Two-way sync between form fields and document regions:

```
Form Field Focus → Highlight in PDF
PDF Region Click → Focus in Form
```

Implementation pattern:

```typescript
// State for active highlight
const [activeHighlight, setActiveHighlight] = useState<string>();

// Form → PDF sync
<InvoiceForm
  onFieldFocus={(fieldName) => setActiveHighlight(fieldName)}
/>

// PDF displays highlight
<PDFViewer
  highlights={highlights}
  activeHighlight={activeHighlight}
/>
```

---

## Implementation Patterns

### 1. Confidence Summary Component

Aggregate view showing field statistics:

```tsx
function ConfidenceSummary({ fields, onFieldClick }) {
  const summary = useMemo(() => calculateConfidenceSummary(fields), [fields]);
  const status = getSummaryStatus(summary);

  return (
    <div className={`rounded border ${statusColors[status]}`}>
      <div className="flex items-center gap-2">
        {statusIcons[status]}
        <span>{getStatusMessage(summary)}</span>
      </div>
      <div className="grid grid-cols-3">
        <div>High: {summary.highConfidence}</div>
        <div>Medium: {summary.mediumConfidence}</div>
        <div>Low: {summary.lowConfidence}</div>
      </div>
    </div>
  );
}
```

### 2. PDF Overlay Rendering

Overlay highlights as positioned divs:

```tsx
function PDFHighlightOverlay({ highlights, activeField, pageWidth, pageHeight, scale }) {
  return (
    <div className="absolute inset-0 pointer-events-none">
      {highlights.map((highlight) => {
        const normalized = normalizeBoxToPage(
          highlight.bbox,
          pageWidth * scale,
          pageHeight * scale
        );
        const isActive = highlight.fieldName === activeField;

        return (
          <div
            key={highlight.fieldName}
            className={isActive ? 'ring-2 ring-blue-500' : ''}
            style={{
              position: 'absolute',
              left: `${normalized.x1}px`,
              top: `${normalized.y1}px`,
              width: `${normalized.x2 - normalized.x1}px`,
              height: `${normalized.y2 - normalized.y1}px`,
              backgroundColor: `${colorToRgba(highlight.color, highlight.opacity)}`,
            }}
          />
        );
      })}
    </div>
  );
}
```

### 3. Memoized Data Transformation

Convert extracted data to highlight configs efficiently:

```typescript
const fieldConfidenceData = useMemo(() => {
  if (!extractedData) return [];

  return Object.entries(extractedData)
    .filter(([, field]) => field?.confidence !== undefined)
    .map(([name, field]) => ({
      fieldName: name,
      confidence: field.confidence,
      bbox: field.bbox ? {
        x1: field.bbox[0], y1: field.bbox[1],
        x2: field.bbox[2], y2: field.bbox[3],
      } : undefined,
      value: field.value,
    }));
}, [extractedData]);

const pdfHighlights = useMemo(() => {
  return fieldConfidenceData
    .map(calculateHighlightConfig)
    .filter((c): c is HighlightConfig => c !== null);
}, [fieldConfidenceData]);
```

---

## Design Decisions

### 1. Threshold Selection (0.90 / 0.70)

**Decision**: 90% for high confidence, 70% for medium.

**Rationale**:
- 90% aligns with typical ML accuracy expectations
- 70% is the minimum acceptable for automated entry
- Below 70% likely requires manual correction

### 2. Opacity-Based Visibility

**Decision**: Lower confidence = higher opacity.

**Rationale**:
- Users naturally notice more visible elements first
- Prioritizes review of problematic fields
- High confidence fields don't distract

### 3. Active Highlight Enhancement

**Decision**: Add ring + increased opacity for active field.

**Rationale**:
- Clear visual connection between form and PDF
- Helps users understand which region they're editing
- Ring provides distinct border that doesn't blend with fill

### 4. Summary-First Layout

**Decision**: Show ConfidenceSummary above InvoiceForm.

**Rationale**:
- Users see overall status immediately
- Quick navigation to problematic fields
- Doesn't interrupt form workflow

---

## Testing Strategy

### 1. Pure Function Tests

Test utility functions in isolation:

```typescript
describe('getHighlightColor', () => {
  it('returns green for high confidence', () => {
    expect(getHighlightColor(0.95)).toBe('green');
  });

  it('returns orange for medium confidence', () => {
    expect(getHighlightColor(0.85)).toBe('orange');
  });

  it('returns red for low confidence', () => {
    expect(getHighlightColor(0.50)).toBe('red');
  });
});
```

### 2. Edge Case Tests

```typescript
describe('threshold edge cases', () => {
  it('treats exactly 0.90 as high confidence', () => {
    expect(needsReview(0.90)).toBe(false);
  });

  it('treats 0.8999 as needing review', () => {
    expect(needsReview(0.8999)).toBe(true);
  });
});
```

### 3. Aggregate Calculation Tests

```typescript
describe('calculateConfidenceSummary', () => {
  it('handles empty array', () => {
    const summary = calculateConfidenceSummary([]);
    expect(summary.totalFields).toBe(0);
    expect(summary.averageConfidence).toBe(0);
  });

  it('categorizes correctly', () => {
    const fields = [
      { fieldName: 'a', confidence: 0.95, value: '' },
      { fieldName: 'b', confidence: 0.80, value: '' },
      { fieldName: 'c', confidence: 0.60, value: '' },
    ];
    const summary = calculateConfidenceSummary(fields);
    expect(summary.highConfidence).toBe(1);
    expect(summary.mediumConfidence).toBe(1);
    expect(summary.lowConfidence).toBe(1);
  });
});
```

---

## Common Patterns

### Color Mapping with Tailwind

```typescript
const colorClasses = {
  green: 'bg-green-500',
  orange: 'bg-orange-500',
  red: 'bg-red-500',
};

// For rgba colors in inline styles
const colorMap = {
  green: 'rgba(34, 197, 94, ',   // green-500
  orange: 'rgba(249, 115, 22, ', // orange-500
  red: 'rgba(239, 68, 68, ',     // red-500
};
```

### Status Icon Selection

```tsx
const statusIcons = {
  good: <CheckCircleIcon className="text-green-600" />,
  review: <ExclamationIcon className="text-orange-600" />,
  attention: <AlertIcon className="text-red-600" />,
};
```

### Clickable Field Tags

```tsx
{fieldsNeedingReview.map((field) => (
  <button
    key={field.fieldName}
    onClick={() => onFieldClick(field.fieldName)}
    className={`
      px-2 py-1 rounded text-xs
      ${field.confidence < 0.70 ? 'bg-red-200' : 'bg-orange-200'}
      hover:opacity-80 transition-opacity
    `}
  >
    {field.fieldName} ({formatPercent(field.confidence)})
  </button>
))}
```

---

## Best Practices

1. **Use memoization** for derived data to prevent recalculation
2. **Export utility functions** for unit testing
3. **Use semantic colors** (green=good, orange=warning, red=error)
4. **Scale opacity inversely** with confidence for visual priority
5. **Provide status messages** in user-friendly language
6. **Support keyboard navigation** for accessibility
7. **Handle missing bbox gracefully** - not all fields have positions

---

## Related Resources

- LayoutLM coordinate system documentation
- React PDF rendering patterns
- Tailwind CSS color palette
- WCAG accessibility guidelines for color contrast
