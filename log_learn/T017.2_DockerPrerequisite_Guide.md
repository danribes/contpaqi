# Learning Guide: Subtask 17.2 - Implement Docker Desktop Prerequisite Check

## Overview

Prerequisite checking ensures users have required software before installation.

```
┌─────────────────────────────────────────────────────────┐
│ Prerequisite Check Flow                                 │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   Installer  →  Check Script  →  Decision               │
│     Start        (PS1)            ├── OK: Continue      │
│                                   ├── Warn: Ask User    │
│                                   └── Fail: Stop        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## Docker Desktop Detection Methods

### Method 1: File Path Check

```powershell
$DockerPaths = @(
    "$env:ProgramFiles\Docker\Docker\Docker Desktop.exe",
    "$env:LOCALAPPDATA\Docker\Docker Desktop.exe"
)

foreach ($path in $DockerPaths) {
    if (Test-Path $path) {
        return @{ Installed = $true; Path = $path }
    }
}
```

### Method 2: Registry Check

```powershell
$regKey = "HKLM:\SOFTWARE\Docker Inc.\Docker Desktop"

if (Test-Path $regKey) {
    $installPath = (Get-ItemProperty -Path $regKey).InstallPath
    return @{ Installed = $true; Path = $installPath }
}
```

### Method 3: CLI in PATH

```powershell
$dockerCmd = Get-Command "docker" -ErrorAction SilentlyContinue
if ($dockerCmd) {
    return @{ Installed = $true; Path = $dockerCmd.Source }
}
```

---

## Checking if Docker is Running

### Using docker info

```powershell
$result = & docker info 2>&1

if ($LASTEXITCODE -eq 0) {
    # Docker daemon is running
    return @{ Running = $true }
}

# Parse error for specific messages
if ($result -match "Cannot connect to the Docker daemon") {
    return @{
        Running = $false
        Message = "Docker daemon is not running"
    }
}
```

### Checking Windows Service

```powershell
$service = Get-Service -Name "com.docker.service" -ErrorAction SilentlyContinue

if ($service) {
    return @{
        Running = ($service.Status -eq 'Running')
        Status = $service.Status.ToString()
    }
}
```

---

## Version Detection

### Parsing docker --version

```powershell
$output = & docker --version
# Output: "Docker version 24.0.5, build ced0996"

if ($output -match "Docker version (\d+\.\d+\.\d+)") {
    $version = $Matches[1]  # "24.0.5"
}
```

### Version Comparison

```powershell
function Compare-DockerVersion {
    param(
        [string]$CurrentVersion,
        [string]$RequiredVersion
    )

    $current = [version]$CurrentVersion
    $required = [version]$RequiredVersion

    return @{
        MeetsRequirement = ($current -ge $required)
        Current = $CurrentVersion
        Required = $RequiredVersion
    }
}

# Usage
$check = Compare-DockerVersion -CurrentVersion "24.0.5" -RequiredVersion "20.10.0"
if ($check.MeetsRequirement) {
    Write-Host "Version OK"
}
```

---

## Structured Output

### PSCustomObject

```powershell
$status = [PSCustomObject]@{
    Installed = $true
    Running = $true
    Version = "24.0.5"
    VersionOK = $true
    Path = "C:\Program Files\Docker\Docker\Docker Desktop.exe"
    ServiceStatus = "Running"
    Message = "Docker Desktop is ready"
}

# Access properties
if ($status.Running) {
    Write-Host "Docker is running"
}
```

### JSON Output

```powershell
# Output as JSON for parsing
$status | ConvertTo-Json

# Parse in another script
$status = Get-Content status.json | ConvertFrom-Json
```

---

## Exit Codes

Use exit codes for installer integration:

```powershell
# In PowerShell script
if ($status.Installed -and $status.Running) {
    exit 0  # Success
}
elseif ($status.Installed -and -not $status.Running) {
    exit 1  # Installed but not running
}
elseif (-not $status.Installed) {
    exit 2  # Not installed
}
else {
    exit 3  # Other error
}
```

### In Inno Setup

```pascal
// Call PowerShell script and check exit code
function CheckDockerPrerequisite(): Boolean;
var
  ResultCode: Integer;
begin
  Exec('powershell.exe', '-ExecutionPolicy Bypass -File check-docker.ps1',
       '', SW_HIDE, ewWaitUntilTerminated, ResultCode);

  case ResultCode of
    0: Result := True;   // All good
    1: Result := AskUserToContinue('Docker not running');
    2: Result := AskUserToInstallDocker();
    else Result := False;
  end;
end;
```

---

## Error Handling

### SilentlyContinue

```powershell
$ErrorActionPreference = "SilentlyContinue"

# Commands that might fail won't throw errors
$cmd = Get-Command "docker" -ErrorAction SilentlyContinue
if ($cmd) {
    # Found
}
```

### Try-Catch

```powershell
try {
    $result = & docker info 2>&1
    if ($LASTEXITCODE -eq 0) {
        return @{ Running = $true }
    }
}
catch {
    return @{
        Running = $false
        Error = $_.Exception.Message
    }
}
```

---

## Integration with Inno Setup

### Calling PowerShell Script

```pascal
[Run]
; Check Docker before loading image
Filename: "powershell.exe"; \
  Parameters: "-ExecutionPolicy Bypass -File ""{app}\scripts\check-docker.ps1"""; \
  Flags: runhidden waituntilterminated; \
  Check: ShouldCheckDocker
```

### Using Check Result

```pascal
function DockerInstalled(): Boolean;
var
  ResultCode: Integer;
begin
  // Run check script
  Exec('powershell.exe',
       '-ExecutionPolicy Bypass -File check-docker.ps1 -Quiet',
       '', SW_HIDE, ewWaitUntilTerminated, ResultCode);

  Result := (ResultCode = 0);
end;
```

---

## User Experience

### Informative Messages

```powershell
if (-not $status.Installed) {
    $message = "Docker Desktop is not installed.`n`n" +
               "Please download from:`n" +
               "https://www.docker.com/products/docker-desktop"
}
elseif (-not $status.Running) {
    $message = "Docker Desktop is installed but not running.`n`n" +
               "Please start Docker Desktop and try again."
}
```

### Wizard Page in Inno Setup

```pascal
DockerPage := CreateInputQueryPage(wpSelectDir,
  'Docker Desktop Status',
  'Checking prerequisites...',
  'ContPAQi AI Bridge requires Docker Desktop.');

DockerPage.Add('Status:', False);
DockerPage.Values[0] := GetDockerStatusString();
```

---

## Best Practices

### DO:
- Check multiple installation paths
- Verify Docker is actually running
- Validate version compatibility
- Provide clear error messages
- Use structured output for parsing
- Handle errors gracefully

### DON'T:
- Assume single installation path
- Only check if installed (not running)
- Hardcode version numbers
- Show technical error messages
- Fail silently

---

## Summary

| Concept | Implementation |
|---------|----------------|
| Installation Check | File paths, Registry, PATH |
| Running Check | docker info, Service status |
| Version Check | docker --version + parsing |
| Output | PSCustomObject or JSON |
| Exit Codes | 0=OK, 1=Not running, 2=Not installed |
| Integration | PowerShell script called from ISS |

---

## Next Steps

After this subtask:
1. **17.3**: Windows Service installation
2. **17.4**: Bundle Docker image
3. **17.5**: Silent Docker image loading
