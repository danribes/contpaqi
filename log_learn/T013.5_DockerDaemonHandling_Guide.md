# Docker Daemon Error Handling - Learning Guide

## Overview
How to handle scenarios where Docker is unavailable in an Electron application, providing user-friendly error messages and recovery options.

## Key Concepts

### 1. Error Classification

#### Common Docker Errors
```typescript
type DockerErrorCode =
  | 'DAEMON_NOT_RUNNING'    // Docker service not started
  | 'DOCKER_NOT_INSTALLED'  // Docker CLI not found
  | 'PERMISSION_DENIED'     // User lacks docker group
  | 'UNKNOWN_ERROR';        // Catch-all for other errors
```

#### Error Patterns
| Pattern in stderr/error | Classification |
|------------------------|----------------|
| "Cannot connect to the Docker daemon" | DAEMON_NOT_RUNNING |
| "Is the docker daemon running?" | DAEMON_NOT_RUNNING |
| "spawn docker ENOENT" | DOCKER_NOT_INSTALLED |
| "command not found" | DOCKER_NOT_INSTALLED |
| "permission denied" | PERMISSION_DENIED |
| Other errors | UNKNOWN_ERROR |

### 2. Error Detection

```typescript
private classifyError(errorMessage: string): DockerErrorCode {
  const lowerError = errorMessage.toLowerCase();

  if (lowerError.includes('cannot connect') ||
      lowerError.includes('daemon running')) {
    return 'DAEMON_NOT_RUNNING';
  }

  if (lowerError.includes('enoent') ||
      lowerError.includes('not found')) {
    return 'DOCKER_NOT_INSTALLED';
  }

  if (lowerError.includes('permission denied')) {
    return 'PERMISSION_DENIED';
  }

  return 'UNKNOWN_ERROR';
}
```

### 3. User-Friendly Messages

```typescript
interface DockerError {
  code: DockerErrorCode;
  message: string;      // What happened
  suggestion: string;   // How to fix it
  originalError?: string; // Technical details
}

private getErrorDetails(code: DockerErrorCode): DockerError {
  switch (code) {
    case 'DAEMON_NOT_RUNNING':
      return {
        code,
        message: 'Docker daemon is not running',
        suggestion: 'Please start Docker Desktop or the Docker service.',
      };
    case 'DOCKER_NOT_INSTALLED':
      return {
        code,
        message: 'Docker is not installed',
        suggestion: 'Please install Docker Desktop from docker.com',
      };
    case 'PERMISSION_DENIED':
      return {
        code,
        message: 'Permission denied accessing Docker',
        suggestion: 'Add your user to the docker group or run as administrator.',
      };
    default:
      return {
        code,
        message: 'Unable to connect to Docker',
        suggestion: 'Please check your Docker installation.',
      };
  }
}
```

### 4. Polling for Daemon

```typescript
async waitForDaemon(
  timeoutMs: number = 30000,
  intervalMs: number = 2000,
  onRetry?: (attempt: number, error: string) => void
): Promise<{ success: boolean; error?: string }> {
  const startTime = Date.now();
  let attempt = 0;

  while (Date.now() - startTime < timeoutMs) {
    const status = await this.checkDaemonStatus();

    if (status.isDaemonRunning) {
      return { success: true };
    }

    attempt++;
    onRetry?.(attempt, status.error || 'Unknown error');

    // Wait before retry
    await new Promise(resolve => setTimeout(resolve, intervalMs));
  }

  return { success: false, error: 'Timeout waiting for Docker daemon' };
}
```

### 5. React Error Component

```tsx
interface DockerStatusAlertProps {
  error: DockerError;
  onRetry?: () => void;
  isRetrying?: boolean;
}

function DockerStatusAlert({ error, onRetry, isRetrying }: DockerStatusAlertProps) {
  return (
    <div className="alert">
      <Icon code={error.code} />
      <h3>{error.message}</h3>
      <p>{error.suggestion}</p>

      {onRetry && (
        <button onClick={onRetry} disabled={isRetrying}>
          {isRetrying ? 'Checking...' : 'Retry'}
        </button>
      )}

      {error.code === 'DOCKER_NOT_INSTALLED' && (
        <a href="https://docker.com">Download Docker</a>
      )}
    </div>
  );
}
```

### 6. Full-Page Overlay Pattern

```tsx
function DockerErrorOverlay({ error, onRetry, isRetrying }) {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="max-w-md">
        <DockerIcon />
        <h1>Docker Required</h1>
        <p>This app requires Docker to run.</p>
        <DockerStatusAlert
          error={error}
          onRetry={onRetry}
          isRetrying={isRetrying}
        />
      </div>
    </div>
  );
}
```

### 7. App Integration

```tsx
function App() {
  const [dockerStatus, setDockerStatus] = useState<'checking' | 'running' | 'error'>('checking');
  const [dockerError, setDockerError] = useState<DockerError | null>(null);
  const [isRetrying, setIsRetrying] = useState(false);

  useEffect(() => {
    checkDockerStatus();
  }, []);

  const checkDockerStatus = async () => {
    setDockerStatus('checking');

    // Check for daemon error first
    const error = await window.electronAPI.getDaemonError();
    if (error) {
      setDockerError(error);
      setDockerStatus('error');
      return;
    }

    setDockerStatus('running');
  };

  const handleRetry = async () => {
    setIsRetrying(true);
    await checkDockerStatus();
    setIsRetrying(false);
  };

  // Show overlay if Docker unavailable
  if (dockerStatus === 'error' && dockerError) {
    return (
      <DockerErrorOverlay
        error={dockerError}
        onRetry={handleRetry}
        isRetrying={isRetrying}
      />
    );
  }

  return <MainApp />;
}
```

## Common Patterns

### Context-Sensitive Icons
```tsx
function getErrorIcon(code: DockerErrorCode): JSX.Element {
  switch (code) {
    case 'DOCKER_NOT_INSTALLED':
      return <WarningTriangle />;  // Red - critical
    case 'DAEMON_NOT_RUNNING':
      return <DisconnectedIcon />; // Yellow - recoverable
    case 'PERMISSION_DENIED':
      return <LockIcon />;         // Orange - requires action
    default:
      return <InfoIcon />;         // Gray - unknown
  }
}
```

### Color Coding
```tsx
function getErrorColor(code: DockerErrorCode): string {
  switch (code) {
    case 'DOCKER_NOT_INSTALLED':
      return 'bg-red-50 border-red-200';    // Critical
    case 'DAEMON_NOT_RUNNING':
      return 'bg-yellow-50 border-yellow-200'; // Warning
    case 'PERMISSION_DENIED':
      return 'bg-orange-50 border-orange-200'; // Action needed
    default:
      return 'bg-gray-50 border-gray-200';  // Unknown
  }
}
```

### Technical Details Toggle
```tsx
function TechnicalDetails({ originalError }) {
  const [show, setShow] = useState(false);

  if (!originalError) return null;

  return (
    <>
      <button onClick={() => setShow(!show)}>
        {show ? 'Hide' : 'Show'} Details
      </button>
      {show && (
        <pre className="bg-gray-800 text-white p-3">
          {originalError}
        </pre>
      )}
    </>
  );
}
```

## Best Practices

1. **Check early**: Check Docker availability at app startup
2. **Block when critical**: Use full-page overlay when Docker is required
3. **Clear messaging**: Explain what happened and how to fix it
4. **Provide actions**: Retry button, download links, etc.
5. **Show progress**: Loading state during retry
6. **Technical details**: Hide by default, show on demand
7. **Context icons**: Visual indicators for error severity
8. **Color coding**: Consistent colors for error types

## Platform Considerations

### Windows
- Docker Desktop required
- Hyper-V or WSL2 backend
- Admin rights may be needed

### macOS
- Docker Desktop required
- Apple Silicon vs Intel considerations

### Linux
- Docker Engine sufficient
- User must be in docker group
- systemd service management

## Key Takeaways

1. Classify errors into meaningful categories
2. Provide user-friendly messages with actionable suggestions
3. Support retry functionality for recoverable errors
4. Use visual indicators (icons, colors) for error severity
5. Block the app when Docker is critical requirement
6. Hide technical details but make them accessible
7. Provide external links (download, documentation)
