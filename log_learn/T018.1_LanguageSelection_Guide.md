# T018.1 - Add Language Selection to Inno Setup Installer - Learning Guide

**Task**: 18.1 Add language selection to Inno Setup installer
**Date**: 2025-12-11
**Difficulty**: Intermediate

---

## Overview

This guide explains how to implement multi-language support in an Inno Setup installer, allowing users to select their preferred application language during installation and storing that preference for the application to use.

---

## What We Built

A language selection feature for the ContPAQi AI Bridge Windows installer that:

1. Displays a wizard page for language selection (English/Spanish)
2. Uses localized text for all messages
3. Stores the user's preference in the Windows registry
4. Makes the preference available to the desktop application

---

## Key Concepts

### 1. Inno Setup Language System

Inno Setup has built-in support for multiple installer languages through the `[Languages]` section:

```pascal
[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "spanish"; MessagesFile: "compiler:Languages\Spanish.isl"
```

The `MessagesFile` parameter points to `.isl` (Inno Setup Language) files that contain all the built-in strings used by the installer.

### 2. Custom Messages for Application Strings

While `[Languages]` handles installer UI, `[CustomMessages]` allows you to define your own localized strings:

```pascal
[CustomMessages]
english.MyString=Hello World
spanish.MyString=Hola Mundo
```

These can be referenced in the script using `{cm:MyString}` or `ExpandConstant('{cm:MyString}')` in Pascal code.

### 3. Wizard Pages

Inno Setup allows creating custom wizard pages using Pascal Script. For language selection, we use `TInputOptionWizardPage` which provides radio buttons:

```pascal
LanguagePage := CreateInputOptionPage(
    wpWelcome,           // Insert after Welcome page
    'Title',             // Page title
    'Subtitle',          // Page subtitle
    'Description',       // Instructions
    True,                // Exclusive (radio buttons)
    False                // Not required
);
```

### 4. Registry Storage

The Windows Registry is the standard way to store application settings on Windows:

```pascal
// In [Registry] section - declarative
Root: HKLM; Subkey: "SOFTWARE\MyApp"; ValueName: "Language"; ValueData: "en"

// In [Code] section - programmatic
RegWriteStringValue(HKEY_LOCAL_MACHINE, 'SOFTWARE\MyApp', 'Language', 'en');
```

---

## Implementation Step-by-Step

### Step 1: Define Languages

```pascal
[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "spanish"; MessagesFile: "compiler:Languages\Spanish.isl"
```

### Step 2: Create Custom Messages

```pascal
[CustomMessages]
english.SelectLanguage=Select Installation Language
spanish.SelectLanguage=Seleccione el Idioma de Instalación
```

### Step 3: Declare Variables

```pascal
var
  LanguagePage: TInputOptionWizardPage;
  SelectedLanguageCode: String;
```

### Step 4: Create Helper Functions

```pascal
function GetSelectedLanguage(): String;
begin
  if LanguagePage.SelectedValueIndex = 1 then
    Result := 'es'
  else
    Result := 'en';
end;

procedure SaveLanguagePreference();
begin
  RegWriteStringValue(HKEY_LOCAL_MACHINE,
    'SOFTWARE\MyApp',
    'Language',
    GetSelectedLanguage());
end;
```

### Step 5: Create the Wizard Page

```pascal
procedure InitializeWizard();
begin
  LanguagePage := CreateInputOptionPage(wpWelcome,
    ExpandConstant('{cm:SelectLanguage}'),
    ExpandConstant('{cm:AppLanguage}'),
    ExpandConstant('{cm:LanguageSelectionPrompt}'),
    True, False);

  LanguagePage.Add('English');
  LanguagePage.Add('Español');
  LanguagePage.SelectedValueIndex := 0;
end;
```

### Step 6: Save on Installation Complete

```pascal
procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssPostInstall then
    SaveLanguagePreference();
end;
```

---

## Best Practices

### 1. Use ISO Language Codes

Always use standard ISO 639-1 codes (e.g., 'en', 'es') for consistency with i18n frameworks:

```pascal
// Good
LanguageCode := 'es';

// Avoid
LanguageCode := 'spanish';
```

### 2. Default to English

English is the most common fallback language:

```pascal
function GetSelectedLanguage(): String;
begin
  if LanguagePage.SelectedValueIndex = 1 then
    Result := 'es'
  else
    Result := 'en';  // Default fallback
end;
```

### 3. Match Installer Language to App Default

If the user chooses Spanish for the installer, default the app language to Spanish too:

```pascal
if ActiveLanguage = 'spanish' then
  LanguagePage.SelectedValueIndex := 1
else
  LanguagePage.SelectedValueIndex := 0;
```

### 4. Store in Both Registry and File

For maximum compatibility, consider storing in both registry (for Windows) and a config file (for portability):

```pascal
// Registry
RegWriteStringValue(HKLM, 'SOFTWARE\MyApp', 'Language', LangCode);

// Config file
SaveStringToFile(ExpandConstant('{app}\config\language.txt'), LangCode, False);
```

---

## How the Application Reads the Language

The desktop application (Electron/React) can read the language preference:

**From Registry (Windows):**
```typescript
import { app } from 'electron';
import Registry from 'winreg';

const regKey = new Registry({
  hive: Registry.HKLM,
  key: '\\SOFTWARE\\ContPAQi AI Bridge\\ContPAQi AI Bridge'
});

regKey.get('Language', (err, item) => {
  const language = item?.value || 'en';
  // Set i18n language
});
```

---

## Testing Considerations

When testing i18n installers:

1. **Test both languages**: Run through the installer in English and Spanish
2. **Verify registry writes**: Check that the Language key is created correctly
3. **Test default behavior**: Ensure English is the default when no selection is made
4. **Test persistence**: Verify the language setting survives reinstallation

---

## Common Pitfalls

1. **Forgetting to expand constants**: Always use `ExpandConstant()` for custom messages in Pascal code
2. **Case sensitivity**: Registry values and language codes should be consistent
3. **Missing language files**: Ensure all referenced `.isl` files exist
4. **Ordering matters**: The first language in `[Languages]` is the default

---

## Further Reading

- [Inno Setup Documentation](https://jrsoftware.org/ishelp/)
- [Pascal Script Reference](https://jrsoftware.org/ishelp/topic_scriptcoderef.htm)
- [i18next Framework](https://www.i18next.com/) (for React app)
- [ISO 639-1 Language Codes](https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes)
