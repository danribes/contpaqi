# T015.6 - Offline Grace Period Learning Notes

**Subtask**: 15.6 - Implement offline grace period (7 days)
**Date**: 2025-12-09

---

## Key Learnings

### 1. Grace Period Strategy

Grace periods balance user convenience with license security:

```
User Experience     â† â†’     Security
   Better                    Stricter

   Longer grace â”€â”€â”€â”€â”¼â”€â”€â”€â”€ Shorter grace
   30 days          â”‚      3 days
                    â”‚
            7 days (default)
```

**Why 7 days?**
- Covers typical business travel
- Handles temporary network outages
- Long enough for support escalation
- Short enough to prevent prolonged abuse

### 2. Tiered Grace Periods by License Type

Different license types have different trust levels:

```typescript
const LICENSE_TYPE_GRACE_PERIODS: Record<LicenseType, number> = {
  trial: 3,        // Limited trust, encourage online validation
  standard: 7,     // Normal user, reasonable grace
  professional: 14, // Power user, more flexibility
  enterprise: 30,  // Enterprise users, maximum flexibility
};
```

### 3. Warning Level Progression

Multiple warning stages give users time to act:

```
Days Remaining:  7    6    5    4    3    2    1    0   -1
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Warning Level:   none none none none none warn crit exp exp
                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User Impact:     Normal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Blocked
```

### 4. State Machine Design

The offline state follows a clear state machine:

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                  â”‚
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
      validate() â”€â”€â–ºâ”‚  ONLINE â”‚        â”‚ OFFLINE â”‚
                    â”‚ (valid) â”‚        â”‚ (grace) â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚                  â”‚
                    network             time
                    failure            passes
                         â”‚                  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      EXPIRED          â”‚
                    â”‚ (must reconnect)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## TypeScript Patterns

### 1. Immutable State Updates

All state transitions return new state objects:

```typescript
function startGracePeriod(state: OfflineState, days: number): OfflineState {
  return {
    ...state,                    // Copy existing
    graceStartedAt: new Date(),  // Update specific fields
    gracePeriodDays: days,
    isOffline: true,
  };
}
```

Benefits:
- Easy to track changes
- Supports undo/redo
- Prevents side effects
- Works with React state

### 2. Comprehensive Status Objects

Returning all relevant info in one call:

```typescript
interface GracePeriodStatus {
  isValid: boolean;           // Can use app?
  isInGracePeriod: boolean;   // Offline but valid?
  remainingDays: number;      // Days left
  remainingHours: number;     // Total hours left
  graceStartedAt: Date | null;
  graceEndsAt: Date | null;
  warningLevel: WarningLevel; // What to show user
  message: string;            // Ready-to-display message
}
```

### 3. Event-Driven Architecture

Using events for decoupled notifications:

```typescript
type OfflineEventHandler = (event: OfflineEvent) => void;

class OfflineGraceManager {
  private eventHandlers: OfflineEventHandler[] = [];

  onEvent(handler: OfflineEventHandler): void {
    this.eventHandlers.push(handler);
  }

  private emitEvent(event: OfflineEvent): void {
    this.eventHandlers.forEach(handler => {
      try {
        handler(event);
      } catch (error) {
        console.error('Handler error:', error);
      }
    });
  }
}
```

---

## Date Handling Best Practices

### 1. ISO String Serialization

Dates must be converted for JSON:

```typescript
// Serialize
const json = JSON.stringify({
  graceStartedAt: date?.toISOString() || null,
});

// Deserialize
const restored = {
  graceStartedAt: data.graceStartedAt ? new Date(data.graceStartedAt) : null,
};
```

### 2. Time Calculations

Always work with milliseconds internally:

```typescript
function calculateRemainingGraceTime(graceEndsAt: Date) {
  const now = new Date();
  const remainingMs = graceEndsAt.getTime() - now.getTime();

  if (remainingMs <= 0) {
    return { days: 0, hours: 0, minutes: 0 };
  }

  const MS_PER_DAY = 24 * 60 * 60 * 1000;
  const MS_PER_HOUR = 60 * 60 * 1000;
  const MS_PER_MINUTE = 60 * 1000;

  return {
    days: Math.floor(remainingMs / MS_PER_DAY),
    hours: Math.floor((remainingMs % MS_PER_DAY) / MS_PER_HOUR),
    minutes: Math.floor((remainingMs % MS_PER_HOUR) / MS_PER_MINUTE),
  };
}
```

### 3. Date Addition

Use `setDate` for day arithmetic:

```typescript
function calculateGraceEndDate(start: Date, days: number): Date {
  const end = new Date(start);  // Clone to avoid mutation
  end.setDate(end.getDate() + days);
  return end;
}
```

This correctly handles month/year boundaries.

---

## User Experience Considerations

### 1. Progressive Warning Messages

```typescript
const messages: Record<WarningLevel, string> = {
  none: '',  // No interruption
  warning: 'Your offline grace period is expiring soon. Please connect to validate.',
  critical: 'Your offline grace period expires TODAY! Connect immediately.',
  expired: 'Grace period expired. Please connect to continue using the application.',
};
```

### 2. Non-Blocking Warnings

Warnings should inform, not block:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Offline Mode - 2 days remaining        â”‚
â”‚  Connect to internet to extend access      â”‚
â”‚                                      [OK]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Clear Expiration Feedback

When expired, explain the situation:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’ Offline Access Expired                 â”‚
â”‚                                            â”‚
â”‚  Your 7-day offline grace period has       â”‚
â”‚  ended. Please connect to the internet     â”‚
â”‚  to validate your license.                 â”‚
â”‚                                            â”‚
â”‚  [Connect Now]    [Contact Support]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing Strategies

### 1. Time-Based Test Helpers

Create states at specific points in grace period:

```typescript
function createOfflineTestState(daysOffline: number): OfflineState {
  const graceStartedAt = new Date();
  graceStartedAt.setDate(graceStartedAt.getDate() - daysOffline);

  return {
    ...defaultState,
    isOffline: true,
    graceStartedAt,
  };
}

// Test 3 days into 7-day grace
const state = createOfflineTestState(3);
expect(getGracePeriodStatus(state, config).remainingDays).toBe(4);
```

### 2. Boundary Condition Tests

Always test boundaries:

```typescript
// Exactly at warning threshold
const atWarning = createOfflineTestState(5); // 2 days remaining
expect(determineWarningLevel(...)).toBe('warning');

// Just before critical
const beforeCritical = createOfflineTestState(6); // 1 day remaining
expect(determineWarningLevel(...)).toBe('warning');

// In critical zone
const critical = createOfflineTestState(6.5); // < 24 hours
expect(determineWarningLevel(...)).toBe('critical');

// Just expired
const expired = createOfflineTestState(7.01);
expect(determineWarningLevel(...)).toBe('expired');
```

---

## Integration Patterns

### With License Validator

```typescript
class LicenseValidator {
  private graceManager: OfflineGraceManager;

  async validate(licenseKey: string): Promise<ValidationResult> {
    try {
      // Try online validation
      const result = await this.serverClient.validate(request);

      if (result.valid) {
        this.graceManager.recordOnlineValidation();
        this.graceManager.goOnline();
        return result;
      }
    } catch (error) {
      // Network error - check grace period
      this.graceManager.goOffline();
    }

    // Check offline validity
    if (this.graceManager.isValid()) {
      return { valid: true, isOfflineValidation: true };
    }

    return { valid: false, error: 'Offline grace period expired' };
  }
}
```

### With UI

```typescript
function LicenseStatusBar() {
  const status = graceManager.getStatus();

  if (status.warningLevel === 'none') {
    return null; // No warning needed
  }

  return (
    <Alert severity={status.warningLevel}>
      {status.message}
    </Alert>
  );
}
```

---

## Storage Considerations

### Where to Persist State

Options:
1. **localStorage** - Simple, browser-only
2. **Electron store** - Desktop apps
3. **File system** - Full control

```typescript
// Electron store example
const Store = require('electron-store');
const store = new Store();

// Save
store.set('offlineState', manager.saveState());

// Load
const saved = store.get('offlineState');
if (saved) {
  manager.loadState(saved);
}
```

### Security Note

Stored state can be tampered with. Mitigations:
- Encrypt state with machine-specific key
- Include hash for integrity check
- Verify on server when reconnecting

---

## References

- [Offline-First Design Patterns](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps/Offline_Service_workers)
- [License Grace Period Best Practices](https://blog.licensezero.com/2018/02/12/grace-periods.html)
- [Date/Time Handling in JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date)
