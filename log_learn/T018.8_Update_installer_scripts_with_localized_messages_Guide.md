# Learning Guide - Subtask 18.8
## Implementing Internationalization (i18n) in PowerShell Installer Scripts

**Date:** 2025-12-12

---

## What Was Developed

This subtask adds bilingual support (English and Spanish) to the ContPAQi AI Bridge Windows installer scripts. Users in Spanish-speaking regions can now see installation messages in their native language.

---

## Why This Was Needed

1. **Target Market:** ContPAQi is a Mexican accounting software, meaning the primary user base speaks Spanish
2. **User Experience:** Non-English speakers can better understand installation progress and errors
3. **Professionalism:** Shows commitment to serving the local market properly
4. **Accessibility:** Reduces barriers for users less comfortable with English technical terms

---

## Architecture Overview

### Centralized Localization Module

Rather than embedding translations in each script, we created a **central PowerShell module** (`LocalizedMessages.psm1`) that:

1. **Contains all messages** in a hashtable with nested language keys
2. **Exports helper functions** for retrieving messages
3. **Handles language detection** from registry or defaults
4. **Supports string interpolation** for dynamic content

### Message Structure

```powershell
$script:Messages = @{
    'docker.checking_installation' = @{
        en = 'Checking Docker Desktop installation...'
        es = 'Verificando instalación de Docker Desktop...'
    }
    'service.binary_not_found' = @{
        en = 'Binary not found at: {0}'
        es = 'Binario no encontrado en: {0}'
    }
}
```

### Language Detection Priority

1. **Function parameter** - Explicit `-Language "es"` override
2. **Registry setting** - User preference stored in Windows Registry
3. **Default fallback** - English if nothing else specified

---

## How It Works

### 1. Module Loading

Each script imports the localization module at startup:

```powershell
$ModulePath = Join-Path $PSScriptRoot "LocalizedMessages.psm1"
if (Test-Path $ModulePath) {
    Import-Module $ModulePath -Force
    if ($Language) {
        Set-CurrentLanguage -Language $Language
    }
}
```

### 2. Retrieving Messages

Scripts use `Get-LocalizedMessage` to fetch translated strings:

```powershell
# Simple message
$msg = Get-LocalizedMessage -Key 'docker.checking_installation'

# Message with interpolation
$msg = Get-LocalizedMessage -Key 'service.binary_not_found' -Args @($BinaryPath)
```

### 3. Fallback Strategy

Each script includes a `Get-Msg` helper with hardcoded English fallbacks:

```powershell
function Get-Msg {
    param([string]$Key, [object[]]$Args)

    if (Get-Command Get-LocalizedMessage -ErrorAction SilentlyContinue) {
        return Get-LocalizedMessage -Key $Key -Args $Args
    }

    # Fallback messages
    $fallback = @{
        'docker.checking_installation' = 'Checking Docker Desktop installation...'
        # ... more fallbacks
    }

    $msg = $fallback[$Key]
    if ($msg -and $Args) { $msg = $msg -f $Args }
    return $msg
}
```

This ensures scripts work even without the module present.

---

## Message Categories

| Category | Purpose | Example Keys |
|----------|---------|--------------|
| **docker.*** | Docker Desktop checks | docker.checking_installation, docker.not_installed |
| **service.*** | Windows service management | service.starting, service.already_running |
| **wizard.*** | First-run setup wizard | wizard.welcome_banner, wizard.next_steps |
| **test.*** | Installation verification | test.windows_version_tests, test.all_passed |
| **common.*** | Shared UI elements | common.success, common.warning, common.error |

---

## Key Technical Decisions

### 1. Separate Module vs. Inline Translations

**Decision:** Use a separate `.psm1` module

**Rationale:**
- Single source of truth for all translations
- Easier to add new languages later
- Translators can work on one file
- Reduces duplication across scripts

### 2. Registry vs. Config File for Language Setting

**Decision:** Use Windows Registry (`HKCU:\Software\ContPAQi\AIBridge\Settings`)

**Rationale:**
- Standard Windows practice for user preferences
- Persists across installations
- No file permission issues
- Accessible from Inno Setup installer

### 3. Placeholder Syntax

**Decision:** Use `{0}`, `{1}` style placeholders (PowerShell's `-f` operator)

**Rationale:**
- Native PowerShell formatting
- Consistent with .NET string formatting
- Works with `$msg -f $Args` syntax

---

## Testing Approach

### Test-Driven Development (TDD)

1. **First:** Wrote 244 tests defining expected message structure
2. **Second:** Implemented LocalizedMessages.psm1 to pass tests
3. **Third:** Updated each script to use the module

### Test Categories

1. **Structure tests** - Verify module exports and message categories exist
2. **Content tests** - Verify specific messages exist in both languages
3. **Parity tests** - Ensure every English key has a Spanish equivalent
4. **Behavior tests** - Validate interpolation, defaults, registry handling

---

## Adding a New Language

To add French (fr) support:

1. **Update LocalizedMessages.psm1:**
```powershell
'docker.checking_installation' = @{
    en = 'Checking Docker Desktop installation...'
    es = 'Verificando instalación de Docker Desktop...'
    fr = 'Vérification de l''installation de Docker Desktop...'  # Add French
}
```

2. **Update ValidateSet in each script:**
```powershell
[ValidateSet('en', 'es', 'fr')]
[string]$Language
```

3. **Add tests for French messages**

---

## Common Patterns Used

### Pattern 1: Localized Status Labels

```powershell
switch ($Level) {
    "Error"   { Write-Host "[$(Get-Msg 'common.error')] $Message" -ForegroundColor Red }
    "Warning" { Write-Host "[$(Get-Msg 'common.warning')] $Message" -ForegroundColor Yellow }
    "Success" { Write-Host "[$(Get-Msg 'common.success')] $Message" -ForegroundColor Green }
}
```

### Pattern 2: Interpolated Messages

```powershell
Write-Log (Get-Msg 'service.binary_not_found' -Args @($BinaryPath))
# English: "Binary not found at: C:\Program Files\..."
# Spanish: "Binario no encontrado en: C:\Program Files\..."
```

### Pattern 3: Conditional Messages

```powershell
if ($installCheck.Installed) {
    Write-Status (Get-Msg 'docker.found_at' -Args @($installCheck.Path)) "OK"
} else {
    Write-Status (Get-Msg 'docker.not_installed') "ERROR"
}
```

---

## Files Changed Summary

| File | Changes |
|------|---------|
| `LocalizedMessages.psm1` | Created (600+ lines, 140+ messages) |
| `check-docker.ps1` | Added i18n support, ~50 lines changed |
| `install-service.ps1` | Added i18n support, ~100 lines changed |
| `first-run-wizard.ps1` | Added i18n support, ~120 lines changed |
| `test-installation.ps1` | Added i18n support, ~80 lines changed |
| `powershell-localization.test.ts` | Created (244 tests) |

---

## Best Practices Learned

1. **Always provide fallbacks** - Scripts should work even if localization fails
2. **Use message keys, not hardcoded strings** - Makes maintenance easier
3. **Test message parity** - Ensure all languages have the same keys
4. **Support interpolation** - Dynamic content needs placeholders
5. **Centralize translations** - One file for all messages
6. **Document message categories** - Group related messages logically
