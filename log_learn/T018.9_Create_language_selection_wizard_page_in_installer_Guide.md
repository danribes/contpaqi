# Learning Guide - Subtask 18.9
## Creating a Language Selection Wizard Page in Inno Setup

**Date:** 2025-12-12

---

## What Was Developed

This subtask ensures the Inno Setup installer's language selection wizard page is properly configured and saves user preferences to the Windows Registry in a location consistent with the PowerShell localization scripts.

---

## Why This Was Needed

1. **User Experience:** Users should choose their preferred language during installation
2. **Consistency:** Registry path must match what PowerShell scripts read
3. **Per-User Settings:** Language is a user preference, should use HKCU not HKLM
4. **Integration:** Installer and runtime scripts must share the same configuration

---

## Inno Setup Wizard Pages

### What is a Wizard Page?

Inno Setup installers present a series of "wizard pages" to guide users through installation:

```
Welcome → License → Language Selection → Directory → Ready → Installing → Finish
                     ↑ (Custom page)
```

### Creating Custom Pages

Inno Setup provides `CreateInputOptionPage()` for radio-button selections:

```pascal
procedure InitializeWizard();
begin
  LanguagePage := CreateInputOptionPage(
    wpWelcome,                              // Insert after Welcome page
    'Page Title',                           // Title text
    'Subtitle',                             // Subtitle
    'Description text for user',            // Description
    True,                                   // Exclusive (radio buttons)
    False);                                 // Required

  LanguagePage.Add('Option 1');
  LanguagePage.Add('Option 2');
  LanguagePage.SelectedValueIndex := 0;    // Default selection
end;
```

---

## Registry Paths: HKLM vs HKCU

### HKLM (HKEY_LOCAL_MACHINE)
- Machine-wide settings
- Requires admin privileges to write
- Used for: install paths, version info, environment variables
- Same for all users on the computer

### HKCU (HKEY_CURRENT_USER)
- Per-user settings
- No admin privileges needed
- Used for: language preference, user options
- Different for each Windows user

### The Problem We Fixed

**Before (Incorrect):**
```pascal
// Writing to HKLM - wrong for user preferences
RegWriteStringValue(HKEY_LOCAL_MACHINE,
  'SOFTWARE\ContPAQi AI Bridge\ContPAQi AI Bridge',  // Double publisher name!
  'Language', 'en');
```

**After (Correct):**
```pascal
// Writing to HKCU - correct for user preferences
RegWriteStringValue(HKEY_CURRENT_USER,
  'SOFTWARE\ContPAQi AI Bridge',  // Matches PowerShell path
  'Language', 'en');
```

---

## Consistency Between Systems

### Why Paths Must Match

```
┌─────────────────────┐        ┌──────────────────────┐
│    Inno Setup       │        │   PowerShell         │
│    (Installer)      │        │   (Runtime)          │
│                     │        │                      │
│  WRITES to:         │──────> │  READS from:         │
│  HKCU\SOFTWARE\     │        │  HKCU:\SOFTWARE\     │
│  ContPAQi AI Bridge │        │  ContPAQi AI Bridge  │
│  \Language          │        │  \Language           │
└─────────────────────┘        └──────────────────────┘
```

If paths don't match, PowerShell scripts can't find the user's language preference!

### How We Ensured Consistency

Our tests cross-reference both files:

```typescript
it('should match PowerShell module registry path', () => {
  // Extract path from PowerShell module
  const psm1PathMatch = psm1Content.match(/\$script:RegistryPath/);

  // Verify Inno Setup uses the same path
  expect(issContent).toMatch(/SOFTWARE\\ContPAQi AI Bridge/);
});
```

---

## Inno Setup Custom Messages

### Bilingual Custom Messages

The `[CustomMessages]` section defines language-specific strings:

```ini
[CustomMessages]
english.SelectLanguage=Select Installation Language
spanish.SelectLanguage=Seleccione el Idioma de Instalación

english.LanguageEnglish=English
spanish.LanguageEnglish=Inglés
```

### Using Custom Messages in Code

```pascal
// ExpandConstant resolves {cm:MessageName} to current language
LanguagePage := CreateInputOptionPage(wpWelcome,
  ExpandConstant('{cm:SelectLanguage}'),    // Resolves based on installer language
  ExpandConstant('{cm:AppLanguage}'),
  ExpandConstant('{cm:LanguageSelectionPrompt}'),
  True, False);
```

---

## Language Detection Priority

### Inno Setup (Installer Time)

1. **ActiveLanguage** - Installer's current language
2. Falls back to default (English)

```pascal
if ActiveLanguage = 'spanish' then
  LanguagePage.SelectedValueIndex := 1  // Spanish
else
  LanguagePage.SelectedValueIndex := 0; // English
```

### PowerShell (Runtime)

1. **-Language Parameter** - Explicit override
2. **Registry Value** - Saved preference
3. **Default** - English

---

## The [Registry] Section

### Declarative vs Procedural

Inno Setup's `[Registry]` section runs automatically during install:

```ini
[Registry]
; Creates key if it doesn't exist
Root: HKCU; Subkey: "SOFTWARE\ContPAQi AI Bridge"; \
  ValueType: string; ValueName: "Language"; \
  ValueData: "en"; Flags: createvalueifdoesntexist
```

The `[Code]` section's `SaveLanguagePreference()` overwrites this with the user's actual selection.

---

## Testing Inno Setup Scripts

### Challenge: Can't Execute Pascal

Unlike PowerShell, we can't easily execute Inno Setup's Pascal code in tests.

### Solution: Text Pattern Matching

We parse the .iss file as text and validate structure:

```typescript
it('should write to HKCU', () => {
  expect(issContent).toMatch(/HKEY_CURRENT_USER/);
});

it('should NOT write language to HKLM', () => {
  const hklmLanguagePattern = /RegWriteStringValue.*HKEY_LOCAL_MACHINE.*Language/;
  expect(issContent).not.toMatch(hklmLanguagePattern);
});
```

---

## Files Changed Summary

| File | Changes |
|------|---------|
| `contpaqi-bridge.iss` | Fixed registry path (HKLM → HKCU), updated path format |
| `inno-setup-language-page.test.ts` | Created (39 tests) |

---

## Key Takeaways

1. **User preferences go in HKCU**, machine settings go in HKLM
2. **Path consistency is critical** when multiple systems share configuration
3. **Custom wizard pages** enhance installation UX
4. **Test cross-system integration** to catch path mismatches
5. **Inno Setup CustomMessages** enable easy localization

---

## Common Inno Setup Patterns

### Pattern 1: Getting User Selection

```pascal
function GetSelectedLanguage(): String;
begin
  if LanguagePage.SelectedValueIndex = 1 then
    Result := 'es'
  else
    Result := 'en';
end;
```

### Pattern 2: Saving to Registry

```pascal
RegWriteStringValue(HKEY_CURRENT_USER,
  'SOFTWARE\MyApp',
  'ValueName',
  'Value');
```

### Pattern 3: Reading from Registry

```pascal
if RegQueryStringValue(HKEY_CURRENT_USER,
  'SOFTWARE\MyApp',
  'ValueName',
  ResultVar) then
  // Value found
else
  // Use default
```

### Pattern 4: Post-Install Actions

```pascal
procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssPostInstall then
    SaveLanguagePreference();
end;
```

---

## CI/CD Troubleshooting (Windows Runners)

This implementation encountered two CI failures that provide valuable lessons for Windows-based GitHub Actions workflows.

### Issue 1: Missing ASP.NET Core Configuration Files

**Symptom:**
```
Cannot find path 'appsettings.json' because it does not exist.
```

**Problem:** The workflow expected `appsettings.json` to exist, but it wasn't in the repository.

**Solution:**
1. Create the configuration files in the .NET project
2. Update `.csproj` to ensure files are copied during publish:
```xml
<ItemGroup>
  <Content Update="appsettings.json">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </Content>
</ItemGroup>
```

**Lesson:** Always ensure all required files exist and are properly configured for CI/CD.

---

### Issue 2: PowerShell vs Bash on Windows Runners

**Symptom:**
```
Could not find a part of the path 'D:\dev\null'.
```

**Problem:** Windows doesn't have `/dev/null`. The workflow step was using bash syntax (`2>/dev/null`) but running in PowerShell.

**Why This Happens:**
- GitHub Actions Windows runners default to PowerShell
- Steps without `shell:` specified use the default
- Unix commands like `mkdir -p`, `cp`, and `2>/dev/null` don't work in PowerShell

**Solution:** Explicitly specify `shell: bash` for steps using Unix commands:

```yaml
- name: My step with Unix commands
  run: |
    mkdir -p some/dir
    cp file.txt dest/ 2>/dev/null || true
  shell: bash  # <-- CRITICAL on Windows runners
```

**Alternative (PowerShell syntax):**
```yaml
- name: My step with PowerShell
  run: |
    New-Item -ItemType Directory -Force -Path some/dir
    Copy-Item file.txt dest/ -ErrorAction SilentlyContinue
  # No shell: specified = PowerShell on Windows
```

---

### Windows CI Best Practices

| Pattern | Bash | PowerShell |
|---------|------|------------|
| Create directory | `mkdir -p dir` | `New-Item -ItemType Directory -Force -Path dir` |
| Copy file | `cp src dest` | `Copy-Item src dest` |
| Suppress errors | `2>/dev/null` | `-ErrorAction SilentlyContinue` |
| Continue on error | `|| true` | `-ErrorAction SilentlyContinue` or `try/catch` |
| Null device | `/dev/null` | `$null` |

**Recommendation:** Use `shell: bash` consistently for cross-platform scripts, or write platform-specific steps with explicit shell declarations.
