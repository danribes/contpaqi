# T014.2 PDF Viewer - Guide

## What Was Developed

This subtask implements a **full-featured PDF viewer** using `react-pdf` library. The viewer provides essential functionality for the invoice verification workflow:
- Page navigation (prev/next, go to page)
- Zoom controls (in/out, presets, fit width/page)
- Keyboard shortcuts for efficiency
- Loading and error states

## Why It Was Developed

### Business Need
In the Human-in-the-Loop verification interface, users need to:
1. **View** the original PDF invoice
2. **Navigate** through multi-page documents
3. **Zoom** to inspect details
4. **Compare** the PDF against extracted data

A dedicated PDF viewer provides these capabilities within the application, eliminating the need for external software.

### Technical Requirements
- Display PDF documents in the browser
- Support various zoom levels
- Enable efficient navigation
- Handle loading and errors gracefully
- Integrate with the split-screen layout

## How It Was Developed

### 1. Library Selection: react-pdf

**Why react-pdf?**
- Built on Mozilla's pdf.js (industry standard)
- React-native integration
- Renders PDF as canvas with optional text/annotation layers
- Active maintenance and TypeScript support

**Installation:**
```bash
npm install react-pdf
```

**Worker Configuration:**
```typescript
import { pdfjs } from 'react-pdf';

// Configure PDF.js worker (required for parsing)
pdfjs.GlobalWorkerOptions.workerSrc =
  `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;
```

### 2. Component Architecture

```
PDFViewer
├── PDFToolbar
│   ├── Page Navigation (prev/next/input)
│   ├── Zoom Controls (in/out/select)
│   └── Fit Buttons (width/page)
├── Document Container
│   ├── Loading Spinner
│   ├── Error Display
│   └── react-pdf Document
│       └── Page (with text/annotation layers)
```

### 3. State Management

```typescript
const [loadingState, setLoadingState] = useState<LoadingState>('idle');
const [currentPage, setCurrentPage] = useState(initialPage);
const [totalPages, setTotalPages] = useState(0);
const [scale, setScale] = useState(initialScale);
const [error, setError] = useState<string | null>(null);
const [pageSize, setPageSize] = useState({ width: 0, height: 0 });
```

**State Flow:**
```
idle → (file provided) → loading → loaded/error
                              ↓
                     (user interaction)
                              ↓
                  page/scale state updates
```

### 4. Navigation Implementation

```typescript
function goToPage(targetPage: number, totalPages: number): number {
  // Clamp to valid range
  if (targetPage < 1) return 1;
  if (targetPage > totalPages) return totalPages;
  return targetPage;
}

// Usage
const handleNextPage = () => {
  setCurrentPage(prev => goToPage(prev + 1, totalPages));
};
```

### 5. Zoom Implementation

```typescript
const DEFAULT_ZOOM_OPTIONS = {
  minScale: 0.5,   // 50%
  maxScale: 3.0,   // 300%
  step: 0.25,      // 25% increments
};

function zoomIn(currentScale: number, options = DEFAULT_ZOOM_OPTIONS): number {
  const newScale = currentScale + options.step;
  return Math.min(newScale, options.maxScale);
}

function zoomOut(currentScale: number, options = DEFAULT_ZOOM_OPTIONS): number {
  const newScale = currentScale - options.step;
  return Math.max(newScale, options.minScale);
}
```

### 6. Fit Width/Page Calculation

```typescript
const handleFitWidth = useCallback(() => {
  if (!containerRef.current || pageSize.width === 0) return;

  const containerWidth = containerRef.current.clientWidth - 40; // padding
  const newScale = containerWidth / pageSize.width;

  setScale(setZoom(newScale)); // clamp to min/max
}, [pageSize.width]);

const handleFitPage = useCallback(() => {
  if (!containerRef.current || !pageSize.width || !pageSize.height) return;

  const containerWidth = containerRef.current.clientWidth - 40;
  const containerHeight = containerRef.current.clientHeight - 40;

  const fitW = containerWidth / pageSize.width;
  const fitH = containerHeight / pageSize.height;

  // Use minimum to ensure page fits in both dimensions
  setScale(setZoom(Math.min(fitW, fitH)));
}, [pageSize]);
```

### 7. Keyboard Shortcuts

```typescript
useEffect(() => {
  const handleKeyDown = (e: KeyboardEvent) => {
    if (loadingState !== 'loaded') return;

    const cmdOrCtrl = e.ctrlKey || e.metaKey;

    // Page navigation
    if (e.key === 'ArrowRight' || e.key === 'PageDown') {
      e.preventDefault();
      handleNextPage();
    }
    if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
      e.preventDefault();
      handlePrevPage();
    }

    // Zoom with Ctrl/Cmd
    if (cmdOrCtrl && (e.key === '=' || e.key === '+')) {
      e.preventDefault();
      handleZoomIn();
    }
    if (cmdOrCtrl && e.key === '-') {
      e.preventDefault();
      handleZoomOut();
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [loadingState, handleNextPage, handlePrevPage, handleZoomIn, handleZoomOut]);
```

**Key insight**: Use `e.preventDefault()` to stop browser default zoom behavior when using Ctrl+/-

## Key Learnings

### 1. PDF.js Worker Setup
The worker must be configured before any PDF operations. Using the CDN approach simplifies bundling:
```typescript
pdfjs.GlobalWorkerOptions.workerSrc =
  `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;
```

### 2. Page Size Detection
To implement fit-to-width/page, you need actual page dimensions. Get them from the `onLoadSuccess` callback:
```typescript
<Page
  onLoadSuccess={({ width, height }) => setPageSize({ width, height })}
/>
```

### 3. Cross-Platform Keyboard Shortcuts
Always check both `ctrlKey` and `metaKey` for Ctrl/Cmd shortcuts:
```typescript
const cmdOrCtrl = e.ctrlKey || e.metaKey;
```

### 4. Prevent Browser Zoom
Use `e.preventDefault()` to stop browser zoom when handling Ctrl+/- shortcuts.

### 5. File Input Styling
Use a hidden input with a styled label for better UX:
```tsx
<input type="file" id="upload" className="hidden" onChange={...} />
<label htmlFor="upload" className="styled-button">Select File</label>
```

## Integration Example

```tsx
import { PDFViewer } from './components/PDFViewer';

function VerificationView() {
  const [pdfFile, setPdfFile] = useState<File | null>(null);

  return (
    <SplitScreenLayout
      leftPanel={
        <PDFViewer
          file={pdfFile}
          onPageChange={(page) => console.log('Page:', page)}
          onDocumentLoad={(total) => console.log('Total pages:', total)}
          onError={(err) => console.error('Error:', err)}
        />
      }
      rightPanel={<InvoiceForm />}
    />
  );
}
```

## Future Enhancements

1. **Text Selection**: Enable text selection for copy/paste
2. **Search**: Find text within PDF
3. **Thumbnails**: Page thumbnail navigation
4. **Annotations**: Highlight areas related to form fields
5. **Print**: Direct print functionality
6. **Download**: Save original PDF
