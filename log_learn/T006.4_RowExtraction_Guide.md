# T006.4 Row Extraction - Learning Guide

## Overview
This guide explains how to extract and process table rows for invoice line items.

## Why Extract Rows?

Invoices have line items:
```
Description          Qty    Price    Amount
Widget Pro            5    $200.00  $1,000.00
Service Package       1    $500.00    $500.00
```

Each line = one row. We need to:
1. Detect all rows
2. Sort top-to-bottom
3. Get bounding boxes for word assignment

## get_table_rows() Method

```python
def get_table_rows(self, image, threshold=None):
    # 1. Get all detections
    detections = self.detect(image, threshold)

    # 2. Filter for rows only
    rows = [d for d in detections if d.label == 'table row']

    # 3. Sort by y-coordinate
    rows.sort(key=lambda r: r.bbox[1])

    # 4. Return with indices
    return [
        {'bbox': row.bbox, 'confidence': row.confidence, 'index': i}
        for i, row in enumerate(rows)
    ]
```

## Row Sorting

### Why Sort?
TATR returns detections in no particular order:
```
[row_3, row_1, row_5, row_2, row_4]  # Random order
```

For invoices, we need top-to-bottom:
```
[row_1, row_2, row_3, row_4, row_5]  # Sorted
```

### Sorting by Y-Coordinate
```python
rows.sort(key=lambda r: r.bbox[1])
```

`bbox = (x1, y1, x2, y2)`
- `bbox[1]` = y1 = top edge
- Smaller y = higher on page
- Sort ascending = top to bottom

## get_table_bounds() Method

```python
def get_table_bounds(self, image, threshold=None):
    detections = self.detect(image, threshold)

    # Filter for tables
    tables = [d for d in detections if d.label == 'table']

    if not tables:
        return None

    # Return highest confidence
    best_table = max(tables, key=lambda t: t.confidence)
    return {'bbox': best_table.bbox, 'confidence': best_table.confidence}
```

## Why Highest Confidence?

Multiple tables might be detected:
- Main invoice table (high confidence)
- Header info that looks like table (lower confidence)
- Footer notes (lower confidence)

We want the main table = highest confidence.

## Return Format

### get_table_rows()
```python
[
    {'bbox': (10, 100, 790, 130), 'confidence': 0.95, 'index': 0},
    {'bbox': (10, 140, 790, 170), 'confidence': 0.92, 'index': 1},
    {'bbox': (10, 180, 790, 210), 'confidence': 0.89, 'index': 2},
]
```

### get_table_bounds()
```python
{'bbox': (0, 50, 800, 400), 'confidence': 0.98}
# or None if no table
```

## Integration with OCR

```
1. OCR extracts words with bboxes
2. TATR extracts row bboxes
3. Match words to rows by y-overlap
4. Each row â†’ one line item
```

Example matching:
```python
for row in rows:
    row_y1, row_y2 = row['bbox'][1], row['bbox'][3]
    row_words = [w for w in words
                 if row_y1 <= w.bbox[1] <= row_y2]
```
