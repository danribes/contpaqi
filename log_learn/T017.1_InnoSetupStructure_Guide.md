# Learning Guide: Subtask 17.1 - Create Inno Setup Script Structure

## What Is Inno Setup?

Inno Setup is a free script-driven installation system for Windows applications.

```
┌─────────────────────────────────────────────────────────┐
│ Inno Setup Workflow                                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   .iss Script  →  Inno Compiler  →  Setup.exe          │
│                                                         │
│   (config)         (ISCC.exe)       (installer)        │
└─────────────────────────────────────────────────────────┘
```

---

## ISS Script Structure

### Basic Sections

```ini
[Setup]           ; Application metadata
[Languages]       ; Supported languages
[Tasks]           ; Optional installation tasks
[Dirs]            ; Directories to create
[Files]           ; Files to install
[Icons]           ; Shortcuts to create
[Registry]        ; Registry entries
[Run]             ; Post-install commands
[UninstallRun]    ; Pre-uninstall commands
[Code]            ; Pascal Script code
```

---

## [Setup] Section

The most important section - defines application metadata:

```ini
[Setup]
AppId={{GUID-HERE}}
AppName=My Application
AppVersion=1.0.0
AppPublisher=My Company
DefaultDirName={autopf}\My Application
OutputBaseFilename=MyApp-Setup
Compression=lzma2/ultra64
PrivilegesRequired=admin
MinVersion=10.0
ArchitecturesInstallIn64BitMode=x64
```

### Key Settings

| Setting | Purpose |
|---------|---------|
| AppId | Unique GUID for the application |
| AppName | Display name |
| AppVersion | Version number |
| DefaultDirName | Installation path |
| OutputBaseFilename | Installer filename |
| Compression | Compression algorithm |
| PrivilegesRequired | Required permissions |
| MinVersion | Minimum Windows version |

---

## [Files] Section

Defines which files to install:

```ini
[Files]
; Main executable
Source: "dist\app.exe"; DestDir: "{app}"; Flags: ignoreversion

; Subdirectory with all files
Source: "dist\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

; Config file (don't overwrite if exists)
Source: "config.json"; DestDir: "{app}"; Flags: onlyifdoesntexist
```

### Common Flags

| Flag | Purpose |
|------|---------|
| ignoreversion | Always overwrite |
| recursesubdirs | Include subdirectories |
| createallsubdirs | Create empty directories |
| onlyifdoesntexist | Don't overwrite existing |

---

## [Dirs] Section

Creates directories with specific permissions:

```ini
[Dirs]
Name: "{app}\logs"; Permissions: users-modify
Name: "{app}\data"; Permissions: users-full
Name: "{app}\config"; Permissions: users-modify
```

---

## [Icons] Section

Creates shortcuts:

```ini
[Icons]
; Start Menu
Name: "{group}\My App"; Filename: "{app}\app.exe"
Name: "{group}\Uninstall"; Filename: "{uninstallexe}"

; Desktop (optional task)
Name: "{autodesktop}\My App"; Filename: "{app}\app.exe"; Tasks: desktopicon
```

---

## [Registry] Section

Creates registry entries:

```ini
[Registry]
; Application registration
Root: HKLM; Subkey: "SOFTWARE\MyCompany\MyApp"; \
    ValueType: string; ValueName: "InstallPath"; ValueData: "{app}"

; Environment variable
Root: HKLM; Subkey: "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"; \
    ValueType: expandsz; ValueName: "MY_APP_HOME"; ValueData: "{app}"
```

---

## [Code] Section

Pascal Script for custom logic:

```pascal
[Code]
function InitializeSetup(): Boolean;
begin
  Result := True;

  // Check prerequisites
  if not CheckSomething() then
  begin
    MsgBox('Prerequisite missing!', mbError, MB_OK);
    Result := False;
  end;
end;

procedure CurStepChanged(CurStep: TSetupStep);
begin
  if CurStep = ssPostInstall then
  begin
    // Run after installation
    MsgBox('Installation complete!', mbInformation, MB_OK);
  end;
end;
```

### Common Functions

| Function | When Called |
|----------|-------------|
| InitializeSetup() | Before installation starts |
| InitializeWizard() | When wizard is created |
| NextButtonClick() | When Next is clicked |
| CurStepChanged() | At each installation step |
| CurUninstallStepChanged() | During uninstallation |

---

## Directory Constants

| Constant | Path |
|----------|------|
| {app} | Installation directory |
| {autopf} | Program Files (auto 32/64) |
| {commonpf} | Common Program Files |
| {win} | Windows directory |
| {sys} | System32 directory |
| {tmp} | Temporary directory |
| {group} | Start Menu program group |
| {autodesktop} | Desktop |

---

## Prerequisites Check Example

```pascal
function DockerInstalled(): Boolean;
begin
  Result := FileExists(
    ExpandConstant('{commonpf}\Docker\Docker\Docker Desktop.exe')
  );
end;

function InitializeSetup(): Boolean;
begin
  Result := True;

  if not DockerInstalled() then
  begin
    if MsgBox('Docker not found. Continue?',
              mbConfirmation, MB_YESNO) = IDNO then
      Result := False;
  end;
end;
```

---

## Compression Options

| Option | Size | Speed |
|--------|------|-------|
| zip | Largest | Fastest |
| bzip | Medium | Medium |
| lzma | Small | Slow |
| lzma2/ultra64 | Smallest | Slowest |

Recommended for distribution: `lzma2/ultra64`

---

## Multi-Language Support

```ini
[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "spanish"; MessagesFile: "compiler:Languages\Spanish.isl"
Name: "german"; MessagesFile: "compiler:Languages\German.isl"
```

---

## Building the Installer

### Command Line
```cmd
ISCC.exe contpaqi-bridge.iss
```

### Output
```
installer/output/ContPAQi-AI-Bridge-Setup-1.0.0.exe
```

---

## Code Signing

Add to [Setup]:
```ini
SignTool=signtool sign /tr http://timestamp.digicert.com /td sha256 /fd sha256 /a $f
```

---

## Best Practices

### DO:
- Use GUIDs for AppId
- Set minimum Windows version
- Check prerequisites in [Code]
- Use {autopf} for 64-bit support
- Include uninstaller

### DON'T:
- Hardcode paths
- Skip prerequisites checks
- Forget registry cleanup
- Ignore silent install mode

---

## Summary

| Section | Purpose |
|---------|---------|
| [Setup] | Application metadata |
| [Files] | Files to install |
| [Dirs] | Directories to create |
| [Icons] | Shortcuts |
| [Registry] | Registry entries |
| [Run] | Post-install commands |
| [Code] | Custom Pascal logic |

---

## Next Steps

After this subtask:
1. **17.2**: Docker Desktop prerequisite check
2. **17.3**: Windows Service installation
3. **17.4**: Bundle Docker image
