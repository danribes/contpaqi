# T009.5 Math Verification - Learning Guide

## Overview
This guide explains how to implement invoice math validation for Mexican invoices.

## Mexican Invoice Structure

Mexican invoices (facturas) have a standard structure:

```
Subtotal:  $1,000.00  <- Sum of line items
IVA (16%):   $160.00  <- Tax (16% of subtotal)
Total:     $1,160.00  <- Subtotal + IVA
```

## Validation Rules

### 1. Total Calculation
```python
total == subtotal + iva
```

### 2. IVA Rate (16%)
```python
0.15 <= (iva / subtotal) <= 0.17
```

### 3. Line Items Sum
```python
sum(item['amount'] for item in line_items) == subtotal
```

## Handling Floating Point Precision

### The Problem
Floating point numbers can have precision issues:
```python
>>> 0.1 + 0.2
0.30000000000000004
```

### The Solution: Tolerance
```python
AMOUNT_TOLERANCE = 0.01

def amounts_equal(a: float, b: float) -> bool:
    return abs(a - b) <= AMOUNT_TOLERANCE
```

## Implementation Pattern

### Single Validation Function
```python
def validate_iva_rate(subtotal: float, iva: float) -> Tuple[bool, str]:
    if subtotal <= 0:
        return True, ""  # Skip check

    rate = iva / subtotal
    if not (0.15 <= rate <= 0.17):
        return False, f"IVA rate {rate:.2%} is not ~16%"

    return True, ""
```

### Combined Validation Function
```python
def validate_math(subtotal, iva, total, line_items=None) -> Tuple[bool, List[str]]:
    errors = []

    # Check 1: Total
    if abs(total - (subtotal + iva)) > 0.01:
        errors.append("Total mismatch")

    # Check 2: IVA rate
    is_valid, error = validate_iva_rate(subtotal, iva)
    if not is_valid:
        errors.append(error)

    # Check 3: Line items
    if line_items:
        is_valid, error = validate_line_items_sum(line_items, subtotal)
        if not is_valid:
            errors.append(error)

    return len(errors) == 0, errors
```

## Edge Cases

### Zero Values
```python
# Zero subtotal - skip IVA rate check (avoid division by zero)
if subtotal <= 0:
    return True, ""
```

### Empty Line Items
```python
# No line items - skip sum check
if not line_items:
    return True, ""
```

### Rounding Differences
```python
# 1234.56 * 0.16 = 197.5296
# Round to 197.53, which may cause 0.01 difference
```

## Return Value Pattern

### Single Check
```python
def validate_x() -> Tuple[bool, str]:
    return is_valid, error_message
```

### Combined Checks
```python
def validate_all() -> Tuple[bool, List[str]]:
    return is_valid, list_of_errors
```

## Key Takeaways

1. **Tolerance**: Always use tolerance for floating point comparisons
2. **16% IVA**: Standard Mexican tax rate, allow 15-17% range
3. **Skip Empty**: Don't fail on missing optional data
4. **Collect Errors**: Return all errors, not just the first one
5. **Avoid Division by Zero**: Check for zero before dividing
