# Learning Guide: Subtask 16.3 - Modify Dockerfile for Obfuscated Code

## Why Two Dockerfiles?

### Development vs Production

| Aspect | Development | Production |
|--------|-------------|------------|
| Source | Original (src/) | Obfuscated (dist/) |
| Build Speed | Fast | Slower (includes obfuscation) |
| Debugging | Easy | Difficult |
| Security | None | Protected |

### Dockerfile Naming Convention
```
Dockerfile        # Default, used for development
Dockerfile.prod   # Production with obfuscated code
Dockerfile.test   # For testing (if needed)
```

---

## Multi-Stage Docker Builds

### What Is Multi-Stage?
A Dockerfile with multiple `FROM` statements, each creating a separate "stage".

```dockerfile
# Stage 1: Builder
FROM python:3.9-slim as builder
# Install build tools, create wheels

# Stage 2: Runtime (final image)
FROM python:3.9-slim
# Copy only what's needed from builder
```

### Benefits
1. **Smaller Images**: Final image doesn't include build tools
2. **Security**: Build dependencies not in production
3. **Caching**: Stages can be cached independently

### Our Multi-Stage Build
```
┌─────────────────────────────────────┐
│ Stage 1: Builder                    │
│ ┌─────────────────────────────────┐ │
│ │ • Python 3.9 slim               │ │
│ │ • build-essential               │ │
│ │ • pip wheel creation            │ │
│ └─────────────────────────────────┘ │
└──────────────────┬──────────────────┘
                   │ COPY --from=builder
                   ▼
┌─────────────────────────────────────┐
│ Stage 2: Runtime                    │
│ ┌─────────────────────────────────┐ │
│ │ • Python 3.9 slim               │ │
│ │ • Runtime deps only             │ │
│ │ • Wheels from builder           │ │
│ │ • Obfuscated code (dist/)       │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

---

## Using ARG for Flexibility

### What Is ARG?
Build-time variables that can be overridden.

```dockerfile
ARG PYTHON_VERSION=3.9
FROM python:${PYTHON_VERSION}-slim-bullseye
```

### Override at Build Time
```bash
docker build --build-arg PYTHON_VERSION=3.10 -f Dockerfile.prod .
```

### ARG vs ENV
| Directive | Available When | Persists |
|-----------|----------------|----------|
| ARG | Build time only | No |
| ENV | Build + Runtime | Yes |

```dockerfile
ARG APP_VERSION=1.0.0      # Only during build
ENV APP_ENV=production     # Available at runtime too
```

---

## Docker Labels

### What Are Labels?
Metadata attached to images for identification.

```dockerfile
LABEL maintainer="ContPAQi AI Bridge Team"
LABEL version="${APP_VERSION}"
LABEL build.type="production"
LABEL build.obfuscated="true"
```

### Viewing Labels
```bash
docker inspect contpaqi-mcp:latest --format='{{json .Config.Labels}}'
```

### Benefits
1. **Image Identification**: Know what's in the image
2. **CI/CD Integration**: Filter images by labels
3. **Documentation**: Self-documenting images

---

## Security Best Practices

### 1. Non-Root User
```dockerfile
# Create user
RUN useradd -m -s /bin/bash appuser

# Switch to non-root
USER appuser

# Everything after runs as appuser
CMD ["uvicorn", ...]
```

### Why Non-Root?
- Container escape attacks are limited
- Follows principle of least privilege
- Required by many Kubernetes deployments

### 2. Specific Base Version
```dockerfile
# Bad - unpredictable
FROM python:latest

# Good - reproducible
FROM python:3.9-slim-bullseye
```

### 3. Clean Up After Install
```dockerfile
RUN apt-get update && apt-get install -y ... \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean
```

### 4. No Secrets in Dockerfile
```dockerfile
# NEVER do this
ENV API_KEY=secret123

# Instead, use runtime injection
# docker run -e API_KEY=$API_KEY ...
```

---

## Copying Obfuscated Code

### The Key Change
```dockerfile
# Development (Dockerfile)
COPY src/ ./src/

# Production (Dockerfile.prod)
COPY dist/ ./src/
```

### Why Copy to src/?
The application expects modules at `src.main:app`. By copying `dist/` to `./src/`, we maintain the same import structure:

```python
# Works with both src/ and dist/ copied to src/
uvicorn src.main:app
```

---

## Docker Layer Caching

### Order Matters!
```dockerfile
# GOOD: Requirements rarely change
COPY requirements.txt .
RUN pip install -r requirements.txt

# Application code changes often
COPY dist/ ./src/
```

If code changes but requirements don't, Docker reuses the cached pip install layer.

### WRONG Order
```dockerfile
# BAD: Code change invalidates pip cache
COPY dist/ ./src/
COPY requirements.txt .
RUN pip install -r requirements.txt
```

---

## Environment Variables

### Production-Specific
```dockerfile
ENV PYTHONUNBUFFERED=1       # Flush output immediately
ENV PYTHONDONTWRITEBYTECODE=1 # Don't create .pyc files
ENV APP_ENV=production        # App can check this
```

### Why PYTHONUNBUFFERED?
Without it, Python buffers stdout. In containers, you want logs immediately:
```
2024-01-01 12:00:00 - Starting up...
```

### Why PYTHONDONTWRITEBYTECODE?
Obfuscated code shouldn't create new bytecode files.

---

## Health Checks

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1
```

### Parameters
| Parameter | Description |
|-----------|-------------|
| `--interval` | Time between checks |
| `--timeout` | Max time for check |
| `--start-period` | Grace period on startup |
| `--retries` | Failures before unhealthy |

### Docker Compose Uses Health
```yaml
services:
  app:
    depends_on:
      db:
        condition: service_healthy
```

---

## Build Commands Summary

```bash
# Development
make build-dev
# Uses: docker build -t contpaqi-mcp:dev .

# Production
make build
# Runs: obfuscate → docker build -f Dockerfile.prod ...

# Direct Docker commands
docker build -t contpaqi-mcp:dev .                    # Dev
docker build -f Dockerfile.prod -t contpaqi-mcp .     # Prod
```

---

## Summary

| Concept | Key Point |
|---------|-----------|
| Two Dockerfiles | Dev uses src/, prod uses dist/ |
| Multi-stage | Builder for wheels, runtime for app |
| ARG | Build-time variables |
| Labels | Image metadata |
| Non-root | Security best practice |
| Layer caching | Copy requirements before code |
| Health check | Container health monitoring |

---

## Next Steps

After this subtask:
1. **16.4**: Configure Dotfuscator for C# code
2. **16.5**: Enable string encryption
3. **16.6**: Test obfuscated code functionality
