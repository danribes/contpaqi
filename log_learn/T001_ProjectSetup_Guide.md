# T001 - Project Setup & Scaffolding - Learning Guide

**Task**: Task 1 - Project Setup & Scaffolding
**Date**: 2025-12-03
**Audience**: Developers new to the Contpaqi AI Bridge project

---

## What Was Built

This task established the foundational structure for a **multi-component desktop application** that uses AI to process invoices and integrate with Contpaqi accounting software.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    Contpaqi AI Bridge                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │  Desktop App │    │ MCP Container │    │Windows Bridge│  │
│  │  (Electron)  │◄──►│   (Docker)    │    │   (C#/.NET)  │  │
│  │   React/TS   │    │   Python/AI   │    │  Contpaqi SDK│  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Why This Structure?

### 1. Separation of Concerns

Each component handles a specific responsibility:

| Component | Responsibility | Language |
|-----------|----------------|----------|
| MCP Container | AI inference (OCR, table detection) | Python |
| Windows Bridge | Contpaqi SDK integration | C# |
| Desktop App | User interface | TypeScript/React |

### 2. Technical Constraints

- **Contpaqi SDK requires x86**: The Contpaqi SDK is a COM library that only works in 32-bit processes. This is why the Windows Bridge project has `<PlatformTarget>x86</PlatformTarget>`.

- **AI models are large**: PyTorch and Transformers need specific versions and GPU support. Docker isolates these dependencies.

- **SDK operations must be sequential**: The Windows Bridge uses a `JobQueueService` to ensure only one SDK operation runs at a time.

### 3. Security

- **Localhost only**: The Windows Bridge binds to `127.0.0.1:5000` only, preventing network access.
- **Non-root Docker user**: The MCP Container runs as `appuser` for security.

---

## Key Concepts Explained

### Multi-Stage Docker Build

```dockerfile
# Stage 1: Build dependencies
FROM python:3.9-slim-bullseye as builder
# ... compile wheels ...

# Stage 2: Runtime only
FROM python:3.9-slim-bullseye
COPY --from=builder /app/wheels /wheels
```

**Why?** The builder stage has compilers and development tools. The final image only contains runtime dependencies, making it smaller and more secure.

### x86 Platform Target (C#)

```xml
<PlatformTarget>x86</PlatformTarget>
```

**Why?** Contpaqi's MGW_SDK.dll is a 32-bit COM library. A 64-bit process cannot load 32-bit COM objects.

### Job Queue Pattern (C#)

```csharp
Channel<InvoiceJob> _queue = Channel.CreateBounded<InvoiceJob>(100);

// Producer (controller)
await _queue.Writer.WriteAsync(job);

// Consumer (background service)
await foreach (var job in _queue.Reader.ReadAllAsync(token)) {
    await ProcessJob(job);
    await Task.Delay(500); // SDK cooldown
}
```

**Why?** The Contpaqi SDK crashes if you call it from multiple threads simultaneously. The queue ensures sequential processing.

### pyproject.toml vs requirements.txt

- **pyproject.toml**: Modern Python project configuration. Defines project metadata, dependencies with version ranges, and tool settings.
- **requirements.txt**: Pinned versions for Docker. Ensures reproducible builds.

---

## Directory Structure Explained

```
contpaqi/
├── data/               # Training data (generated by Task 2)
│   ├── synthetic/      # Auto-generated invoices
│   ├── train/          # 80% for training
│   ├── validation/     # 10% for validation
│   └── test/           # 10% for testing
│
├── scripts/            # Data generation scripts
│
├── mcp-container/      # Python AI component
│   ├── src/
│   │   ├── models/     # TATR, LayoutLM wrappers
│   │   └── utils/      # OCR, validation helpers
│   └── tests/          # Python tests
│
├── windows-bridge/     # C# SDK component
│   └── src/
│       └── ContpaqiBridge/
│           ├── Controllers/  # API endpoints
│           ├── Services/     # Business logic
│           └── Models/       # Data classes
│
├── desktop-app/        # Electron UI component
│   ├── electron/       # Main process (Node.js)
│   └── src/            # React components
│
└── installer/          # Windows installer scripts
```

---

## Technology Choices

### Python for AI

- **PyTorch**: Deep learning framework for model inference
- **Transformers**: Hugging Face library for TATR and LayoutLMv3
- **Tesseract**: Open-source OCR with Spanish support
- **FastAPI**: Modern async Python web framework

### C# for Windows Integration

- **ASP.NET Core**: Web API framework
- **COM Interop**: Allows calling Contpaqi SDK
- **System.Threading.Channels**: High-performance queue

### TypeScript/React for UI

- **Electron**: Desktop app framework using Chromium
- **React**: Component-based UI library
- **Tailwind CSS**: Utility-first CSS framework

---

## Configuration Files Explained

### pyproject.toml

```toml
[project]
name = "mcp-container"
dependencies = ["fastapi>=0.104.0", ...]

[tool.ruff]
line-length = 88
select = ["E", "W", "F", "I"]  # Linting rules
```

### package.json

```json
{
  "scripts": {
    "dev": "vite",           // Development server
    "build": "vite build",   // Production build
    "lint": "eslint src"     // Check code style
  }
}
```

### Dockerfile

```dockerfile
FROM python:3.9-slim-bullseye  # Base image
RUN apt-get install tesseract-ocr-spa  # Spanish OCR
EXPOSE 8000                    # API port
HEALTHCHECK CMD curl -f http://localhost:8000/health
```

---

## TDD Workflow Used

1. **Write tests first** (`tests/test_task001_project_setup.py`)
2. **Run tests - all fail** (27 failures)
3. **Implement structure**
4. **Run tests - all pass** (27 passed)
5. **Document in logs**

This ensures we build exactly what's needed and nothing more.

---

## Common Pitfalls Avoided

1. **Mixing architectures**: x86/x64 conflicts cause hard-to-debug crashes
2. **Concurrent SDK calls**: Would crash Contpaqi
3. **Hardcoded ports**: Using constants makes configuration easier
4. **Missing .gitkeep**: Empty directories aren't tracked by Git

---

## Next Steps

With the project structure in place, Task 2 will:
1. Create synthetic invoice data for AI training
2. Generate PDF files with random Mexican business data
3. Create ground truth JSON labels for each invoice

This training data will be used to fine-tune the TATR and LayoutLM models.
