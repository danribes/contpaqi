# T008.7 Confidence Scoring - Learning Guide

## Overview
This guide explains the confidence scoring system that provides a quality metric for invoice extraction results.

## Why Confidence Scoring?

Confidence scoring helps users and applications:
1. **Filter Results**: Reject low-confidence extractions
2. **Manual Review**: Flag uncertain extractions for review
3. **Quality Monitoring**: Track extraction quality over time
4. **Decision Making**: Determine when human verification is needed

## The Three Pillars of Confidence

```
┌─────────────────────────────────────────────────────────────────┐
│                    OVERALL CONFIDENCE                           │
│                                                                 │
│     ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│     │     OCR      │  │    Field     │  │   Required   │       │
│     │  Confidence  │  │  Confidence  │  │    Fields    │       │
│     └──────┬───────┘  └──────┬───────┘  └──────┬───────┘       │
│            │                 │                 │               │
│            v                 v                 v               │
│     ┌──────────────────────────────────────────────────┐       │
│     │              AVERAGE OF ALL SCORES               │       │
│     └──────────────────────────────────────────────────┘       │
│                            │                                   │
│                            v                                   │
│                      0.0 - 1.0                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 1. OCR Confidence
How well OCR recognized the text:
```python
if ocr_confidences:
    ocr_avg = sum(ocr_confidences) / len(ocr_confidences)
    scores.append(ocr_avg)
```
- Poor scan quality → low OCR confidence
- Clear, high-resolution images → high OCR confidence

### 2. Field Confidence
How certain the model is about field classification:
```python
for field in fields.values():
    if hasattr(field, 'confidence'):
        scores.append(field.confidence)
```
- Clear field labels → high field confidence
- Ambiguous text → low field confidence

### 3. Required Fields Presence
Are the essential fields present?
```python
required = ['RFC_EMISOR', 'RFC_RECEPTOR', 'TOTAL']
present = sum(1 for r in required if r in fields)
required_score = present / len(required)
scores.append(required_score)
```
- All required fields found → score of 1.0
- Two of three → score of 0.67
- One of three → score of 0.33
- None → score of 0.0

## Confidence Score Interpretation

| Score Range | Quality | Action |
|-------------|---------|--------|
| 0.9 - 1.0 | Excellent | Auto-process |
| 0.7 - 0.9 | Good | Auto-process with logging |
| 0.5 - 0.7 | Fair | Review recommended |
| 0.3 - 0.5 | Poor | Manual review required |
| 0.0 - 0.3 | Very Poor | Likely extraction failure |

## Usage Example

```python
result = engine.predict(invoice_image)

if result.confidence >= 0.8:
    # High confidence - process automatically
    process_invoice(result)
elif result.confidence >= 0.5:
    # Medium confidence - queue for review
    queue_for_review(result)
else:
    # Low confidence - manual processing
    flag_for_manual_entry(result)
```

## Edge Cases Handled

### Empty OCR Results
```python
# No words extracted - OCR component skipped
result = engine._calculate_confidence({}, [])
# Only required fields score (0.0) contributes
# Result: 0.0
```

### All Perfect Scores
```python
# All components at maximum
fields = {'RFC_EMISOR': f1, 'RFC_RECEPTOR': f2, 'TOTAL': f3}
# where each field has confidence = 1.0
result = engine._calculate_confidence(fields, [1.0, 1.0, 1.0])
# Result: 1.0
```

### No Required Fields
```python
# Only optional fields extracted
fields = {'DATE': date_field, 'SUBTOTAL': subtotal_field}
# Required fields score = 0/3 = 0.0
# Result: average of OCR + field scores + 0.0
```

## Key Takeaways

1. **Multi-factor Score**: Combines OCR, field, and presence signals
2. **Simple Average**: All factors contribute equally
3. **Required Fields Critical**: Missing required fields significantly lowers score
4. **Defensive Design**: Handles missing data gracefully
5. **Actionable Output**: Score enables automated decision-making
