# Learning Guide: Subtask 17.3 - Windows Service Installation

## Overview

This guide explains the implementation of Windows Service installation for the ContPAQi AI Bridge application. Windows Services are long-running executables that perform specific functions and can be configured to start automatically when the system boots.

## Why Windows Services?

1. **Background Operation**: Services run without user interaction
2. **Auto-start**: Can start before any user logs in
3. **Recovery**: Can be configured to restart automatically on failure
4. **Security**: Run under specific service accounts with defined permissions
5. **Management**: Integrated with Windows Services management tools

## PowerShell Service Management

### Creating Services

**Method 1: New-Service Cmdlet (Recommended)**
```powershell
New-Service -Name "ServiceName" `
            -BinaryPathName "C:\path\to\executable.exe" `
            -DisplayName "Display Name" `
            -Description "Service description" `
            -StartupType Automatic
```

**Method 2: sc.exe Command**
```powershell
sc.exe create ServiceName binPath= "C:\path\to\executable.exe" DisplayName= "Display Name"
```

Note the space after `=` in sc.exe commands - this is required syntax.

### Startup Types

| Type | Description |
|------|-------------|
| Automatic | Starts when system boots |
| Automatic (Delayed) | Starts 1-2 minutes after boot |
| Manual | Must be started manually |
| Disabled | Cannot be started |

Delayed start is recommended for application services to reduce boot time impact:
```powershell
sc.exe config ServiceName start= delayed-auto
```

### Service Recovery Options

Configure automatic recovery when service fails:
```powershell
sc.exe failure ServiceName reset= 86400 actions= restart/60000/restart/60000/restart/60000
```

Parameters:
- `reset`: Reset failure count after N seconds (86400 = 24 hours)
- `actions`: Format is `action/delay/action/delay/...`
  - Actions: `restart`, `run`, `reboot`, or empty (no action)
  - Delay: Milliseconds before action (60000 = 1 minute)

### Service Removal

**Stop then Delete:**
```powershell
Stop-Service -Name "ServiceName" -Force
sc.exe delete ServiceName
```

PowerShell 6+ also has `Remove-Service`:
```powershell
Remove-Service -Name "ServiceName"
```

## Administrator Privileges

Windows Service management requires Administrator privileges. Always check:

```powershell
function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

if (-not (Test-Administrator)) {
    Write-Error "Administrator privileges required"
    exit 1
}
```

## Script Structure Best Practices

### 1. Parameter Block
```powershell
param(
    [switch]$Install,
    [switch]$Uninstall,
    [switch]$Start,
    [switch]$Stop,
    [switch]$Status
)
```

### 2. Configuration Constants
```powershell
$ServiceName = "MyService"
$ServiceDisplayName = "My Application Service"
$ServiceDescription = "Description of what the service does"
```

### 3. Logging Function
```powershell
function Write-Log {
    param(
        [string]$Message,
        [ValidateSet("Info", "Warning", "Error", "Success")]
        [string]$Level = "Info"
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "$timestamp [$Level] $Message"
}
```

### 4. Error Handling
```powershell
try {
    New-Service @params -ErrorAction Stop
    Write-Log "Service created successfully" -Level Success
}
catch {
    Write-Log "Failed: $($_.Exception.Message)" -Level Error
    exit 2
}
```

### 5. Exit Codes
Define meaningful exit codes for installer integration:
```powershell
$EXIT_SUCCESS = 0
$EXIT_NOT_ADMIN = 1
$EXIT_INSTALL_FAILED = 2
$EXIT_UNINSTALL_FAILED = 3
```

## Integration with Inno Setup

### Calling PowerShell from ISS

```pascal
[Run]
; Install service after file copy
Filename: "{app}\scripts\install-service.ps1"; \
    Parameters: "-Install"; \
    Flags: runhidden waituntilterminated; \
    StatusMsg: "Installing Windows Service..."

[UninstallRun]
; Remove service before file deletion
Filename: "{app}\scripts\install-service.ps1"; \
    Parameters: "-Uninstall"; \
    Flags: runhidden waituntilterminated
```

### Key Flags
- `runhidden`: Don't show PowerShell window
- `waituntilterminated`: Wait for script to complete
- `runasoriginaluser`: Run as installing user (not recommended for services)

## Service Lifecycle

```
+-------------------+
|   Not Installed   |
+-------------------+
         |
         v  (Install)
+-------------------+
|     Stopped       |
+-------------------+
         |
         v  (Start)
+-------------------+
|     Running       |
+-------------------+
         |
         v  (Stop)
+-------------------+
|     Stopped       |
+-------------------+
         |
         v  (Uninstall)
+-------------------+
|   Not Installed   |
+-------------------+
```

## Debugging Tips

### Check Service Status
```powershell
Get-Service -Name "ContPAQiBridge"
```

### View Service Configuration
```powershell
sc.exe qc ContPAQiBridge
```

### View Failure Configuration
```powershell
sc.exe qfailure ContPAQiBridge
```

### Event Viewer
Service events are logged in:
- Windows Logs > Application
- Windows Logs > System

Filter by source matching your service name.

## Security Considerations

1. **Service Account**: By default, services run as LocalSystem. Consider using a dedicated service account with minimal permissions.

2. **Binary Path**: Ensure the service binary path doesn't contain spaces without quotes, or quote the entire path.

3. **Permissions**: The service account needs appropriate permissions to the installation directory and any resources it accesses.

4. **Least Privilege**: Configure the service to run with minimum required permissions.

## Summary

Windows Service installation involves:
1. Creating the service with appropriate configuration
2. Setting startup type (prefer delayed-auto for applications)
3. Configuring recovery actions for reliability
4. Proper error handling and exit codes
5. Integration with the installer for seamless deployment

The implementation in `install-service.ps1` provides a complete solution for the ContPAQi AI Bridge, following PowerShell best practices and Windows service management guidelines.
