# Learnings Guide - Inno Setup CI Fixes

**Date:** 2025-12-12
**Topic:** Fixing Inno Setup compilation errors in GitHub Actions CI

---

## Key Learnings

### 1. Inno Setup Source Files Must Exist at Compile Time

**Problem:** Inno Setup requires all files referenced in the `[Files]` section to exist when the installer is compiled.

**Wrong Approach:**
```pascal
; This will FAIL if the file doesn't exist - no runtime skip
Source: "dist\docker\image.tar"; DestDir: "{app}"; Flags: skipifdoesntexist
```

**Correct Approach:**
```pascal
; Use preprocessor to conditionally include
#ifexist "dist\docker\image.tar"
Source: "dist\docker\image.tar"; DestDir: "{app}"; Flags: ignoreversion
#endif
```

**Note:** The `skipifdoesntexist` flag doesn't exist in Inno Setup. The `#ifexist` preprocessor directive is evaluated at compile time.

---

### 2. Inno Setup Pascal Script Type Safety

**Problem:** Inno Setup's Pascal scripting is strictly typed. Function parameters must match expected types exactly.

**ShellExec Function Signature:**
```pascal
function ShellExec(
  const Verb: String;
  const Filename: String;
  const Params: String;
  const WorkingDir: String;
  const ShowCmd: Integer;
  const Wait: TExecWait;
  var ErrorCode: Integer  // Must be Integer, NOT Boolean
): Boolean;
```

**Wrong:**
```pascal
function InitializeSetup(): Boolean;
begin
  Result := True;
  // WRONG: Result is Boolean, but ShellExec expects Integer for ErrorCode
  ShellExec('open', 'https://example.com', '', '', SW_SHOW, ewNoWait, Result);
end;
```

**Correct:**
```pascal
function InitializeSetup(): Boolean;
var
  ErrorCode: Integer;  // Declare separate variable
begin
  Result := True;
  ShellExec('open', 'https://example.com', '', '', SW_SHOW, ewNoWait, ErrorCode);
end;
```

---

### 3. Optional Resource Handling in CI

When building installers in CI environments, some resources may not be available:

| Resource | In CI | Solution |
|----------|-------|----------|
| Docker images | No | Use `#ifexist` |
| Custom icons | No | Comment out or provide placeholder |
| Build scripts | Maybe | Use `#ifexist` |
| Config files | Yes (from build) | Normal include |

**Pattern for Optional Files:**
```pascal
; Optional: Docker image (may not exist in CI)
#ifexist "dist\docker\myapp.tar"
Source: "dist\docker\myapp.tar"; DestDir: "{app}\docker"; Flags: ignoreversion
#endif

; Optional: Scripts directory
#ifexist "dist\scripts\*"
Source: "dist\scripts\*"; DestDir: "{app}\scripts"; Flags: ignoreversion recursesubdirs
#endif
```

---

### 4. Common Inno Setup Flags

Valid flags for the `[Files]` section:

| Flag | Purpose |
|------|---------|
| `ignoreversion` | Don't check file versions |
| `recursesubdirs` | Include subdirectories |
| `createallsubdirs` | Create empty subdirectories |
| `onlyifdoesntexist` | Only copy if destination doesn't exist |
| `external` | File is external to setup |
| `isreadme` | Display as readme after install |
| `dontcopy` | Reference only, don't copy |

**Note:** There is NO `skipifdoesntexist` flag!

---

### 5. Debugging Inno Setup in CI

**Reading CI Logs:**
```
Parsing [Files] section, line 116
Error on line 116 in D:\a\...\installer\contpaqi-bridge.iss: Parameter "Flags" includes an unknown flag.
```

The error message tells you:
1. Which section (`[Files]`)
2. Which line (116)
3. What went wrong ("unknown flag")

**Local Testing:**
Before pushing, test with Inno Setup Compiler locally:
```powershell
& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\contpaqi-bridge.iss
```

---

### 6. SetupIconFile Requirement

The `SetupIconFile` directive requires the icon file to exist at compile time:

```pascal
; This will fail if icon.ico doesn't exist
SetupIconFile=assets\icon.ico

; Solution 1: Comment out (use default Inno Setup icon)
; SetupIconFile=assets\icon.ico  ; TODO: Add custom icon

; Solution 2: Use preprocessor
#ifexist "assets\icon.ico"
SetupIconFile=assets\icon.ico
#endif
```

---

## Quick Reference: Inno Setup Preprocessor Directives

```pascal
#ifexist "filepath"    ; Check if file exists
#ifnexist "filepath"   ; Check if file doesn't exist
#endif                 ; End conditional block

#define MyVar "value"  ; Define a variable
#ifdef MyVar           ; Check if variable defined
#ifndef MyVar          ; Check if variable not defined
```

---

## Checklist for Inno Setup in CI

- [ ] All `Source:` files exist or wrapped in `#ifexist`
- [ ] `SetupIconFile` exists or is commented out
- [ ] `LicenseFile` and `InfoBeforeFile` exist
- [ ] Pascal code uses correct types for function parameters
- [ ] Test locally with ISCC.exe before pushing
