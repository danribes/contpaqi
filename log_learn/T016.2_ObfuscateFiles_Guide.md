# Learning Guide: Subtask 16.2 - Obfuscate inference.py and main.py

## What Are We Obfuscating?

The core AI inference code that processes invoices:

```
src/
├── main.py          # FastAPI entry point
├── inference.py     # AI inference engine
├── models/
│   ├── tatr.py      # Table detection
│   ├── layoutlm.py  # Field extraction
│   ├── validators.py # RFC validation
│   └── schemas.py   # Data schemas
└── utils/
    └── ocr.py       # OCR processing
```

These files contain proprietary AI algorithms that we want to protect.

---

## Why a Makefile?

### Problem
Multiple commands needed for building:
```bash
# Without Makefile
pip install pyarmor
python scripts/obfuscate.py --clean --verbose
docker build -t contpaqi-mcp .
```

### Solution
Single command with Makefile:
```bash
make build
```

### Benefits
1. **Simplicity**: One command for complex operations
2. **Consistency**: Same process every time
3. **Documentation**: Self-documenting targets
4. **Dependency Management**: Targets depend on each other

---

## Makefile Anatomy

### Structure
```makefile
# Variables
PYTHON := python
DIST_DIR := dist

# Phony targets (not files)
.PHONY: all build clean

# Targets
target_name: dependencies
	command to execute
	another command
```

### Key Concepts

#### Variables
```makefile
PYTHON := python           # Use Python command
SRC_DIR := src            # Source directory
DIST_DIR := dist          # Output directory
```

#### Dependencies
```makefile
build: obfuscate docker-build
#      ↑ These run first
```

#### Phony Targets
```makefile
.PHONY: clean build test
# These are not actual files, just command names
```

#### Tab Indentation
```makefile
target:
	command  # MUST use TAB, not spaces!
```

---

## Build Pipeline Design

### Sequential Steps
```
Source Code → Tests → Obfuscate → Docker Build → Deploy
```

### Makefile Implementation
```makefile
# Step 1: Test first
test:
	$(PYTHON) -m pytest tests/ -v

# Step 2: Obfuscate
obfuscate: clean-dist
	$(PYTHON) $(OBFUSCATE_SCRIPT) --clean --verbose

# Step 3: Build container
docker-build:
	$(DOCKER) build -t $(IMAGE_NAME) .

# All together
build: test obfuscate docker-build
```

---

## Dry Run Mode

### Why Dry Run?
Before obfuscating, you want to know:
- Which files will be processed?
- Is the configuration correct?
- Any potential issues?

### Usage
```bash
make obfuscate-dry-run
```

### Output
```
Dry run - showing files to obfuscate...
Found 7 Python files to obfuscate:
  - src/main.py
  - src/inference.py
  - src/models/tatr.py
  - src/models/layoutlm.py
  ...
Dry run mode - no files will be obfuscated
```

---

## Clean Targets

### Why Multiple Clean Targets?
Different artifacts need different cleanup:

```makefile
# Remove obfuscated output only
clean-dist:
	rm -rf $(DIST_DIR)

# Remove Python bytecode
clean-pyc:
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

# Remove Docker images
clean-docker:
	$(DOCKER) rmi $(IMAGE_NAME):$(IMAGE_TAG)

# Remove everything
clean: clean-dist clean-pyc clean-docker
```

### Usage
```bash
make clean        # Everything
make clean-dist   # Just obfuscated files
```

---

## Development vs Production Builds

### Development Build
- Uses source code directly
- Faster to build
- Easier to debug

```makefile
build-dev: docker-build-dev
docker-build-dev:
	$(DOCKER) build -t $(IMAGE_NAME):dev .
```

### Production Build
- Uses obfuscated code
- Slower to build
- Protected from reverse engineering

```makefile
build: obfuscate docker-build
docker-build:
	$(DOCKER) build -t $(IMAGE_NAME):$(IMAGE_TAG) -f Dockerfile.prod .
```

---

## Error Handling in Makefile

### Check Before Build
```makefile
docker-build:
	@if [ ! -d "$(DIST_DIR)" ]; then \
		echo "Error: $(DIST_DIR)/ not found."; \
		exit 1; \
	fi
	$(DOCKER) build ...
```

### Graceful Failure
```makefile
clean-docker:
	$(DOCKER) rmi $(IMAGE_NAME) 2>/dev/null || true
	# ↑ Don't fail if image doesn't exist
```

---

## Help Target

### Self-Documenting Makefile
```makefile
## help: Show this help message
help:
	@echo "MCP Container Build System"
	@grep -E '^##' $(MAKEFILE_LIST) | sed 's/## /  /'
```

### Output
```
$ make help
MCP Container Build System

Targets:
  install-dev    Install development dependencies
  test           Run tests
  obfuscate      Obfuscate Python source files
  build          Build production container
  clean          Remove all build artifacts
```

---

## Testing the Build Pipeline

### Test File Discovery
```python
def test_main_py_exists_and_is_target(self):
    """Verify main.py is in obfuscation targets."""
    config = json.loads(PYARMOR_CONFIG.read_text())
    targets = config.get('targets', {}).get('primary', [])
    assert any('main.py' in t for t in targets)
```

### Test Makefile Targets
```python
def test_makefile_has_obfuscate_target(self):
    """Verify Makefile has obfuscate target."""
    content = MAKEFILE_PATH.read_text()
    assert 'obfuscate' in content
```

### Test Dry Run Safety
```python
def test_dry_run_does_not_modify_files(self):
    """Verify dry run doesn't create dist/."""
    existed_before = DIST_DIR.exists()
    subprocess.run(['python', SCRIPT, '--dry-run'])
    if not existed_before:
        assert not DIST_DIR.exists()
```

---

## Common Make Commands

| Command | Description |
|---------|-------------|
| `make` | Show help (default) |
| `make build` | Production build |
| `make build-dev` | Development build |
| `make obfuscate` | Obfuscate only |
| `make obfuscate-dry-run` | Preview obfuscation |
| `make clean` | Clean everything |
| `make test` | Run tests |
| `make verify` | Check obfuscation output |

---

## Integration with CI/CD

### GitHub Actions Example
```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: make install-dev

      - name: Run tests
        run: make test

      - name: Build production
        run: make build
```

---

## Summary

| Concept | Key Point |
|---------|-----------|
| Makefile | Automates build process |
| Phony targets | Commands, not files |
| Dependencies | Targets run in order |
| Dry run | Preview before execute |
| Clean targets | Remove different artifacts |
| Help target | Self-documenting |

---

## Next Steps

After this subtask:
1. **16.3**: Modify Dockerfile to use obfuscated `dist/`
2. **16.4-16.5**: Configure Dotfuscator for C# code
3. **16.6**: Test that obfuscated code works correctly
