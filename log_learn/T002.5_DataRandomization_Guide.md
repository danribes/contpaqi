# T002.5 - Data Randomization - Learning Guide

**Subtask**: 2.5 - Implement data randomization logic
**Date**: 2025-12-03
**Audience**: Developers generating synthetic invoice data

---

## What Was Built

A Python module (`invoice_data.py`) that generates complete, randomized Mexican invoice data for use with HTML templates and PDF generation.

---

## Core Function: generate_invoice_data()

### Basic Usage

```python
from invoice_data import generate_invoice_data

# Generate random invoice
invoice = generate_invoice_data()

# Generate reproducible invoice with seed
invoice = generate_invoice_data(seed=42)
```

### Return Structure

```python
{
    'emisor': {
        'name': str,      # Company name with suffix
        'rfc': str,       # Valid Mexican RFC
        'address': str    # Full address
    },
    'receptor': {
        'name': str,
        'rfc': str,
        'address': str
    },
    'date': str,          # YYYY-MM-DD format
    'folio': str,         # 8-char alphanumeric
    'items': [
        {
            'description': str,
            'quantity': int,
            'unit_price': float,
            'amount': float
        }
    ],
    'subtotal': float,
    'iva': float,         # 16% of subtotal
    'total': float,       # subtotal + iva
    'currency': str       # 'MXN', 'USD', or 'EUR'
}
```

---

## Working with Faker

### Mexican Locale Setup

```python
from faker import Faker

# Create Mexican locale Faker
fake = Faker('es_MX')

# Generate Mexican data
company = fake.company()      # "Grupo López"
address = fake.address()      # "Calle 5 de Mayo 123..."
phone = fake.phone_number()   # "+52 55 1234 5678"
```

### Seeding for Reproducibility

```python
from faker import Faker
import random

def get_faker(seed=None):
    fake = Faker('es_MX')
    if seed is not None:
        Faker.seed(seed)
        random.seed(seed)
    return fake

# Same seed = same data
fake1 = get_faker(seed=42)
fake2 = get_faker(seed=42)
assert fake1.name() == fake2.name()
```

---

## Generating Line Items

### Variable Item Counts

```python
import random

def generate_line_items(fake, num_items=None):
    if num_items is None:
        num_items = random.randint(1, 10)

    items = []
    for _ in range(num_items):
        qty = random.randint(1, 20)
        price = round(random.uniform(100, 5000), 2)

        items.append({
            'description': generate_description(fake),
            'quantity': qty,
            'unit_price': price,
            'amount': round(qty * price, 2)
        })

    return items
```

### Realistic Price Distribution

```python
def generate_price():
    """Generate price with realistic distribution."""
    tier = random.random()

    if tier < 0.3:
        # 30% low-cost items
        return round(random.uniform(10, 500), 2)
    elif tier < 0.7:
        # 40% medium-cost items
        return round(random.uniform(500, 5000), 2)
    else:
        # 30% high-cost items
        return round(random.uniform(5000, 50000), 2)
```

---

## Product Descriptions

### Predefined Descriptions

```python
DESCRIPTIONS = [
    # Services
    "Servicio de consultoría profesional",
    "Servicio de mantenimiento preventivo",
    "Servicio de soporte técnico",

    # Products
    "Material de oficina",
    "Equipo de cómputo",
    "Licencia de software",
]

def generate_description(fake):
    if random.random() < 0.7:
        return random.choice(DESCRIPTIONS)
    else:
        return f"Servicio de {fake.job().lower()}"
```

### Adding Variety

```python
ADJECTIVES = ["Premium", "Básico", "Profesional", "Estándar"]

def enhance_description(description):
    if random.random() < 0.3:
        adj = random.choice(ADJECTIVES)
        return f"{description} - {adj}"
    return description
```

---

## Mexican Tax Calculations

### IVA (16%)

```python
def calculate_totals(items):
    """Calculate Mexican invoice totals."""
    # Subtotal = sum of all items
    subtotal = sum(item['amount'] for item in items)
    subtotal = round(subtotal, 2)

    # IVA = 16% of subtotal (standard Mexican VAT)
    iva = round(subtotal * 0.16, 2)

    # Total = subtotal + IVA
    total = round(subtotal + iva, 2)

    return subtotal, iva, total
```

### Precision Handling

```python
# Always round to 2 decimal places for currency
amount = round(quantity * unit_price, 2)
subtotal = round(sum(amounts), 2)
iva = round(subtotal * 0.16, 2)
total = round(subtotal + iva, 2)
```

---

## Date Generation

### Within Date Range

```python
from datetime import date, timedelta

def generate_invoice_date():
    """Generate date within last 2 years."""
    days_ago = random.randint(0, 730)
    invoice_date = date.today() - timedelta(days=days_ago)
    return invoice_date.strftime('%Y-%m-%d')
```

### Spanish Date Format

```python
MONTHS_ES = [
    "enero", "febrero", "marzo", "abril", "mayo", "junio",
    "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
]

def format_date_spanish(date_str):
    """Format date for Spanish display."""
    d = date.fromisoformat(date_str)
    return f"{d.day} de {MONTHS_ES[d.month-1]} de {d.year}"
    # "15 de marzo de 2024"
```

---

## Using with Templates

### Rendering Invoice

```python
from jinja2 import Environment, FileSystemLoader
from invoice_data import generate_invoice_data

# Setup Jinja2
env = Environment(loader=FileSystemLoader('scripts/templates'))
template = env.get_template('template_01.html')

# Generate data
invoice = generate_invoice_data()

# Render HTML
html = template.render(**invoice)
# or: html = template.render(
#     emisor=invoice['emisor'],
#     receptor=invoice['receptor'],
#     items=invoice['items'],
#     ...
# )
```

### Batch Generation

```python
from invoice_data import generate_batch_invoices

# Generate 100 invoices with sequential seeds
invoices = generate_batch_invoices(count=100, seed=1000)

for i, invoice in enumerate(invoices):
    html = template.render(**invoice)
    save_pdf(html, f'invoice_{i:04d}.pdf')
```

---

## Testing Data Generation

### Structure Tests

```python
def test_invoice_structure():
    invoice = generate_invoice_data()

    # Required keys
    assert 'emisor' in invoice
    assert 'receptor' in invoice
    assert 'items' in invoice

    # Emisor structure
    assert 'name' in invoice['emisor']
    assert 'rfc' in invoice['emisor']
```

### Calculation Tests

```python
def test_calculations():
    invoice = generate_invoice_data()

    # Subtotal = sum of items
    expected = sum(i['amount'] for i in invoice['items'])
    assert abs(invoice['subtotal'] - expected) < 0.01

    # IVA = 16%
    expected_iva = round(invoice['subtotal'] * 0.16, 2)
    assert abs(invoice['iva'] - expected_iva) < 0.01
```

### Randomization Tests

```python
def test_varies():
    invoices = [generate_invoice_data() for _ in range(10)]
    totals = [inv['total'] for inv in invoices]

    # Should have variety
    assert len(set(totals)) >= 5
```

---

## Best Practices

### 1. Always Validate Data

```python
from mexican_data import validate_rfc

invoice = generate_invoice_data()
is_valid, error = validate_rfc(invoice['emisor']['rfc'])
assert is_valid, f"Invalid RFC: {error}"
```

### 2. Use Seeds for Debugging

```python
# When bug found, note the seed
invoice = generate_invoice_data(seed=42)
# Now you can reproduce the exact data
```

### 3. Round Currency Values

```python
# Always round to 2 decimals
amount = round(qty * price, 2)  # Good
amount = qty * price            # Bad - may have many decimals
```

### 4. Handle Edge Cases

```python
def generate_line_items(fake, num_items=None):
    if num_items is None:
        num_items = random.randint(1, 10)

    # Ensure at least 1 item
    num_items = max(1, num_items)
```

---

## Next Steps

- **Subtask 2.6**: Implement bounding box calculation
- Use pytesseract to find field locations in rendered PDF
- Generate ground truth JSON for OCR training
