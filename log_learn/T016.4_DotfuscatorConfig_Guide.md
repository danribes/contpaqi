# Learning Guide: Subtask 16.4 - Configure Dotfuscator Community for C#

## What Is Dotfuscator?

Dotfuscator is a .NET obfuscation tool that protects assemblies from reverse engineering.

```
┌─────────────────────────────────────────────────────────┐
│ Original Assembly                                       │
│                                                         │
│ public class InvoiceController                          │
│ {                                                       │
│     public async Task<Invoice> ProcessInvoice(...)     │
│     private bool ValidateData(...)                     │
│ }                                                       │
└────────────────────────┬────────────────────────────────┘
                         │ Obfuscation
                         ▼
┌─────────────────────────────────────────────────────────┐
│ Obfuscated Assembly                                     │
│                                                         │
│ public class a                                          │
│ {                                                       │
│     public async Task<b> c(...)                        │
│     private bool d(...)                                │
│ }                                                       │
└─────────────────────────────────────────────────────────┘
```

---

## Dotfuscator Editions

| Feature | Community | Professional |
|---------|-----------|--------------|
| Renaming | Yes | Yes |
| Control Flow | Limited | Advanced |
| String Encryption | No | Yes |
| Tamper Detection | No | Yes |
| Price | Free (VS) | Licensed |

Community Edition is included with Visual Studio.

---

## Configuration File Structure

### Root Element
```xml
<dotfuscator version="2.3">
  <!-- Configuration sections -->
</dotfuscator>
```

### Input Section
```xml
<input>
  <asmlist>
    <inputassembly>
      <file dir="bin\Release\net6.0" name="MyApp.dll" />
    </inputassembly>
  </asmlist>
</input>
```

### Output Section
```xml
<output>
  <destination dir="obfuscated" />
</output>
```

### Renaming Section
```xml
<renaming>
  <excludelist>
    <type name="Namespace.ClassName" excludetype="true">
      <method name="*" signature="*" />
    </type>
  </excludelist>
</renaming>
```

---

## Why Exclusions Matter

### ASP.NET Controllers
Controllers must keep names for routing:

```csharp
// This won't work if class is renamed
[Route("api/[controller]")]
public class InvoiceController { }
```

### JSON Serialization
Models need property names:

```csharp
public class Invoice
{
    public string RFC { get; set; }  // Must match JSON
}
```

### COM Interop
Interface methods must match:

```csharp
public interface ISdkInterop
{
    bool Connect(string path);  // Name must match SDK
}
```

---

## Exclusion Patterns

### Exclude Entire Type
```xml
<type name="Namespace.ClassName" excludetype="true">
  <method name="*" signature="*" />
  <property name="*" signature="*" />
</type>
```

### Exclude by Pattern
```xml
<type name="*Controller" regex="true" excludetype="true" />
```

### Exclude Specific Members
```xml
<type name="Namespace.ClassName" excludetype="false">
  <method name="PublicMethod" signature="*" />
</type>
```

---

## PowerShell Automation

### Finding Dotfuscator
```powershell
$paths = @(
    "${env:ProgramFiles}\Microsoft Visual Studio\2022\*\...\dotfuscator.exe",
    "${env:ProgramFiles}\Microsoft Visual Studio\2019\*\...\dotfuscator.exe"
)

foreach ($pattern in $paths) {
    $found = Resolve-Path $pattern -ErrorAction SilentlyContinue
    if ($found) { return $found }
}
```

### Running Obfuscation
```powershell
& $dotfuscatorPath dotfuscator.xml

if ($LASTEXITCODE -ne 0) {
    throw "Obfuscation failed"
}
```

### Error Handling
```powershell
$ErrorActionPreference = "Stop"

try {
    # Obfuscation code
}
catch {
    Write-Error "Failed: $_"
    exit 1
}
```

---

## Mapping Files

Dotfuscator generates a mapping file for debugging:

```xml
<mapping>
  <mapoutput dir="obfuscated">
    <file name="mapping.xml" />
  </mapoutput>
</mapping>
```

### Using Mapping Files
When debugging obfuscated stack traces:
```
Original: InvoiceController.ProcessInvoice()
Obfuscated: a.c()
```

The mapping file translates obfuscated names back.

---

## Build Integration

### Pre-build Check
```powershell
if (-not (Test-Path $ConfigFile)) {
    throw "Configuration not found"
}
```

### Post-build Verification
```powershell
$outputDll = Join-Path $OutputDir "ContpaqiBridge.dll"
if (-not (Test-Path $outputDll)) {
    throw "Obfuscated assembly not found"
}
```

---

## Common Obfuscation Techniques

### 1. Renaming (Community)
```
ProcessInvoice() → a()
ValidateData() → b()
```

### 2. Control Flow (Professional)
```csharp
// Before
if (x > 0) return true;

// After
switch (hash(x)) {
    case 0x1A2B: goto label_1;
    case 0x3C4D: goto label_2;
    // ...
}
```

### 3. String Encryption (Professional)
```csharp
// Before
string key = "API_KEY_123";

// After
string key = Decrypt(new byte[] { 0x4A, 0x7B, ... });
```

---

## Security Considerations

### DO:
- Use relative paths in config
- Exclude public API surfaces
- Keep mapping files secure
- Test obfuscated code thoroughly

### DON'T:
- Hardcode secrets in config
- Obfuscate entry points
- Skip exclusions for serialized types
- Distribute mapping files

---

## Troubleshooting

### Routing Fails
**Problem**: API endpoints return 404
**Solution**: Add controller exclusions

### JSON Parsing Fails
**Problem**: Properties don't deserialize
**Solution**: Add model exclusions

### SDK Calls Fail
**Problem**: COM methods not found
**Solution**: Exclude interface definitions

---

## Summary

| Concept | Key Point |
|---------|-----------|
| Dotfuscator | .NET obfuscation tool |
| Community Edition | Free with Visual Studio |
| Renaming | Primary obfuscation method |
| Exclusions | Critical for ASP.NET/COM |
| Mapping file | Debug obfuscated traces |
| Automation | PowerShell script |

---

## Next Steps

After this subtask:
1. **16.5**: Enable string encryption (where available)
2. **16.6**: Test obfuscated code functionality
