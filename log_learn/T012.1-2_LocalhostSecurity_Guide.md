# Localhost-Only Security - Learning Guide

## Overview
How to restrict an ASP.NET Core API to localhost connections only.

## Key Concepts

### 1. Kestrel Binding
```csharp
builder.WebHost.ConfigureKestrel(options =>
{
    // Only localhost
    options.ListenLocalhost(5000);

    // Specific IP
    options.Listen(IPAddress.Parse("127.0.0.1"), 5000);

    // All interfaces (NOT for localhost-only)
    // options.ListenAny(5000);
});
```

### 2. IP Verification Middleware
Defense-in-depth:
```csharp
app.Use(async (context, next) =>
{
    var remoteIp = context.Connection.RemoteIpAddress;

    var isLocalhost =
        remoteIp.Equals(IPAddress.Loopback) ||
        remoteIp.Equals(IPAddress.IPv6Loopback);

    if (!isLocalhost)
    {
        context.Response.StatusCode = 403;
        await context.Response.WriteAsync("Localhost only");
        return;
    }

    await next();
});
```

### 3. Loopback Addresses
| Type | Address | Description |
|------|---------|-------------|
| IPv4 | 127.0.0.1 | Standard loopback |
| IPv6 | ::1 | IPv6 loopback |

Both should be allowed for localhost.

### 4. Defense in Depth
Multiple layers:
```
┌─────────────────────────────────────┐
│         OS Firewall                  │
├─────────────────────────────────────┤
│    Kestrel Binding (localhost)       │
├─────────────────────────────────────┤
│    IP Verification Middleware        │
├─────────────────────────────────────┤
│    Authentication (if needed)        │
└─────────────────────────────────────┘
```

### 5. Why Localhost-Only?
For services that:
- Handle sensitive data (accounting)
- Have direct database/SDK access
- Should only be called by local apps
- Don't need network exposure

## Security Considerations

### What it Protects Against
- Remote network attacks
- Port scanning
- Unauthorized access from LAN
- Internet-based attacks

### What it Doesn't Protect Against
- Local malware on same machine
- Privileged local users
- Localhost socket hijacking

## Configuration Options

```csharp
// Development (localhost only)
options.ListenLocalhost(5000);

// Development with HTTPS
options.ListenLocalhost(5001, o => o.UseHttps());

// Production behind reverse proxy
options.Listen(IPAddress.Any, 5000);
// Plus: reverse proxy only allows localhost
```

## Best Practices

1. **Bind to localhost** - First line of defense
2. **Add middleware check** - Defense in depth
3. **Log denied requests** - For security monitoring
4. **Return 403** - Clear denial, not 404
5. **Check both IPv4 and IPv6** - Cover all cases

## Key Takeaways

1. Kestrel binding is network-level security
2. Middleware is application-level security
3. Both layers provide defense in depth
4. Check both IPv4 and IPv6 loopback
5. Localhost-only is appropriate for local services
