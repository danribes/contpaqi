# T002.1 - Scripts Setup - Learning Guide

**Subtask**: 2.1 - Set up Python environment with Faker and WeasyPrint
**Date**: 2025-12-03
**Audience**: Developers working on synthetic data generation

---

## What Was Built

This subtask created the foundation for generating synthetic invoice training data:

1. **requirements.txt** - Python dependencies
2. **generate_invoices.py** - Main generation script
3. **templates/** - Directory for HTML invoice templates

---

## Why Generate Synthetic Data?

Training AI models requires thousands of labeled examples. For invoice processing:

- **Real invoices** contain sensitive business data (can't share)
- **Manual labeling** is expensive and time-consuming
- **Synthetic data** gives us:
  - Unlimited samples
  - Perfect ground truth labels
  - Control over variations (fonts, layouts, noise)
  - No privacy concerns

---

## Key Libraries Explained

### Faker

```python
from faker import Faker
fake = Faker('es_MX')  # Mexican Spanish locale

fake.company()    # → "Hernández-García S.A. de C.V."
fake.address()    # → "Calle Reforma 123, Col. Centro, CDMX 06600"
fake.name()       # → "María Guadalupe López Hernández"
```

**Why es_MX?** Mexican invoices have specific formats:
- Company names with "S.A. de C.V.", "S. de R.L."
- Addresses with "Col." (colonia), "C.P." (código postal)
- RFC numbers (tax IDs)

### WeasyPrint

```python
from weasyprint import HTML

# Convert HTML to PDF
HTML(string=html_content).write_pdf('invoice.pdf')
```

**Why WeasyPrint?**
- Pure Python (no external binaries like wkhtmltopdf)
- Good CSS support (Flexbox, Grid)
- Consistent rendering across platforms

### Jinja2

```html
<h1>{{ company_name }}</h1>
<p>RFC: {{ rfc }}</p>
<table>
  {% for item in items %}
  <tr>
    <td>{{ item.description }}</td>
    <td>{{ item.quantity }}</td>
    <td>${{ item.amount }}</td>
  </tr>
  {% endfor %}
</table>
```

**Why Jinja2?**
- Same templating as Flask/Django
- Powerful loops and conditionals
- Safe variable escaping

---

## Mexican RFC Format

RFC (Registro Federal de Contribuyentes) is Mexico's tax ID:

```
XAXX010101ABC
├──┘├─────┘├─┘
│   │      │
│   │      └── Homoclave (3 alphanumeric)
│   └── Date YYMMDD (birth/constitution)
└── Letters (4 for individuals, 3 for companies)
```

Our generator:

```python
def generate_rfc(fake):
    letters = ''.join(random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ', k=4))
    date = fake.date_of_birth().strftime('%y%m%d')
    homoclave = ''.join(random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', k=3))
    return f"{letters}{date}{homoclave}"
```

---

## CLI Design Pattern

Using argparse for command-line interface:

```python
parser = argparse.ArgumentParser(description='Generate invoices')

parser.add_argument('--num-samples', '-n', type=int, default=100)
parser.add_argument('--output-dir', '-o', default='../data/synthetic')
parser.add_argument('--seed', '-s', type=int, default=42)

args = parser.parse_args()
```

**Usage examples:**

```bash
# Generate 100 invoices (default)
python generate_invoices.py

# Generate 5000 invoices
python generate_invoices.py -n 5000

# Custom output directory
python generate_invoices.py -o /path/to/output

# Reproducible generation
python generate_invoices.py --seed 123
```

---

## Project Structure After This Subtask

```
contpaqi/
├── scripts/
│   ├── requirements.txt      # Dependencies
│   ├── generate_invoices.py  # Main script
│   └── templates/            # For HTML templates (empty)
├── data/
│   └── synthetic/
│       ├── pdfs/             # Generated PDFs
│       └── labels/           # Ground truth JSON
└── tests/
    └── test_task002_1_scripts_setup.py
```

---

## Reproducibility

Both Faker and random use the same seed:

```python
random.seed(42)
Faker.seed(42)
```

This ensures:
- Same company names each run
- Same invoice amounts
- Same template selection
- Useful for debugging and testing

---

## Next Steps

1. **Subtask 2.2**: Validate RFC format, test Mexican locale
2. **Subtask 2.3**: Create 10 HTML invoice templates
3. **Subtask 2.5**: Implement line item generation
4. **Subtask 2.6**: Calculate bounding boxes for ground truth
5. **Subtask 2.8**: Generate 5000+ samples

---

## Common Issues

### WeasyPrint Installation

On Linux, you may need:
```bash
apt-get install libpango-1.0-0 libpangocairo-1.0-0
```

On macOS:
```bash
brew install pango
```

### Missing Fonts

WeasyPrint uses system fonts. For consistent results:
```bash
apt-get install fonts-liberation fonts-dejavu
```

---

## Testing Locally

```bash
# Install dependencies
cd scripts/
pip install -r requirements.txt

# Run with few samples to test
python generate_invoices.py -n 5

# Check output
ls ../data/synthetic/labels/
cat ../data/synthetic/labels/invoice_00000.json
```
