# T009.1 FastAPI Application - Learning Guide

## Overview
This guide explains how to create a FastAPI application for API-based services.

## FastAPI Basics

FastAPI is a modern, fast web framework for building APIs with Python.

```python
from fastapi import FastAPI

app = FastAPI(
    title="My API",
    description="API description",
    version="1.0.0"
)
```

## Application Structure

```
mcp-container/
├── src/
│   ├── __init__.py
│   ├── main.py          # FastAPI app entry point
│   ├── inference.py     # Business logic
│   └── models/
│       └── schemas.py   # Pydantic models
```

## Key Components

### 1. App Configuration
```python
app = FastAPI(
    title="Contpaqi Invoice Processor",
    description="AI-powered invoice data extraction",
    version="1.0.0",
    lifespan=lifespan  # Modern startup/shutdown
)
```

### 2. CORS Middleware
Cross-Origin Resource Sharing allows the API to accept requests from web browsers:

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Frontend URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 3. Lifespan Pattern (Modern)
Replaces deprecated `@app.on_event("startup")`:

```python
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup code
    engine = InvoiceInferenceEngine()
    yield
    # Shutdown code
    engine = None

app = FastAPI(lifespan=lifespan)
```

### 4. Route Definitions
```python
@app.get("/")
async def root():
    return {"message": "Welcome"}

@app.get("/health")
async def health_check():
    return {"status": "healthy"}

@app.post("/api/v1/process")
async def process_invoice(file: UploadFile = File(...)):
    return {"status": "received"}
```

## Testing with TestClient

FastAPI provides a test client for testing without running the server:

```python
from fastapi.testclient import TestClient
from main import app

def test_health_endpoint():
    client = TestClient(app)
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"
```

## Dependency Injection

Use `Depends` for shared resources:

```python
from fastapi import Depends

def get_engine():
    if engine is None:
        raise HTTPException(503, "Not initialized")
    return engine

@app.post("/process")
async def process(engine = Depends(get_engine)):
    return engine.predict(...)
```

## OpenAPI Documentation

FastAPI auto-generates documentation:

| Endpoint | Description |
|----------|-------------|
| `/docs` | Interactive Swagger UI |
| `/redoc` | ReDoc documentation |
| `/openapi.json` | Raw OpenAPI schema |

## Error Handling

```python
from fastapi import HTTPException

@app.post("/process")
async def process(file: UploadFile):
    if file.content_type not in allowed_types:
        raise HTTPException(
            status_code=400,
            detail="Invalid file type"
        )
```

## Best Practices

1. **Use Pydantic Models**: Type-safe request/response
2. **Async Functions**: Use `async def` for I/O operations
3. **Middleware**: Add CORS, logging, authentication
4. **Health Checks**: Essential for container orchestration
5. **Version API Routes**: `/api/v1/...` for future compatibility

## Running the Server

```bash
# Development
uvicorn main:app --reload --port 8000

# Production
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

## Key Takeaways

1. **FastAPI**: Modern, fast, auto-documented API framework
2. **Lifespan**: Modern pattern for startup/shutdown
3. **CORS**: Required for browser-based clients
4. **TestClient**: Easy testing without running server
5. **OpenAPI**: Automatic documentation generation
