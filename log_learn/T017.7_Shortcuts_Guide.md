# Learning Guide: Subtask 17.7 - Desktop Shortcut Creation

## Overview

This guide explains how to create and manage Windows shortcuts (.lnk files) using PowerShell. Shortcuts provide quick access to applications from the Desktop and Start Menu.

## Windows Shortcut Locations

### Desktop Paths
```powershell
# Current User Desktop
[Environment]::GetFolderPath('Desktop')
# Example: C:\Users\John\Desktop

# All Users (Public) Desktop
[Environment]::GetFolderPath('CommonDesktopDirectory')
# Example: C:\Users\Public\Desktop
```

### Start Menu Paths
```powershell
# Current User Programs
[Environment]::GetFolderPath('Programs')
# Example: C:\Users\John\AppData\Roaming\Microsoft\Windows\Start Menu\Programs

# All Users Programs
[Environment]::GetFolderPath('CommonPrograms')
# Example: C:\ProgramData\Microsoft\Windows\Start Menu\Programs
```

## Creating Shortcuts with WScript.Shell

### Basic Shortcut Creation

```powershell
# Create COM object
$WshShell = New-Object -ComObject WScript.Shell

# Create shortcut object
$ShortcutPath = "C:\Users\Public\Desktop\MyApp.lnk"
$Shortcut = $WshShell.CreateShortcut($ShortcutPath)

# Set properties
$Shortcut.TargetPath = "C:\Program Files\MyApp\MyApp.exe"
$Shortcut.WorkingDirectory = "C:\Program Files\MyApp"
$Shortcut.Description = "Launch My Application"
$Shortcut.IconLocation = "C:\Program Files\MyApp\MyApp.exe,0"

# Save the shortcut
$Shortcut.Save()

# Release COM object (good practice)
[System.Runtime.Interopservices.Marshal]::ReleaseComObject($WshShell) | Out-Null
```

### Shortcut Properties

| Property | Description | Example |
|----------|-------------|---------|
| TargetPath | Path to executable | "C:\App\App.exe" |
| WorkingDirectory | Start in folder | "C:\App" |
| Arguments | Command-line args | "--silent" |
| Description | Tooltip text | "My Application" |
| IconLocation | Icon path,index | "C:\App\App.exe,0" |
| WindowStyle | Window state | 1=Normal, 3=Max, 7=Min |
| Hotkey | Keyboard shortcut | "CTRL+ALT+M" |

### Window Styles

```powershell
# 1 = Normal window (default)
# 3 = Maximized window
# 7 = Minimized window

$Shortcut.WindowStyle = 1
```

### Setting a Hotkey

```powershell
# Format: "MODIFIER+KEY"
$Shortcut.Hotkey = "CTRL+ALT+A"
```

## Reusable Shortcut Function

```powershell
function New-Shortcut {
    param(
        [Parameter(Mandatory)]
        [string]$ShortcutPath,

        [Parameter(Mandatory)]
        [string]$TargetPath,

        [string]$WorkingDirectory,
        [string]$Description,
        [string]$IconLocation,
        [string]$Arguments,
        [int]$WindowStyle = 1
    )

    try {
        $WshShell = New-Object -ComObject WScript.Shell
        $Shortcut = $WshShell.CreateShortcut($ShortcutPath)

        $Shortcut.TargetPath = $TargetPath

        if ($WorkingDirectory) {
            $Shortcut.WorkingDirectory = $WorkingDirectory
        }
        if ($Description) {
            $Shortcut.Description = $Description
        }
        if ($IconLocation) {
            $Shortcut.IconLocation = "$IconLocation,0"
        }
        if ($Arguments) {
            $Shortcut.Arguments = $Arguments
        }

        $Shortcut.WindowStyle = $WindowStyle
        $Shortcut.Save()

        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($WshShell) | Out-Null
        return $true
    }
    catch {
        Write-Error "Failed to create shortcut: $_"
        return $false
    }
}
```

## Creating Start Menu Structure

### Application Folder with Multiple Shortcuts

```powershell
$AppName = "My Application"
$StartMenuPath = [Environment]::GetFolderPath('CommonPrograms')
$AppFolder = Join-Path $StartMenuPath $AppName

# Create application folder
if (-not (Test-Path $AppFolder)) {
    New-Item -ItemType Directory -Path $AppFolder -Force | Out-Null
}

# Main application shortcut
New-Shortcut -ShortcutPath (Join-Path $AppFolder "$AppName.lnk") `
             -TargetPath "C:\Program Files\MyApp\MyApp.exe" `
             -Description "Launch $AppName"

# Configuration shortcut
New-Shortcut -ShortcutPath (Join-Path $AppFolder "Configuration.lnk") `
             -TargetPath "C:\Program Files\MyApp\config" `
             -Description "Open configuration folder"

# Uninstall shortcut
New-Shortcut -ShortcutPath (Join-Path $AppFolder "Uninstall.lnk") `
             -TargetPath "C:\Program Files\MyApp\uninstall.exe" `
             -Description "Uninstall $AppName"
```

## Removing Shortcuts

### Remove Single Shortcut

```powershell
$ShortcutPath = "C:\Users\Public\Desktop\MyApp.lnk"

if (Test-Path $ShortcutPath) {
    Remove-Item -Path $ShortcutPath -Force
    Write-Host "Shortcut removed: $ShortcutPath"
} else {
    Write-Warning "Shortcut not found: $ShortcutPath"
}
```

### Remove Start Menu Folder

```powershell
$StartMenuPath = [Environment]::GetFolderPath('CommonPrograms')
$AppFolder = Join-Path $StartMenuPath "My Application"

if (Test-Path $AppFolder) {
    Remove-Item -Path $AppFolder -Recurse -Force
    Write-Host "Start Menu folder removed"
}
```

## All Users vs Current User

### When to Use Each

**All Users (requires admin):**
- Enterprise deployments
- Shared computers
- System-wide installation

**Current User:**
- Per-user installation
- No admin rights available
- User preference

### Implementation Pattern

```powershell
function Get-ShortcutPath {
    param(
        [string]$Location,  # "Desktop" or "StartMenu"
        [bool]$AllUsers = $false
    )

    if ($Location -eq "Desktop") {
        if ($AllUsers) {
            return [Environment]::GetFolderPath('CommonDesktopDirectory')
        } else {
            return [Environment]::GetFolderPath('Desktop')
        }
    }
    elseif ($Location -eq "StartMenu") {
        if ($AllUsers) {
            return [Environment]::GetFolderPath('CommonPrograms')
        } else {
            return [Environment]::GetFolderPath('Programs')
        }
    }
}
```

## Integration with Inno Setup

### ISS [Icons] Section

```pascal
[Icons]
; Start Menu shortcuts
Name: "{group}\{#MyAppName}"; Filename: "{app}\bin\app.exe"
Name: "{group}\Configuration"; Filename: "{app}\config"
Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"

; Desktop shortcut (optional task)
Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\bin\app.exe"; Tasks: desktopicon
```

### ISS [Tasks] Section

```pascal
[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; \
    GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked
```

### Calling PowerShell Script from ISS

```pascal
[Run]
; Create additional shortcuts
Filename: "powershell.exe"; \
    Parameters: "-ExecutionPolicy Bypass -File ""{app}\scripts\create-shortcuts.ps1"" -Create"; \
    Flags: runhidden waituntilterminated
```

## Best Practices

1. **Check Target Exists**: Verify executable exists before creating shortcut
2. **Use Proper Paths**: Use Environment.GetFolderPath for special folders
3. **Release COM Objects**: Prevent memory leaks
4. **Handle Errors**: Wrap in try-catch blocks
5. **Support Both Scopes**: Allow All Users and Current User
6. **Set Description**: Provides tooltip information
7. **Use Executable Icon**: IconLocation with index 0

## Common Issues

### Permission Denied
- All Users locations require admin privileges
- Fall back to Current User if admin not available

### Shortcut Not Appearing
- Refresh Explorer or restart
- Check path is correct
- Verify .lnk extension

### Icon Not Showing
- Ensure icon path exists
- Use full path, not relative
- Index starts at 0

## Summary

Windows shortcuts are created using the WScript.Shell COM object. Key steps:

1. Create COM object with `New-Object -ComObject WScript.Shell`
2. Create shortcut with `CreateShortcut($path)`
3. Set properties (TargetPath, WorkingDirectory, Description, etc.)
4. Save with `Save()` method
5. Release COM object

The implementation in `create-shortcuts.ps1` provides a flexible solution supporting both Desktop and Start Menu shortcuts for All Users or Current User scope.
