# T015.8 - License Management UI Guide

## Overview

This guide covers the implementation of a license management UI for the desktop application. The UI allows users to view license status, activate/deactivate licenses, see feature availability, and monitor expiration and offline status.

---

## Architecture

### Separation of Concerns

The implementation is split into two files:

| File | Purpose |
|------|---------|
| `LicenseManagementUtils.ts` | Pure TypeScript utility functions |
| `LicenseManagement.tsx` | React components using utilities |

**Benefits:**
- Utility functions are testable without JSX
- Logic can be reused outside React
- Easier to maintain and refactor

---

## Type Definitions

### Core Types

```typescript
type LicenseType = 'trial' | 'standard' | 'professional' | 'enterprise';
type LicenseStatus = 'active' | 'expired' | 'revoked' | 'suspended' | 'pending';
type ExpirationStatus = 'active' | 'warning' | 'critical' | 'expired' | 'perpetual';

interface LicenseDisplayInfo {
  type: LicenseType;
  status: LicenseStatus;
  features: string[];
  expiresAt: Date | null;
  activationCount: number;
  maxActivations: number;
  isOffline: boolean;
}

interface LicenseUIState {
  license: LicenseDisplayInfo | null;
  isLoading: boolean;
  isActivating: boolean;
  isDeactivating: boolean;
  error: string | null;
  showActivationForm: boolean;
  isOffline: boolean;
  gracePeriodRemaining: number | null;
}
```

---

## License Key Input

### Format

License keys use the format: `XXXX-XXXX-XXXX-XXXX`

- 16 alphanumeric characters
- Separated by dashes every 4 characters
- Auto-uppercase conversion

### Auto-Formatting Function

```typescript
function formatLicenseKeyInput(input: string): string {
  // Remove non-alphanumeric characters
  const cleaned = input.replace(/[^A-Za-z0-9]/g, '').toUpperCase();

  // Limit to 16 characters
  const limited = cleaned.slice(0, 16);

  // Insert dashes every 4 characters
  const segments = limited.match(/.{1,4}/g) || [];
  return segments.join('-');
}
```

### Validation

```typescript
function validateLicenseKeyFormat(key: string): {
  isValid: boolean;
  error?: string;
} {
  const cleaned = key.replace(/-/g, '');

  if (cleaned.length === 0) {
    return { isValid: false, error: 'License key is required' };
  }

  if (cleaned.length < 16) {
    return { isValid: false, error: 'License key is incomplete' };
  }

  if (!/^[A-Z0-9]+$/.test(cleaned)) {
    return { isValid: false, error: 'Invalid characters in license key' };
  }

  return { isValid: true };
}
```

---

## Expiration Handling

### Thresholds

```typescript
const WARNING_THRESHOLD_DAYS = 30;   // Show warning
const CRITICAL_THRESHOLD_DAYS = 7;   // Show critical alert
```

### Status Determination

```typescript
function getExpirationStatus(expiresAt: Date | null): ExpirationStatus {
  if (!expiresAt) return 'perpetual';

  const now = new Date();
  const daysRemaining = Math.ceil(
    (expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)
  );

  if (daysRemaining <= 0) return 'expired';
  if (daysRemaining <= CRITICAL_THRESHOLD_DAYS) return 'critical';
  if (daysRemaining <= WARNING_THRESHOLD_DAYS) return 'warning';
  return 'active';
}
```

### Color Mapping

```typescript
function getExpirationColor(status: ExpirationStatus): string {
  switch (status) {
    case 'active':
    case 'perpetual':
      return 'text-green-600';
    case 'warning':
      return 'text-yellow-600';
    case 'critical':
    case 'expired':
      return 'text-red-600';
  }
}
```

---

## Feature Display

### Available Features

| Feature Key | Display Name | Description |
|-------------|--------------|-------------|
| `basic` | Basic Processing | Process single invoices |
| `export` | Export Data | Export to CSV/Excel |
| `batch` | Batch Processing | Process multiple files |
| `api` | API Access | REST API integration |
| `unlimited` | Unlimited Processing | No processing limits |

### Feature Availability Check

```typescript
function isFeatureAvailable(
  feature: string,
  license: LicenseDisplayInfo | null
): boolean {
  if (!license) return false;
  if (license.status !== 'active') return false;
  return license.features.includes(feature);
}
```

### Feature Display Items

```typescript
function createFeatureDisplayItems(
  license: LicenseDisplayInfo | null
): FeatureDisplayItem[] {
  const allFeatures = ['basic', 'export', 'batch', 'api', 'unlimited'];

  return allFeatures.map(feature => ({
    key: feature,
    name: getFeatureDisplayName(feature),
    description: getFeatureDescription(feature),
    isAvailable: isFeatureAvailable(feature, license),
    icon: getFeatureIcon(feature)
  }));
}
```

---

## Badge Components

### License Type Badge

| Type | Color |
|------|-------|
| Trial | Gray (bg-gray-100, text-gray-800) |
| Standard | Blue (bg-blue-100, text-blue-800) |
| Professional | Purple (bg-purple-100, text-purple-800) |
| Enterprise | Yellow (bg-yellow-100, text-yellow-800) |

```tsx
function LicenseTypeBadge({ type }: { type: LicenseType }) {
  const colorClass = getLicenseTypeBadgeColor(type);
  const displayName = getLicenseTypeDisplayName(type);

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${colorClass}`}>
      {displayName}
    </span>
  );
}
```

### License Status Badge

| Status | Color |
|--------|-------|
| Active | Green |
| Expired | Red |
| Revoked | Red |
| Suspended | Yellow |
| Pending | Gray |

```tsx
function LicenseStatusBadge({ status }: { status: LicenseStatus }) {
  const colorClass = getLicenseStatusColor(status);
  const displayName = getLicenseStatusDisplayName(status);

  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${colorClass}`}>
      {displayName}
    </span>
  );
}
```

---

## Offline Mode Display

### Grace Period Progress

```typescript
interface GracePeriodDisplay {
  totalDays: number;
  remainingDays: number;
  percentRemaining: number;
  message: string;
  severity: 'normal' | 'warning' | 'critical';
}

function getGracePeriodDisplay(
  gracePeriodRemaining: number | null,
  totalGracePeriod: number = 7
): GracePeriodDisplay | null {
  if (gracePeriodRemaining === null) return null;

  const percentRemaining = (gracePeriodRemaining / totalGracePeriod) * 100;

  let severity: 'normal' | 'warning' | 'critical';
  if (gracePeriodRemaining <= 1) {
    severity = 'critical';
  } else if (gracePeriodRemaining <= 3) {
    severity = 'warning';
  } else {
    severity = 'normal';
  }

  return {
    totalDays: totalGracePeriod,
    remainingDays: gracePeriodRemaining,
    percentRemaining,
    message: formatGracePeriodRemaining(gracePeriodRemaining),
    severity
  };
}
```

### Offline Status Indicator Component

```tsx
function OfflineStatusIndicator({ state }: { state: LicenseUIState }) {
  const gracePeriod = getGracePeriodDisplay(state.gracePeriodRemaining);

  if (!state.isOffline) {
    return (
      <div className="flex items-center text-green-600">
        <OnlineIcon className="w-4 h-4 mr-2" />
        Online
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <div className="flex items-center text-yellow-600">
        <OfflineIcon className="w-4 h-4 mr-2" />
        Offline Mode
      </div>

      {gracePeriod && (
        <div>
          <div className="text-sm text-gray-600">
            {gracePeriod.message}
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
            <div
              className={`h-2 rounded-full ${
                gracePeriod.severity === 'critical' ? 'bg-red-500' :
                gracePeriod.severity === 'warning' ? 'bg-yellow-500' :
                'bg-green-500'
              }`}
              style={{ width: `${gracePeriod.percentRemaining}%` }}
            />
          </div>
        </div>
      )}
    </div>
  );
}
```

---

## Main Components

### LicenseActivationForm

```tsx
function LicenseActivationForm({
  onActivate,
  isActivating
}: LicenseActivationFormProps) {
  const [inputState, setInputState] = useState(createLicenseInputState());

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const formatted = formatLicenseKeyInput(e.target.value);
    const validation = validateLicenseKeyFormat(formatted);

    setInputState({
      value: formatted,
      isValid: validation.isValid,
      error: validation.error || null,
      touched: true
    });
  };

  const handleSubmit = () => {
    if (inputState.isValid) {
      onActivate(inputState.value);
    }
  };

  return (
    <div className="space-y-4">
      <input
        type="text"
        value={inputState.value}
        onChange={handleChange}
        placeholder="XXXX-XXXX-XXXX-XXXX"
        className="w-full px-4 py-2 border rounded-lg font-mono"
      />

      {inputState.error && inputState.touched && (
        <p className="text-red-500 text-sm">{inputState.error}</p>
      )}

      <button
        onClick={handleSubmit}
        disabled={!inputState.isValid || isActivating}
        className="w-full px-4 py-2 bg-primary-600 text-white rounded-lg"
      >
        {isActivating ? 'Activating...' : 'Activate License'}
      </button>
    </div>
  );
}
```

### LicenseInfoCard

```tsx
function LicenseInfoCard({ license }: { license: LicenseDisplayInfo }) {
  const expirationStatus = getExpirationStatus(license.expiresAt);
  const features = createFeatureDisplayItems(license);

  return (
    <div className="bg-white rounded-lg shadow p-6 space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-medium">License Information</h3>
        <div className="flex gap-2">
          <LicenseTypeBadge type={license.type} />
          <LicenseStatusBadge status={license.status} />
        </div>
      </div>

      {expirationStatus !== 'active' && expirationStatus !== 'perpetual' && (
        <ExpirationWarningAlert
          status={expirationStatus}
          expiresAt={license.expiresAt}
        />
      )}

      <div className="grid grid-cols-2 gap-4">
        <div>
          <p className="text-sm text-gray-500">Expires</p>
          <p className={getExpirationColor(expirationStatus)}>
            {formatExpirationDate(license.expiresAt)}
          </p>
        </div>
        <div>
          <p className="text-sm text-gray-500">Activations</p>
          <p>{formatActivationCount(license)}</p>
        </div>
      </div>

      <FeatureList features={features} />
    </div>
  );
}
```

---

## State Management

### Immutable Updates

```typescript
function updateLicenseUIState(
  state: LicenseUIState,
  updates: Partial<LicenseUIState>
): LicenseUIState {
  return { ...state, ...updates };
}
```

### Usage in React

```typescript
function useLicenseManagement() {
  const [state, setState] = useState(createEmptyLicenseUIState());

  const activate = async (key: string) => {
    setState(s => updateLicenseUIState(s, { isActivating: true }));

    try {
      const license = await licenseService.activate(key);
      setState(s => updateLicenseUIState(s, {
        license: createLicenseDisplayInfo(license),
        isActivating: false,
        showActivationForm: false,
        error: null
      }));
    } catch (error) {
      setState(s => updateLicenseUIState(s, {
        isActivating: false,
        error: error.message
      }));
    }
  };

  return { state, activate };
}
```

---

## Testing

### Testing Utility Functions

```typescript
describe('License Key Formatting', () => {
  it('formats key with dashes', () => {
    expect(formatLicenseKeyInput('ABCD1234EFGH5678'))
      .toBe('ABCD-1234-EFGH-5678');
  });

  it('converts to uppercase', () => {
    expect(formatLicenseKeyInput('abcd'))
      .toBe('ABCD');
  });

  it('removes invalid characters', () => {
    expect(formatLicenseKeyInput('AB!@#CD'))
      .toBe('ABCD');
  });
});

describe('Expiration Status', () => {
  it('returns expired for past dates', () => {
    const pastDate = new Date(Date.now() - 86400000);
    expect(getExpirationStatus(pastDate)).toBe('expired');
  });

  it('returns critical within 7 days', () => {
    const soon = new Date(Date.now() + 5 * 86400000);
    expect(getExpirationStatus(soon)).toBe('critical');
  });
});
```

---

## Best Practices

1. **Separate Logic from UI**: Keep utility functions pure and testable
2. **Immutable State**: Always return new objects from update functions
3. **Clear Visual Hierarchy**: Use badges and colors consistently
4. **Graceful Degradation**: Handle offline mode smoothly
5. **User Feedback**: Show loading states and error messages

---

## References

- [React State Management](https://react.dev/learn/managing-state)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Software Licensing Best Practices](https://www.keygen.sh/docs)
