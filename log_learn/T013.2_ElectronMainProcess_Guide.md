# Electron Main Process Configuration - Learning Guide

## Overview
How to configure an Electron main process with security, IPC communication, and proper lifecycle management.

## Key Concepts

### 1. Single Instance Lock
Prevent multiple app instances:
```typescript
const gotTheLock = app.requestSingleInstanceLock();

if (!gotTheLock) {
  app.quit();
} else {
  app.on('second-instance', () => {
    if (mainWindow) {
      if (mainWindow.isMinimized()) mainWindow.restore();
      mainWindow.focus();
    }
  });
}
```

### 2. Security Best Practices

**BrowserWindow Security Settings:**
```typescript
new BrowserWindow({
  webPreferences: {
    nodeIntegration: false,     // Don't expose Node.js
    contextIsolation: true,     // Separate JS contexts
    sandbox: true,              // Chromium sandbox
    preload: 'preload.js',      // Safe bridge
  },
});
```

| Setting | Value | Purpose |
|---------|-------|---------|
| nodeIntegration | false | Prevent require() in renderer |
| contextIsolation | true | Isolate preload from renderer |
| sandbox | true | Chromium process sandbox |

### 3. IPC Communication Pattern

**Main Process (main.ts):**
```typescript
import { ipcMain } from 'electron';

ipcMain.handle('api:getData', async (event, arg) => {
  return await fetchData(arg);
});
```

**Preload Script (preload.ts):**
```typescript
import { contextBridge, ipcRenderer } from 'electron';

contextBridge.exposeInMainWorld('api', {
  getData: (arg) => ipcRenderer.invoke('api:getData', arg),
});
```

**Renderer (React):**
```typescript
const data = await window.api.getData('param');
```

### 4. Application Menu

```typescript
const template = [
  {
    label: 'File',
    submenu: [
      {
        label: 'Open...',
        accelerator: 'CmdOrCtrl+O',
        click: async () => {
          const files = await selectFiles();
          mainWindow.webContents.send('files:selected', files);
        },
      },
      { type: 'separator' },
      { role: 'quit' },
    ],
  },
  {
    label: 'Edit',
    submenu: [
      { role: 'undo' },
      { role: 'redo' },
      { type: 'separator' },
      { role: 'cut' },
      { role: 'copy' },
      { role: 'paste' },
    ],
  },
];

Menu.setApplicationMenu(Menu.buildFromTemplate(template));
```

### 5. File Dialogs

```typescript
async function selectPdfFiles(): Promise<string[]> {
  const result = await dialog.showOpenDialog(mainWindow, {
    title: 'Select PDFs',
    properties: ['openFile', 'multiSelections'],
    filters: [
      { name: 'PDF Files', extensions: ['pdf'] },
    ],
  });

  return result.canceled ? [] : result.filePaths;
}
```

### 6. Ready-to-Show Pattern
Prevent white flash:
```typescript
mainWindow = new BrowserWindow({
  show: false,  // Don't show immediately
  backgroundColor: '#1f2937',  // Background while loading
});

mainWindow.once('ready-to-show', () => {
  mainWindow.show();
});
```

### 7. Graceful Shutdown

```typescript
app.on('before-quit', async () => {
  await cleanup();
});

mainWindow.on('close', (event) => {
  if (!isQuitting) {
    event.preventDefault();
    showConfirmDialog();
  }
});
```

## Architecture

```
┌─────────────────────────────────────┐
│           Main Process              │
│  ┌─────────┐  ┌─────────────────┐   │
│  │ Window  │  │  IPC Handlers   │   │
│  │ Manager │  │  - docker:*     │   │
│  └────┬────┘  │  - health:*     │   │
│       │       │  - dialog:*     │   │
│       │       └────────┬────────┘   │
│       │                │            │
│       └────────┬───────┘            │
│                │                    │
│          ┌─────▼─────┐              │
│          │ preload.ts│              │
│          │ (bridge)  │              │
│          └─────┬─────┘              │
└────────────────┼────────────────────┘
                 │ contextBridge
┌────────────────▼────────────────────┐
│        Renderer Process             │
│  ┌─────────────────────────────┐    │
│  │      window.electronAPI     │    │
│  │  .dockerStatus()            │    │
│  │  .selectFiles()             │    │
│  │  .healthCheck()             │    │
│  └─────────────────────────────┘    │
│                                     │
│         React Application           │
└─────────────────────────────────────┘
```

## Best Practices

1. **Always use contextIsolation** - Never expose Node.js to renderer
2. **Use ipcMain.handle** - For async request/response
3. **Type your preload bridge** - Add TypeScript definitions
4. **Single instance lock** - Prevent multiple windows
5. **Ready-to-show pattern** - No white flash
6. **Graceful shutdown** - Cleanup before exit

## Common Pitfalls

1. **nodeIntegration: true** - Major security risk
2. **Forgetting contextIsolation** - Exposes preload scope
3. **Blocking main process** - Use async operations
4. **Missing error handling** - IPC can fail
5. **No single instance** - Multiple windows confusion

## Key Takeaways

1. Main process handles system operations
2. Preload bridges main and renderer safely
3. IPC is the only communication channel
4. Security settings protect against XSS
5. Menu provides native app experience
6. Graceful shutdown prevents data loss
