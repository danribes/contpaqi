# T002.8 - Dataset Generation - Learning Guide

**Subtask**: 2.8 - Generate 5,000+ synthetic invoice samples
**Date**: 2025-12-03
**Audience**: Developers building synthetic training datasets for ML

---

## What Was Built

A complete pipeline for generating synthetic invoice datasets, combining all previous Task 2 components into a working system that produces PDFs and corresponding ground truth labels.

---

## Why Synthetic Data?

### The Challenge

Training AI models for document understanding (like invoice processing) requires:
- Thousands of labeled samples
- Consistent ground truth labels
- Variety in visual appearance
- Privacy compliance (can't use real invoices)

### The Solution

Synthetic data generation provides:
- Unlimited samples on demand
- Perfect ground truth (we know exact values)
- Controlled variety (templates, fonts, layouts)
- No privacy concerns

---

## Pipeline Overview

```
┌─────────────┐    ┌────────────┐    ┌─────────────┐    ┌────────────┐
│  20 HTML    │───▶│   Random   │───▶│   Jinja2    │───▶│  WeasyPrint│
│  Templates  │    │  Invoice   │    │   Render    │    │   to PDF   │
└─────────────┘    │   Data     │    └─────────────┘    └─────┬──────┘
                   └─────┬──────┘                             │
                         │                                    ▼
                         │                           invoice_00001.pdf
                         ▼
                   invoice_00001.json
```

---

## Key Components

### 1. Template System (Jinja2)

Templates are HTML files with placeholders:

```html
<div class="invoice-header">
    <h1>{{ emisor.name }}</h1>
    <p>RFC: {{ emisor.rfc }}</p>
</div>

<table class="items">
    {% for item in items %}
    <tr>
        <td>{{ item.description }}</td>
        <td>{{ item.quantity }}</td>
        <td>${{ "%.2f"|format(item.unit_price) }}</td>
        <td>${{ "%.2f"|format(item.amount) }}</td>
    </tr>
    {% endfor %}
</table>

<div class="totals">
    <p>Subtotal: ${{ "%.2f"|format(subtotal) }}</p>
    <p>IVA (16%): ${{ "%.2f"|format(iva) }}</p>
    <p>Total: ${{ "%.2f"|format(total) }}</p>
</div>
```

### 2. Data Generation (Faker)

```python
from faker import Faker

fake = Faker('es_MX')  # Mexican locale

def generate_invoice_data(fake):
    return {
        'emisor': {
            'name': fake.company(),          # "Grupo Martínez S.A. de C.V."
            'rfc': generate_rfc(fake),       # "XAXX010101ABC"
            'address': fake.address()        # Mexican address
        },
        'receptor': {...},
        'items': generate_line_items(fake),
        'subtotal': sum(item['amount'] for item in items),
        'iva': subtotal * 0.16,
        'total': subtotal + iva
    }
```

### 3. PDF Generation (WeasyPrint)

```python
from weasyprint import HTML

def render_invoice_pdf(template_path, invoice_data, output_path):
    # Load template
    env = Environment(loader=FileSystemLoader(template_dir))
    template = env.get_template(template_name)

    # Render HTML
    html_content = template.render(**invoice_data)

    # Convert to PDF
    HTML(string=html_content).write_pdf(output_path)
```

### 4. Ground Truth Labels

```python
def save_ground_truth(invoice_data, output_path):
    ground_truth = {
        'fields': {
            'rfc_emisor': invoice_data['emisor']['rfc'],
            'rfc_receptor': invoice_data['receptor']['rfc'],
            'subtotal': invoice_data['subtotal'],
            'iva': invoice_data['iva'],
            'total': invoice_data['total']
        },
        'line_items': invoice_data['items']
    }
    with open(output_path, 'w') as f:
        json.dump(ground_truth, f, indent=2)
```

---

## Using the Generator

### Command Line

```bash
# Generate 5000 samples
python scripts/generate_invoices.py \
    --num-samples 5000 \
    --output-dir ./data/synthetic \
    --templates-dir ./scripts/templates \
    --seed 42
```

### Output Structure

```
data/synthetic/
├── pdfs/
│   ├── invoice_00000.pdf
│   ├── invoice_00001.pdf
│   ├── invoice_00002.pdf
│   └── ... (5000 PDFs)
└── labels/
    ├── invoice_00000.json
    ├── invoice_00001.json
    ├── invoice_00002.json
    └── ... (5000 JSON files)
```

---

## Template Variety

20 templates with different characteristics:

| Template | Font | Layout | Style |
|----------|------|--------|-------|
| 01-05 | Arial, Helvetica | Single column | Corporate |
| 06-10 | Open Sans, Source Sans | Two column | Modern |
| 11-15 | Roboto, Lato | Grid | Minimalist |
| 16 | Montserrat | Dark mode | Dark theme |
| 17-20 | Various | Landscape | Wide format |

This variety ensures the AI model sees diverse visual presentations.

---

## RFC (Mexican Tax ID) Generation

```python
def generate_rfc(fake):
    # 4 letters (name initials)
    letters = ''.join(random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ', k=4))

    # 6 digits (birth date YYMMDD)
    birth_date = fake.date_of_birth()
    date_str = birth_date.strftime('%y%m%d')

    # 3 alphanumeric (homoclave)
    homoclave = ''.join(random.choices('ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789', k=3))

    return f"{letters}{date_str}{homoclave}"
    # Example: XAXX010101ABC
```

---

## Ensuring Data Quality

### 1. Math Consistency

```python
# IVA is exactly 16%
iva = round(subtotal * 0.16, 2)

# Total = Subtotal + IVA
total = round(subtotal + iva, 2)
```

### 2. Reproducibility

```python
# Set seeds for reproducible generation
random.seed(42)
Faker.seed(42)

# Same seeds = identical dataset
```

### 3. Validation

Tests verify:
- RFC format matches Mexican standard
- Total = Subtotal + IVA (within rounding)
- IVA = 16% of Subtotal
- PDFs have valid %PDF header
- All files are generated

---

## Best Practices

### 1. Use Seeds for Reproducibility

```python
# Always set seed for reproducible datasets
random.seed(42)
Faker.seed(42)

# Document the seed used for training
metadata = {'seed': 42, 'num_samples': 5000}
```

### 2. Vary Templates

```python
# Random template selection for variety
templates = get_available_templates(templates_dir)
template = random.choice(templates)
```

### 3. Track Statistics

```python
stats = {'generated': 0, 'failed': 0}

for i in range(num_samples):
    if render_pdf(...):
        stats['generated'] += 1
    else:
        stats['failed'] += 1

print(f"Success rate: {stats['generated']/num_samples*100:.1f}%")
```

### 4. Use Progress Bars

```python
from tqdm import tqdm

for i in tqdm(range(num_samples), desc="Generating invoices"):
    # Generate...
```

---

## Performance Considerations

### Generation Speed

- ~1 PDF/second (WeasyPrint is the bottleneck)
- 5000 samples ≈ 80 minutes

### Parallelization Options

```python
# For faster generation (not implemented yet)
from concurrent.futures import ProcessPoolExecutor

def generate_batch(batch_indices):
    # Generate subset of invoices
    ...

with ProcessPoolExecutor(max_workers=4) as executor:
    executor.map(generate_batch, batches)
```

---

## Next Steps: Using the Dataset

After generating the dataset, prepare it for ML training:

### For TATR (Table Detection)

```python
# Convert to COCO format
coco_annotations = {
    "images": [...],
    "annotations": [...],  # Table/row bounding boxes
    "categories": [{"id": 1, "name": "table"}]
}
```

### For LayoutLMv3 (Field Extraction)

```python
# Create BIO-tagged tokens
tokens = ["Subtotal:", "1,000.00"]
labels = ["O", "B-SUBTOTAL"]  # BIO format
```

### Train/Val/Test Splits

```python
from sklearn.model_selection import train_test_split

train, temp = train_test_split(samples, test_size=0.2)
val, test = train_test_split(temp, test_size=0.5)
# Result: 80% train, 10% val, 10% test
```

---

## Summary

Task 2 is now complete. We built a synthetic invoice generator that:

1. **Templates**: 20 varied HTML/CSS templates
2. **Data**: Mexican locale with valid RFCs
3. **Generation**: WeasyPrint PDF creation
4. **Labels**: JSON ground truth files
5. **Quality**: Math validation, reproducibility

This provides a solid foundation for training AI models to extract data from Mexican invoices.
