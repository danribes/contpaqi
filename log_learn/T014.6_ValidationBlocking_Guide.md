# T014.6 - Validation Blocking Guide

## Overview

This guide covers the implementation of form validation blocking that disables the Submit button when validation errors exist. This prevents users from submitting invalid invoices and provides clear feedback about what needs to be corrected.

---

## Validation Categories

### 1. Missing Required Fields

Fields that must have a value:

| Field | Description |
|-------|-------------|
| rfcEmisor | Issuer's tax ID |
| rfcReceptor | Recipient's tax ID |
| fecha | Invoice date |
| subtotal | Pre-tax amount |
| iva | Tax amount |
| total | Final amount |

### 2. Field Format Errors

Invalid data format:

| Error Type | Example |
|------------|---------|
| Invalid RFC | Too short, wrong checksum |
| Invalid Date | Wrong format, future date |
| Invalid Amount | Negative, non-numeric |

### 3. Math Calculation Errors

Arithmetic inconsistencies:

| Error | Expected |
|-------|----------|
| IVA mismatch | IVA = Subtotal × 0.16 |
| Total mismatch | Total = Subtotal + IVA |

---

## ValidationState Interface

```typescript
interface ValidationState {
  isValid: boolean;           // All validations pass
  canSubmit: boolean;         // Submit button enabled
  blockingReasons: string[];  // Human-readable reasons
  fieldErrors: Record<string, string>;  // Per-field errors
  mathErrors: string[];       // Math calculation errors
  missingRequired: string[];  // Missing required fields
}
```

---

## Core Functions

### isFieldEmpty

```typescript
function isFieldEmpty(value: string): boolean {
  return !value || value.trim() === '';
}
```

### getMissingRequiredFields

```typescript
const REQUIRED_FIELDS = [
  'rfcEmisor', 'rfcReceptor', 'fecha',
  'subtotal', 'iva', 'total'
];

function getMissingRequiredFields(values: FormValues): string[] {
  return REQUIRED_FIELDS.filter(field =>
    isFieldEmpty(values[field])
  );
}
```

### getFieldErrors

```typescript
function getFieldErrors(values: FormValues): Record<string, string> {
  const errors: Record<string, string> = {};

  // RFC validation (13 characters, alphanumeric)
  if (values.rfcEmisor && !isValidRFC(values.rfcEmisor)) {
    errors.rfcEmisor = 'Invalid RFC format';
  }

  // Date validation
  if (values.fecha && !isValidDate(values.fecha)) {
    errors.fecha = 'Invalid date format';
  }

  // Amount validation
  ['subtotal', 'iva', 'total'].forEach(field => {
    if (values[field] && !isValidAmount(values[field])) {
      errors[field] = 'Invalid amount';
    }
  });

  return errors;
}
```

### getMathErrors

```typescript
function getMathErrors(values: FormValues): string[] {
  const errors: string[] = [];

  const subtotal = parseFloat(values.subtotal) || 0;
  const iva = parseFloat(values.iva) || 0;
  const total = parseFloat(values.total) || 0;

  // IVA should be 16% of subtotal
  const expectedIva = subtotal * 0.16;
  if (Math.abs(iva - expectedIva) > 0.01) {
    errors.push('IVA does not equal 16% of subtotal');
  }

  // Total should be subtotal + IVA
  const expectedTotal = subtotal + iva;
  if (Math.abs(total - expectedTotal) > 0.01) {
    errors.push('Total does not equal subtotal + IVA');
  }

  return errors;
}
```

### calculateValidationState

```typescript
function calculateValidationState(values: FormValues): ValidationState {
  const missingRequired = getMissingRequiredFields(values);
  const fieldErrors = getFieldErrors(values);
  const mathErrors = getMathErrors(values);

  const blockingReasons: string[] = [];

  if (missingRequired.length > 0) {
    blockingReasons.push(
      `Missing required fields: ${missingRequired.join(', ')}`
    );
  }

  Object.entries(fieldErrors).forEach(([field, error]) => {
    blockingReasons.push(`${field}: ${error}`);
  });

  mathErrors.forEach(error => {
    blockingReasons.push(error);
  });

  const isValid = blockingReasons.length === 0;

  return {
    isValid,
    canSubmit: isValid,
    blockingReasons,
    fieldErrors,
    mathErrors,
    missingRequired
  };
}
```

---

## UI Components

### ValidationBlockerBanner

Amber warning banner showing all blocking reasons:

```tsx
function ValidationBlockerBanner({
  validationState,
  className
}: ValidationBlockerBannerProps) {
  if (validationState.canSubmit) return null;

  return (
    <div className={`bg-amber-50 border border-amber-300
                     rounded-lg p-4 ${className}`}>
      <div className="flex items-start">
        <WarningIcon className="text-amber-500 mr-3" />
        <div>
          <h4 className="text-amber-800 font-medium">
            Cannot Submit Invoice
          </h4>
          <ul className="mt-2 text-amber-700 text-sm">
            {validationState.blockingReasons.map((reason, i) => (
              <li key={i}>• {reason}</li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  );
}
```

### SubmitButton

Validation-aware submit button:

```tsx
function SubmitButton({
  validationState,
  onClick,
  isSubmitting
}: SubmitButtonProps) {
  const canSubmit = validationState.canSubmit;
  const tooltip = getSubmitButtonTooltip(validationState);

  return (
    <button
      onClick={onClick}
      disabled={!canSubmit || isSubmitting}
      className={getSubmitButtonClasses(canSubmit)}
      title={tooltip}
    >
      {isSubmitting ? <Spinner /> : 'Submit Invoice'}
    </button>
  );
}
```

### MiniValidationIndicator

Compact status indicator:

```tsx
function MiniValidationIndicator({
  validationState
}: MiniValidationIndicatorProps) {
  if (validationState.canSubmit) {
    return (
      <span className="text-green-600 flex items-center">
        <CheckIcon className="w-4 h-4 mr-1" />
        Ready
      </span>
    );
  }

  const issueCount = validationState.blockingReasons.length;
  return (
    <span
      className="text-amber-600 flex items-center"
      title={validationState.blockingReasons.join('\n')}
    >
      <WarningIcon className="w-4 h-4 mr-1" />
      {issueCount} {issueCount === 1 ? 'issue' : 'issues'}
    </span>
  );
}
```

---

## Styling

### Enabled Submit Button

```css
.submit-enabled {
  @apply bg-primary-600 hover:bg-primary-700;
  @apply text-white cursor-pointer;
  @apply transition-colors duration-200;
}
```

### Disabled Submit Button

```css
.submit-disabled {
  @apply bg-gray-400 text-gray-200;
  @apply cursor-not-allowed opacity-50;
}
```

### Helper Function

```typescript
function getSubmitButtonClasses(canSubmit: boolean): string {
  const base = 'px-6 py-2 rounded-lg font-medium';

  if (canSubmit) {
    return `${base} bg-primary-600 hover:bg-primary-700
            text-white cursor-pointer`;
  }

  return `${base} bg-gray-400 text-gray-200
          cursor-not-allowed opacity-50`;
}
```

---

## Integration with InvoiceForm

### Using useMemo for Performance

```typescript
function InvoiceForm() {
  const [formState, setFormState] = useState(initialState);

  const validationState = useMemo(() => {
    const values: FormValues = {
      rfcEmisor: formState.rfcEmisor.value,
      rfcReceptor: formState.rfcReceptor.value,
      fecha: formState.fecha.value,
      subtotal: formState.subtotal.value,
      iva: formState.iva.value,
      total: formState.total.value,
    };
    return calculateValidationState(values);
  }, [
    formState.rfcEmisor.value,
    formState.rfcReceptor.value,
    formState.fecha.value,
    formState.subtotal.value,
    formState.iva.value,
    formState.total.value,
  ]);

  return (
    <form>
      {/* Form fields */}

      <ValidationBlockerBanner
        validationState={validationState}
        className="mb-4"
      />

      <div className="flex items-center gap-4">
        <SubmitButton
          validationState={validationState}
          onClick={handleSubmit}
          isSubmitting={isSubmitting}
        />
        <MiniValidationIndicator
          validationState={validationState}
        />
      </div>
    </form>
  );
}
```

---

## Custom Hook

```typescript
function useValidationBlocking(formValues: FormValues) {
  const validationState = useMemo(
    () => calculateValidationState(formValues),
    [formValues]
  );

  return {
    validationState,
    canSubmit: validationState.canSubmit,
    isBlocked: !validationState.canSubmit,
    blockingReasons: validationState.blockingReasons,
    hasFieldErrors: Object.keys(validationState.fieldErrors).length > 0,
    hasMathErrors: validationState.mathErrors.length > 0,
    hasMissingFields: validationState.missingRequired.length > 0,
  };
}
```

---

## User Experience

### Empty Form State

- Submit button: Disabled (gray)
- Banner: Shows "Missing required fields: rfcEmisor, rfcReceptor, ..."
- Indicator: "6 issues"

### Partial Form State

- Submit button: Disabled
- Banner: Shows remaining issues
- Indicator: Updates count in real-time

### Valid Form State

- Submit button: Enabled (primary color)
- Banner: Hidden
- Indicator: "Ready" with checkmark

---

## Best Practices

1. **Real-time Validation**: Update on every field change
2. **Clear Messages**: Use human-readable field names
3. **Prioritize Errors**: Show most important errors first
4. **Tooltips**: Provide details on hover
5. **Accessibility**: Use ARIA attributes for screen readers

---

## Testing

```typescript
describe('Validation Blocking', () => {
  it('blocks submit with missing required fields', () => {
    const state = calculateValidationState({
      rfcEmisor: '',
      rfcReceptor: 'XEXX010101000',
      fecha: '2024-03-15',
      subtotal: '1000',
      iva: '160',
      total: '1160'
    });

    expect(state.canSubmit).toBe(false);
    expect(state.missingRequired).toContain('rfcEmisor');
  });

  it('blocks submit with math errors', () => {
    const state = calculateValidationState({
      rfcEmisor: 'XAXX010101ABC',
      rfcReceptor: 'XEXX010101000',
      fecha: '2024-03-15',
      subtotal: '1000',
      iva: '100',  // Should be 160
      total: '1100'
    });

    expect(state.canSubmit).toBe(false);
    expect(state.mathErrors.length).toBeGreaterThan(0);
  });

  it('allows submit with valid form', () => {
    const state = calculateValidationState({
      rfcEmisor: 'XAXX010101ABC',
      rfcReceptor: 'XEXX010101000',
      fecha: '2024-03-15',
      subtotal: '1000',
      iva: '160',
      total: '1160'
    });

    expect(state.canSubmit).toBe(true);
    expect(state.blockingReasons).toHaveLength(0);
  });
});
```

---

## References

- [React Form Validation](https://react.dev/learn/sharing-state-between-components)
- [Tailwind CSS Forms](https://tailwindcss.com/docs/plugins#forms)
- [WCAG Form Validation](https://www.w3.org/WAI/tutorials/forms/validation/)
