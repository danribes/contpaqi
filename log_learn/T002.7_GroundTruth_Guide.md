# T002.7 - Ground Truth Labels - Learning Guide

**Subtask**: 2.7 - Create JSON sidecar file generator for ground truth labels
**Date**: 2025-12-03
**Audience**: Developers working with OCR training data

---

## What Was Built

A Python module (`ground_truth.py`) for generating JSON sidecar files that pair invoice field values with their bounding boxes for OCR model training.

---

## Understanding Ground Truth

### What is Ground Truth?

Ground truth in machine learning is the "correct answer" that we train models to predict. For OCR:

- **Input**: Image of an invoice
- **Ground Truth**: JSON file with field values and their locations (bboxes)
- **Goal**: Train model to find fields and read their values

### Why Sidecar Files?

Sidecar files keep data organized:

```
output/
├── invoice_001.png     # Image
├── invoice_001.json    # Ground truth (sidecar)
├── invoice_002.png
├── invoice_002.json
└── ...
```

Benefits:
- Images stay separate from labels
- Easy to version control labels
- Standard format for ML pipelines

---

## JSON Structure

### Complete Example

```json
{
  "fields": {
    "rfc_emisor": {
      "value": "XAXX010101ABC",
      "bbox": {"x": 100, "y": 150, "width": 130, "height": 25}
    },
    "rfc_receptor": {
      "value": "XBBB020202XYZ",
      "bbox": {"x": 100, "y": 200, "width": 130, "height": 25}
    },
    "date": {
      "value": "2024-03-15",
      "bbox": {"x": 400, "y": 50, "width": 100, "height": 25}
    },
    "total": {
      "value": 18560.00,
      "bbox": {"x": 450, "y": 460, "width": 100, "height": 25}
    }
  },
  "line_items": [
    {
      "description": "Servicio de consultoría",
      "quantity": 10,
      "unit_price": 1500.00,
      "amount": 15000.00,
      "bbox": {"x": 50, "y": 300, "width": 500, "height": 25}
    }
  ],
  "metadata": {
    "version": "1.0",
    "currency": "MXN"
  }
}
```

---

## Using the Module

### Creating Ground Truth

```python
from ground_truth import create_ground_truth

invoice_data = {
    'emisor': {'name': 'Company', 'rfc': 'COMP010101XXX', 'address': 'Addr'},
    'receptor': {'name': 'Client', 'rfc': 'CLNT020202YYY', 'address': 'Addr'},
    'date': '2024-03-15',
    'folio': 'INV-001',
    'items': [
        {'description': 'Service', 'quantity': 10, 'unit_price': 100, 'amount': 1000}
    ],
    'subtotal': 1000.00,
    'iva': 160.00,
    'total': 1160.00,
    'currency': 'MXN'
}

bboxes = {
    'rfc_emisor': {'x': 100, 'y': 150, 'width': 130, 'height': 25},
    'rfc_receptor': {'x': 100, 'y': 200, 'width': 130, 'height': 25},
    'date': {'x': 400, 'y': 50, 'width': 100, 'height': 25},
    'folio': {'x': 300, 'y': 50, 'width': 80, 'height': 25},
    'subtotal': {'x': 450, 'y': 400, 'width': 90, 'height': 25},
    'iva': {'x': 450, 'y': 430, 'width': 80, 'height': 25},
    'total': {'x': 450, 'y': 460, 'width': 100, 'height': 25},
    'items': [{'x': 50, 'y': 300, 'width': 500, 'height': 25}]
}

# Create in-memory structure
ground_truth = create_ground_truth(invoice_data, bboxes)
```

### Saving to File

```python
from ground_truth import save_ground_truth

# Save to JSON file (creates directories automatically)
save_ground_truth(invoice_data, bboxes, 'output/labels/invoice_001.json')
```

### Loading Existing Labels

```python
from ground_truth import load_ground_truth

# Load previously saved ground truth
gt = load_ground_truth('output/labels/invoice_001.json')

# Access fields
rfc = gt['fields']['rfc_emisor']['value']
bbox = gt['fields']['rfc_emisor']['bbox']

# Access line items
for item in gt['line_items']:
    print(f"{item['description']}: ${item['amount']}")
```

---

## Handling Missing BBoxes

OCR may not find all fields. Handle gracefully:

```python
bboxes = {
    'rfc_emisor': {'x': 100, 'y': 150, 'width': 130, 'height': 25},
    'rfc_receptor': None,  # OCR couldn't find this
    'date': None,          # Missing
    'total': {'x': 450, 'y': 460, 'width': 100, 'height': 25},
    'items': []
}

# Still works - value preserved, bbox is null
gt = create_ground_truth(invoice_data, bboxes)
print(gt['fields']['rfc_receptor'])
# {'value': 'CLNT020202YYY', 'bbox': None}
```

---

## Integration with OCR Pipeline

### Full Workflow

```python
from invoice_data import generate_invoice_data
from bbox_utils import find_all_field_bboxes
from ground_truth import save_ground_truth

# 1. Generate invoice data
invoice = generate_invoice_data(seed=42)

# 2. Render to image (from templates)
image = render_invoice(invoice, template_id=1)
image.save('output/invoice_001.png')

# 3. Find bounding boxes via OCR
bboxes = find_all_field_bboxes(image, invoice)

# 4. Save ground truth
save_ground_truth(invoice, bboxes, 'output/invoice_001.json')
```

### Batch Processing

```python
import os

def process_batch(count=100, output_dir='output'):
    os.makedirs(output_dir, exist_ok=True)

    for i in range(count):
        # Generate
        invoice = generate_invoice_data(seed=i)
        image = render_invoice(invoice, template_id=i % 20 + 1)

        # Save image
        image_path = os.path.join(output_dir, f'invoice_{i:04d}.png')
        image.save(image_path)

        # Find bboxes and save ground truth
        bboxes = find_all_field_bboxes(image, invoice)
        json_path = os.path.join(output_dir, f'invoice_{i:04d}.json')
        save_ground_truth(invoice, bboxes, json_path)

        print(f"Processed {i+1}/{count}")
```

---

## Field Types

### Header Fields

| Field | Type | Example |
|-------|------|---------|
| `rfc_emisor` | string | "XAXX010101ABC" |
| `rfc_receptor` | string | "XBBB020202XYZ" |
| `date` | string | "2024-03-15" |
| `folio` | string | "INV-001" |

### Numeric Fields

| Field | Type | Example |
|-------|------|---------|
| `subtotal` | float | 1000.00 |
| `iva` | float | 160.00 |
| `total` | float | 1160.00 |

### Line Items

| Field | Type | Example |
|-------|------|---------|
| `description` | string | "Consulting service" |
| `quantity` | int | 10 |
| `unit_price` | float | 100.00 |
| `amount` | float | 1000.00 |
| `bbox` | dict/null | `{x, y, width, height}` |

---

## Best Practices

### 1. Always Version Your Format

```python
# In metadata
metadata = {
    'version': '1.0',  # Bump when structure changes
    'currency': 'MXN'
}
```

### 2. Preserve Values Even Without BBoxes

```python
# Always include the value, even if bbox is None
'rfc_emisor': {
    'value': invoice_data['emisor']['rfc'],  # Always set
    'bbox': bboxes.get('rfc_emisor')         # May be None
}
```

### 3. Use Consistent Naming

```
invoice_001.png  →  invoice_001.json
invoice_002.png  →  invoice_002.json
```

### 4. Validate After Loading

```python
def validate_ground_truth(gt):
    required_fields = ['rfc_emisor', 'rfc_receptor', 'total']
    for field in required_fields:
        if field not in gt['fields']:
            raise ValueError(f"Missing field: {field}")
```

---

## Common Issues

### Issue: JSON Encoding Errors

```python
# Problem: Non-ASCII characters
"Empresa México S.A."

# Solution: Use ensure_ascii=False
json.dump(data, f, ensure_ascii=False)
```

### Issue: Floating Point Precision

```python
# Problem: 16.00000000001
# Solution: Round before saving if needed
'subtotal': round(invoice_data['subtotal'], 2)
```

### Issue: Missing Parent Directory

```python
# Problem: FileNotFoundError
save_ground_truth(data, bboxes, 'new/nested/path/file.json')

# Solution: Module creates directories automatically
os.makedirs(parent_dir, exist_ok=True)
```

---

## Next Steps

- **Subtask 2.8**: Create full pipeline integrating all modules
- Generate complete dataset with images and labels
- Prepare for ML training pipeline
